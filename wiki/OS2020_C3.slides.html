<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>[C3] å¹¶å‘ Bugs</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="c3-bugs">[C3] å¹¶å‘ Bugs</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>åŒæ­¥ã€äº’æ–¥çš„æ—¶å€™æˆ‘ä»¬å·²ç»è®²äº†å¾ˆå¤š â€œä¸å¯¹â€ çš„æ¡ˆä¾‹</p>
<ul>
<li>å“² â™‚ å­¦å®¶æ­»é”</li>
<li>join åŒæ­¥å¤±è´¥æ­»å¾ªç¯</li>
<li>æ¡ä»¶å˜é‡ signal é”™çº¿ç¨‹</li>
</ul>
<p>ä¸è¦ç¬‘ï¼çŠ¯é”™è¯¯çš„å°±æ˜¯ä½ ä»¬è‡ªå·±ï¼</p>
<ul>
<li>å¹¶å‘ bugs æ€ä¹ˆåŠï¼Ÿ</li>
</ul>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>è°ƒè¯•ç†è®º (fault, error, failure)</li>
<li>å¹¶å‘ bugs: æ­»é” (AA/ABBA), åŸå­æ€§è¿å (ABA), (é¡ºåºè¿å) BA</li>
<li>Lab1 ç”Ÿå­˜æŒ‡å—</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è°ƒè¯•ç†è®ºï¼šå¤ä¹ </h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">åŸºæœ¬åŸåˆ™</h2>
<p>åœ¨ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹å®éªŒä¸­æå‡º</p>
<p>åœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ç¨‹ä¸­ä¾ç„¶æˆç«‹</p>
<ol>
<li><span class="red">æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</span><blockquote>
<p>(ICS) ä¸ç®¡æ˜¯ crash äº†ï¼Œå›¾å½¢æ˜¾ç¤ºä¸æ­£å¸¸äº†ï¼Œè¿˜æ˜¯ <code>HIT BAD TRAP</code> äº†ï¼Œæœ€åéƒ½æ˜¯ä½ è‡ªå·±èƒŒé”…</p>
<p>(OS) ä¸ç®¡æ˜¯å¡æ­»ã€å¼‚å¸¸è¿˜æ˜¯è™šæ‹Ÿæœºé‡å¯ï¼Œéƒ½æ˜¯ä½ è‡ªå·±çš„ bug</p>
</blockquote>
</li>
<li><span class="red">æœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„</span><blockquote>
<p>(ICS/OS) ä½ ä»¥ä¸ºæœ€ä¸å¯èƒ½å‡º bug çš„åœ°æ–¹ï¼Œå¾€å¾€ bug å°±åœ¨é‚£èººç€</p>
</blockquote>
</li>
</ol></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="1">è°ƒè¯•ç†è®º (1)</h2>
<p>ç¨‹åºæ˜¯ â€œè®¡ç®—â€ (éœ€æ±‚/è§„çº¦çš„è®¡ç®—æœºå®ç°) çš„<span class="red">æŠ½è±¡</span></p>
<ul>
<li>CPU å®é™…æ‰§è¡Œ C ç¨‹åº (ç¿»è¯‘æˆçš„æŒ‡ä»¤åºåˆ—)</li>
<li>NEMU æ¨¡æ‹Ÿæ‰§è¡Œ C ç¨‹åº (ç¿»è¯‘æˆçš„æŒ‡ä»¤åºåˆ—)</li>
<li>æ“ä½œç³»ç»Ÿï¼š<ul>
<li><span class="blue">ç®¡ç†å¤šä¸ªå¯„å­˜å™¨ç°åœº/æ‰§è¡Œæµ (C ç¨‹åº) çš„å¹¶å‘æ‰§è¡Œ</span></li>
<li><span class="blue">å®ç°å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨</span> (open, read, mmap, ...)</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ç¨‹åºä¸­çš„ bug æ˜¯ç¨‹åºä¸è®¾è®¡/æ„å›¾è¿åä¹‹å¤„</p>
<ul>
<li>debug å°±æ˜¯å®šä½åˆ°ç¨‹åºä¸­ bug çš„è¿‡ç¨‹</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="debug">ä¸ºä»€ä¹ˆ Debug é‚£ä¹ˆå›°éš¾ï¼Ÿ</h2>
<p>å› ä¸º bug çš„è§¦å‘ç»å†äº†æ¼«é•¿çš„è¿‡ç¨‹</p>
<ul>
<li>Fault (bug) â†’ Error (ç¨‹åºçŠ¶æ€é”™) â†’ Failure (å¯è§‚æµ‹çš„ç»“æœé”™)<ul>
<li>æˆ‘ä»¬åªèƒ½è§‚æµ‹åˆ° failure</li>
<li>æˆ‘ä»¬å¯ä»¥æ£€æŸ¥çŠ¶æ€çš„æ­£ç¡®æ€§ (ä½†éå¸¸è´¹æ—¶)</li>
<li>æ— æ³•é¢„çŸ¥ bug åœ¨å“ªé‡Œ (æ¯ä¸€è¡Œ â€œçœ‹èµ·æ¥â€ éƒ½æŒºå¯¹çš„)</li>
</ul>
</li>
</ul>
<hr></hr>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/fault-error-failure.png" width="800px"></img></p>
<p><span class="center">ç¨‹åº = çŠ¶æ€æœº</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="2">è°ƒè¯•ç†è®º (2)</h2>
<blockquote>
<p>è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª failureï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°<span class="red">ç¬¬ä¸€ä¸ª</span> error çš„çŠ¶æ€ï¼Œæ­¤æ—¶çš„ä»£ç å°±æ˜¯ fault (bug)ã€‚</p>
</blockquote>
<hr></hr>
<p>å®é™…ä¸­çš„è°ƒè¯•</p>
<blockquote>
<p>çŠ¶æ€æœºçš„æ‰§è¡Œå¯èƒ½å¾ˆé•¿ï¼Œä½†æˆ‘ä»¬åªè¦æ ‡è®°å‡ºä¸€äº›<span class="red">å…³é”®çš„çŠ¶æ€</span>ï¼Œå°±èƒ½å¸®æˆ‘ä»¬ç¼©å°æ’æŸ¥é—®é¢˜çš„èŒƒå›´</p>
</blockquote>
<ul>
<li>é€šè¿‡<span class="red">è§‚å¯Ÿç¨‹åºæ‰§è¡Œçš„è½¨è¿¹</span> (trace)</li>
<li>ç¼©å°é”™è¯¯çŠ¶æ€ (error) å¯èƒ½äº§ç”Ÿçš„ä½ç½®</li>
<li>ä»è€Œå®šä½åˆ° bugs<ul>
<li>printf â†’ è‡ªå®šä¹‰ log çš„ trace</li>
<li>gdb â†’ æŒ‡ä»¤/è¯­å¥çº§ trace</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">è°ƒè¯•ç†è®ºç»™æˆ‘ä»¬çš„å¯ç¤º</h2>
<p>æ‰¾åˆ° bug çš„ä¸¤ä¸ªå…³é”®é“¾æ¡</p>
<ul>
<li>Fault (bug) â†’ Error (ç¨‹åºçŠ¶æ€é”™)<ul>
<li><span class="red">æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æµ‹è¯•</span>ï¼<ul>
<li>æ„é€ å¤æ‚çš„ workloads</li>
</ul>
</li>
</ul>
</li>
<li>Error (ç¨‹åºçŠ¶æ€é”™) â†’ Failure (å¯è§‚æµ‹çš„ç»“æœé”™)<ul>
<li><span class="red">æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ£€æŸ¥</span>ï¼<ul>
<li>å¯ä»¥éšæ—¶å¼€å…³çš„å„ç±»æ—¥å¿—ä¿¡æ¯</li>
<li>å„ç§é˜²å¾¡æ€§çš„ assertions</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¦åˆ©ï¼šå¦‚ä½•è°ƒè¯•è™šæ‹Ÿæœºé‡å¯ï¼Ÿ</h2>
<p>è°ƒè¯•ç†è®ºå‘Šè¯‰æˆ‘ä»¬ï¼šfailure point å¾ˆé‡è¦</p>
<ul>
<li>å¯ä»¥è¿½æº¯å‡ºä¸€äº› error states</li>
<li>QEMU è®¾è®¡è€…å½“ç„¶çŸ¥é“è¿™ä¸€ç‚¹<ul>
<li><span class="red">å¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰ä»€ä¹ˆï¼Œé‚£ä¸€å®šä¼šæœ‰çš„ï¼</span></li>
</ul>
</li>
</ul>
<hr></hr>
<p>RTFM: QEMU Monitor</p>
<ul>
<li>å¾—åˆ°è¯¦å°½çš„æ—¥å¿—: <code>log int,cpu_reset,exec</code><ul>
<li>fault â†’ error â†’ failure<ul>
<li><code>int,cpu_reset</code> - å¸®åŠ©æˆ‘ä»¬å®šä½ failure</li>
<li><code>exec</code> - å¸®åŠ©æˆ‘ä»¬å®šä½ error (æ‰§è¡Œæµ)<ul>
<li>ç”šè‡³å¯ä»¥å¼€å‘ä¸€ä¸ªå°å·¥å…·ï¼Œâ€œç»˜åˆ¶â€ å‡ºç¨‹åºæ‰§è¡Œçš„è·¯å¾„</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å å…¥å¹¶å‘çš„æ·±æ¸Šâ€¦â€¦</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="bug">å¹¶å‘ Bug çš„è°ƒè¯•ç†è®º</h2>
<blockquote>
<p>åœ¨æ— æ³• â€œå‡†ç¡®å¤ç°ä¸€æ¬¡æ‰§è¡Œâ€ çš„åŸºç¡€ä¸Šï¼Œâ€œæ‰¾åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€â€ å˜éš¾äº†â€¦â€¦</p>
</blockquote>
<p>è°ƒè¯•ç†è®ºå½“ç„¶æˆç«‹ï¼Œåªè¦<span class="red">å¹¶å‘ç¨‹åºä¸æ˜¯ä¸ç¡®å®šçš„</span></p>
<ul>
<li>å¹¶å‘ bug æ¯æ¬¡è§¦å‘æ–¹å¼éƒ½ä¸å¤ªä¸€æ ·</li>
<li>è·¨çº¿ç¨‹çš„æ•°æ®æµ â€¦â€¦</li>
</ul>
<hr></hr>
<p>Fault â†’ error</p>
<ul>
<li>æ¯æ¬¡çš„ error éƒ½ä¸ä¸€æ ·</li>
<li>éš¾ä»¥ç¡®å®šè°ƒè¯• â€œåœ¨ä»€ä¹ˆæ—¶å€™åœä¸‹æ¥â€</li>
</ul>
<p>Error â†’ failure</p>
<ul>
<li>æ—¥å¿—ä»ç„¶èƒ½å¸®åŠ©æˆ‘ä»¬ç¼©å° error å‘ç”Ÿçš„èŒƒå›´</li>
<li>ä½† failure æ›´éš¾ç†è§£ (é”™è¯¯çš„è¾“å‡º/ç¥ç§˜å¼‚å¸¸/ç¥ç§˜é‡å¯/...)</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="bugs">å¹¶å‘ Bugs åˆ°åº•é•¿ä»€ä¹ˆæ ·ï¼Ÿ</h2>
<p>ä¸€ç§ç ”ç©¶æµæ´¾ï¼šå®è¯ç ”ç©¶ (empirical study)</p>
<ul>
<li>ä¸ºäº†æ›´å¥½åœ°è§£å†³å¹¶å‘ bugs çš„é—®é¢˜<ul>
<li>ä»ç°å®æ•°æ®é›†ä¸­ (éšæœº) é€‰å–ä¸€å®šæ¯”ä¾‹çš„ä¾‹å­</li>
<li>å¯¹ç»“è®ºè¿›è¡Œå½’çº³æ€»ç»“</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ¨èé˜…è¯»ï¼š</p>
<ul>
<li>S. Lu, et al. <a href="https://dl.acm.org/doi/10.1145/1353535.1346323">Learning from mistakes â€” A comprehensive study on real world concurrency bug characteristics</a>. In <em>Proc. of ASPLOS</em>, 2008.<ul>
<li>æ­ç¤ºäº†é‚£äº›é€ƒè¿‡äº†æµ‹è¯•ã€æµå‘äº†ç”¨æˆ·ã€æœ€ç»ˆè¢«ä¿®å¤çš„ bugs çš„ç‰¹æ€§</li>
</ul>
</li>
<li>Z. Yin, et al. <a href="https://dl.acm.org/doi/10.1145/2025113.2025121">How do fixes become bugs? A comprehensive characteristic study on incorrect fixes in commercial and
open source operating systems</a>. In <em>Proc. of ESEC/FSE</em>, 2011.</li>
</ul>
</blockquote></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="deadlock">æ­»é” (Deadlock)</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="deadlock">æ­»é” (Deadlock)</h2>
<blockquote>
<p>A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action, such as sending a message or more commonly releasing a lock.</p>
</blockquote>
<p>å‡ºç°çº¿ç¨‹ â€œäº’ç›¸ç­‰å¾…â€ çš„æƒ…å†µ (è·¯å£ç©ºé—´ = èµ„æº)</p>
<p><span class="center"><img src="../static/wiki/os/2019/img/deadlock-car.jpg" width="500px/"></img></span>
<blockquote>
<p>Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul>
<li>MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
</ul>
</blockquote></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="aa-deadlock">AA-Deadlock</h2>
<p>å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p>
<ul>
<li>é”™è¯¯å®ç°çš„ popcli</li>
<li>ä¸åº”è¯¥å‘ç”Ÿçš„ <code>_yield()</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">os_run</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span>
  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">xxx</span><span class="p">);</span> <span class="c1">// ---------+</span>
<span class="p">}</span>                          <span class="c1">//    |</span>
                           <span class="c1">//    |</span>
<span class="kt">void</span> <span class="nf">on_interrupt</span><span class="p">()</span> <span class="p">{</span>      <span class="c1">//    |</span>
  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>   <span class="c1">// &lt;--+</span>
  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="abba-deadlock">ABBA-Deadlock</h2>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">obj_move</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">spin_lock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
  <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
  <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
<div class="fragment">
<p>ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>
<ul>
<li><code>obj_move</code> æœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜<ul>
<li>é—®é¢˜æ˜¯å®ƒæœ‰ä¸€ä¸ªéšå«çš„ lock ordering çš„ requirement</li>
<li><code>obj_move(1, 2)</code>; <code>obj_move(2, 1)</code> â†’ æ­»é”</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">é¿å…æ­»é”</h2>
<p>æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ (<a href="https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr.">Edward G. Coffman</a>, 1971):</p>
<ul>
<li>äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</li>
<li>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æº</li>
<li>ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤º</li>
<li>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»</li>
</ul>
<hr></hr>
<blockquote>
<p>â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æºã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€</p>
</blockquote>
<div class="fragment">
<blockquote>
<p><span class="red">Bullshit</span>.</p>
<ul>
<li>ç ´åæ¯ä¸€ä¸ªæ¡ä»¶éƒ½æ˜¯ highly non-trivial çš„ (è¯·é˜…è¯»æ•™ç§‘ä¹¦)</li>
</ul>
</blockquote>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="contd">é¿å…æ­»é” (cont'd)</h2>
<p>AA-Deadlock</p>
<ul>
<li>AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</li>
<li><a href="../static/wiki/os/2020/demos/spinlock-xv6.c">spinlock.c</a><ul>
<li><code>if (holding(lk)) panic();</code></li>
</ul>
</li>
</ul>
<hr></hr>
<p>ABBA-Deadlock</p>
<ul>
<li>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</li>
<li>ä¸¥æ ¼æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é” (lock ordering)<ul>
<li>ç ´åäº† â€œå¾ªç¯ç­‰å¾…â€</li>
<li>è¯•ä¸€è¯•ï¼šç”¨çŠ¶æ€æœºè¯æ˜ <math class="inline-math">T_1: A\to B\to C; T_2: B \to C</math> æ˜¯å®‰å…¨çš„<ul>
<li>â€œåœ¨ä»»æ„æ—¶åˆ»æ€»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹ (è·å¾— â€œæœ€é åâ€ é”çš„) å¯ä»¥ç»§ç»­æ‰§è¡Œâ€</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lock-ordering">Lock Ordering: åº”ç”¨</h2>
<p>æŒ‰ç…§æ­£ç¡®çš„é¡ºåºä¸Šé”å¾ˆé‡è¦â€¦â€¦</p>
<div class="codehilite"><pre><span></span><span class="cm">/* Lock ordering in mm:</span>
<span class="cm"> * inode-&gt;i_mutex (while writing or truncating, not reading or faulting)</span>
<span class="cm"> *  mm-&gt;mmap_sem</span>
<span class="cm"> *   page-&gt;flags PG_locked (lock_page)</span>
<span class="cm"> *    hugetlbfs_i_mmap_rwsem_key (in huge_pmd_share)</span>
<span class="cm"> *     mapping-&gt;i_mmap_rwsem</span>
<span class="cm"> *      anon_vma-&gt;rwsem</span>
<span class="cm"> *       mm-&gt;page_table_lock or pte_lock</span>
<span class="cm"> *        pgdat-&gt;lru_lock (in mark_page_accessed, isolate_lru_page)</span>
<span class="cm"> *        swap_lock (in swap_duplicate, swap_info_get)</span>
<span class="cm"> *         mmlist_lock (in mmput, drain_mmlist and others)</span>
<span class="cm"> *         mapping-&gt;private_lock (in __set_page_dirty_buffers)</span>
<span class="cm"> *          mem_cgroup_{begin,end}_page_stat (memcg-&gt;move_lock)</span>
<span class="cm"> *           i_pages lock (widely used)</span>
<span class="cm"> *         inode-&gt;i_lock (in set_page_dirty's __mark_inode_dirty)</span>
<span class="cm"> *         bdi.wb-&gt;list_lock (in set_page_dirty's __mark_inode_dirty)</span>
<span class="cm"> *          sb_lock (within inode_lock in fs/fs-writeback.c)</span>
<span class="cm"> *          i_pages lock (widely used, in set_page_dirty,</span>
<span class="cm"> *               in arch-dependent flush_dcache_mmap_lock,</span>
<span class="cm"> *               within bdi.wb-&gt;list_lock in __sync_single_inode)</span>
<span class="cm"> */</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä½ å¤§çº¦å¯Ÿè§‰äº†â€¦â€¦</h2>
<blockquote>
<p>Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. Practice will tell you that this approach doesn't scale: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p>The best locks are encapsulated: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.</p>
<p>â€”â€” <em>Unreliable Guide To Locking</em> by Rusty Russell</p>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">è®©ç¨‹åºå‘˜å½»åº•é¿å…æ­»é”ï¼Ÿä½ æƒ³å¤šäº†â€¦â€¦</h2>
<p>è°ƒè¯•å…¬ç†ï¼šæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„</p>
<ul>
<li>å¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Šâ€¦â€¦</li>
</ul>
<hr></hr>
<p><a href="OS_lockdep.html">lockdep</a>: Kernel lock validator (since 2.6.17)</p>
<ul>
<li>ä¸ºæ¯ä¸€ä¸ª â€œlock classâ€ æ£€æŸ¥ (åˆ†é…ä¸€ä¸ª key)<ul>
<li>æ¯ä¸ªé™æ€é”éƒ½æ˜¯ä¸€ä¸ª classï¼škey = åœ°å€</li>
<li>åŠ¨æ€åˆ†é…çš„é”ï¼Œç›¸åŒ initialization site æ˜¯åŒä¸€ä¸ª class</li>
</ul>
</li>
<li>åœ¨è¿è¡Œæ—¶è§‚å¯Ÿæ‰€æœ‰çš„ lock/unlock<ul>
<li>lock/unlock æ—¶è®°å½•æ‰€æœ‰å¯èƒ½çš„ä¸Šé”é¡ºåº<ul>
<li>çº¿ç¨‹å…ˆåè·å¾— <math class="inline-math">X, Y, Z</math> ä¼šè®°å½• <math class="inline-math">X \to Y, X \to Z, Y \to Z</math></li>
</ul>
</li>
<li>æ£€æŸ¥<ul>
<li>æ˜¯å¦å­˜åœ¨ <math class="inline-math">A \to B</math> å’Œ <math class="inline-math">B \to A</math> (deadlock)</li>
<li>å³ä¾¿æ­»é”æ²¡æœ‰çœŸæ­£å‘ç”Ÿï¼Œä½†åªè¦æœ‰ ABBA çš„é£é™©å°±ä¼šæŠ¥å‘Š<ul>
<li>predictive analysis</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ­»é”ï¼šé”å¹¶ä¸æ˜¯å”¯ä¸€çš„åŸå› </h2>
<p>åœ¨æ¶‰åŠåŒæ­¥çš„æ—¶å€™ï¼Œæƒ…å†µå°±å¤æ‚å¾—å¤šäº†â€¦â€¦</p>
<ul>
<li>è€æ€»æ‰“ç”µè¯ç»™ç§˜ä¹¦ï¼šâ€œè¿™å‡ å¤©æˆ‘é™ªä½ å»åŒ—äº¬ç©ç©ï¼Œä½ å‡†å¤‡ä¸€ä¸‹â€</li>
<li>ç§˜ä¹¦æ‰“ç”µè¯ç»™è€å…¬ï¼šâ€œè¿™å‡ å¤©æˆ‘è¦å’Œè€æ€»å»åŒ—äº¬å¼€ä¼šâ€</li>
<li>è€å…¬æ‰“ç”µè¯ç»™æƒ…äººï¼šâ€œè¿™å‡ å¤©æˆ‘è€å©†ä¸åœ¨å®¶ï¼Œé™ªæˆ‘â€</li>
<li>æƒ…äººæ‰“ç”µè¯ç»™è¾…å¯¼å­¦ç”Ÿï¼šâ€œè¿™å‡ å¤©è€å¸ˆæœ‰äº‹ï¼Œåœè¯¾â€</li>
<li>å­¦ç”Ÿæ‰“ç”µè¯ç»™çˆ·çˆ·ï¼šâ€œè¿™å‡ å¤©ä¸ä¸Šè¯¾ï¼Œçˆ·çˆ·ä½ é™ªæˆ‘ç©â€</li>
<li>çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šâ€œåŒ—äº¬å»ä¸äº†äº†ï¼Œå­™å­è¦æˆ‘é™ªâ€</li>
<li>ç§˜ä¹¦ç»™è€å…¬æ‰“ç”µè¯ï¼šâ€œè€æ€»çªç„¶æœ‰äº‹ä¸å»åŒ—äº¬å¼€ä¼šäº†â€</li>
<li>è€å…¬ç»™æƒ…äººæ‰“ç”µè¯ï¼šâ€œè€å©†ä¸èµ°äº†ï¼Œä¸‹æ¬¡å†è¯´â€</li>
<li>æƒ…äººç»™è¾…å¯¼å­¦ç”Ÿæ‰“ç”µè¯ï¼šâ€œè¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€</li>
<li>å­¦ç”Ÿç»™çˆ·çˆ·æ‰“ç”µè¯ï¼šâ€œ555 è€å¸ˆè¯´è¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€</li>
<li>çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šè¿˜æ˜¯å»åŒ—äº¬å§ï¼Œä½ å‡†å¤‡å‡†å¤‡</li>
</ul>
<p><span class="center"><span class="red">ä¸è¦ç¬‘ï¼Œä½ ä»¬çš„ L2 å¾ˆæœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µ</span></span></p></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="bug">å¹¶å‘ Bugï¼šä¸ä»…æ˜¯æ­»é”</h1>
<p><br></br>
<p>ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿ</p></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™</h2>
<p>å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·</p>
<ul>
<li>äº’æ–¥é” (lock/unlock) - åŸå­æ€§</li>
<li>æ¡ä»¶å˜é‡ (wait/signal) - åŒæ­¥</li>
</ul>
<hr></hr>
<p>å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</p>
<p>å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</p>
<hr></hr>
<blockquote>
<p>Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul>
<li>MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
<li><span class="red">97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯ AV æˆ– OV</span>ã€‚</li>
</ul>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="av">åŸå­æ€§è¿å (AV)</h2>
<p>â€œABAâ€</p>
<ul>
<li>æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li>
</ul>
<p><span class="center"><img src="../static/wiki/os/2019/img/av-bug.png" width="700px/"></img></span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="contd">åŸå­æ€§è¿å (cont'd)</h2>
<p>æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜</p>
<ul>
<li>â€œTOCTTOUâ€ - time of check to time of use</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/tocttou.png" width="640px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="ov">é¡ºåºè¿å (OV)</h2>
<p>â€œBAâ€</p>
<ul>
<li>æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ<ul>
<li>ä¾‹å­ï¼šconcurrent use after free  </li>
</ul>
</li>
</ul>
<p><span class="center"><img src="../static/wiki/os/2019/img/ov-bug.png" width="700px/"></img></span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="empirical-study">Empirical Study: åˆ°åº•å‘ç°äº†ä»€ä¹ˆï¼Ÿ</h2>
<blockquote>
<p>ç¨‹åºå‘˜ï¼šæˆ‘æœ¬åœ°éƒ½è·‘äº†å‡ ä¸‡æ¬¡äº†ï¼Œæ²¡é—®é¢˜å•Š</p>
<ul>
<li>ä¸€éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒé‡Œå°± ğŸ’¥ çˆ†ç‚¸äº†</li>
</ul>
<p>æˆ‘ï¼šåœ¨æœ¬åœ°æµ‹çš„å¥½å¥½çš„å•Š</p>
<ul>
<li>æäº¤åˆ° Online Judge ä¸Šè¿ easy tests éƒ½è¿‡ä¸äº† (çœŸå®)</li>
</ul>
</blockquote>
<p>Empirical study ç»™äº†æˆ‘ä»¬æ›´å¤šæœ‰è¶£çš„å‘ç°ï¼ŒæŒ‡å¯¼ bug çš„å‘ç°/ä¿®å¤ï¼š</p>
<ul>
<li>Almost all (96%) of the examined concurrency bugs are guaranteed to manifest if certain partial order between <em>2 threads</em> is enforced. </li>
<li>Many (66%) of the examined non-deadlock concurrency bugsâ€™ manifestation involves concurrent accesses to <em>only one variable</em>. </li>
<li>Almost all (97%) of the examined deadlock bugs involve <em>two threads</em> circularly waiting for at most two resources. </li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="lab-1-pmm">Lab 1 (PMM) ç”Ÿå­˜æŒ‡å—</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="online-judge">Online Judge ä½“éªŒæå·®</h2>
<blockquote>
<p>Lab 1 æœ‰ä¸€å®šéš¾åº¦</p>
<ul>
<li>æœ‰ä¸€ç‚¹è½»å¾®çš„å¹¶å‘ bug â†’ Wrong Answer</li>
<li>ç”¨ä¸€æŠŠå¤§é”å§ï¼Œæ€§èƒ½è¾¾ä¸åˆ° 1Mop/s çš„è¦æ±‚ (å¤§éƒ¨åˆ†åˆ†æ•°åˆ°æ‰‹)<ul>
<li>ç›®å‰ Accept çš„åŒå­¦ï¼Œå¹³å‡æäº¤æ¬¡æ•°è¾¾åˆ°äº†æƒŠäººçš„ 33.5 æ¬¡</li>
<li>(è¿˜æ˜¯å­¦ä¹ è‡ªè§‰æ€§å’ŒåŸºç¡€éƒ½æ¯”è¾ƒå¥½çš„åŒå­¦)</li>
</ul>
</li>
</ul>
</blockquote>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/L1-result.png" width="640px"></img></p>
<p><span class="center">è®©è°ƒè¯•ç†è®ºæ¥å¸®å¸®æˆ‘ä»¬å§ï¼</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="fault-error">Fault â†’ Error: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼</h2>
<blockquote>
<p>æƒ³ç³Šå¼„ï¼Ÿç³Šå¼„ä¸è¿‡å»çš„ã€‚</p>
</blockquote>
<p>æ¥æ„é€  kalloc çš„ workload å§ï¼</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">os_run</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pmm</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">random_size</span><span class="p">());</span>
    <span class="c1">// Insufficient: pmm-&gt;alloc(32);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="workload-kalloc">åˆ›å»ºåˆç†çš„ Workload: <code>kalloc</code></h2>
<p>Online Judge ä¸Šçš„ workload:</p>
<ul>
<li>ä¸ºæ¯ä¸€ç§åˆ†é…å¤§å° <math class="inline-math">(2^{i-1} + 1) \ldots 2^{i}</math> è®¾ç½®æ¦‚ç‡</li>
<li>é¢‘ç¹çš„å°å†…å­˜åˆ†é…ã€é¢‘ç¹çš„å¤§å†…å­˜åˆ†é… (4 KiB)ã€æ··åˆçš„å†…å­˜åˆ†é…â€¦â€¦</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">workload</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">prob</span><span class="p">[</span><span class="n">N</span><span class="p">],</span> <span class="n">sum</span><span class="p">;</span> <span class="c1">// sum = prob[0] + prob[1] + ... prob[N-1]</span>
                    <span class="c1">// roll(0, sum-1) =&gt; allocation size</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workload</span>
  <span class="n">wl_typical</span> <span class="o">=</span> <span class="p">{.</span><span class="n">prob</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
  <span class="n">wl_stress</span>  <span class="o">=</span> <span class="p">{.</span><span class="n">prob</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
  <span class="n">wl_page</span>    <span class="o">=</span> <span class="p">{.</span><span class="n">prob</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span> <span class="p">}</span>
<span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workload</span> <span class="o">*</span><span class="n">workload</span> <span class="o">=</span> <span class="o">&</span><span class="n">wl_typical</span><span class="p">;</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="workload-kfree">åˆ›å»ºåˆç†çš„ Workload: <code>kfree</code></h2>
<blockquote>
<p>å¹¶å‘çš„ alloc-free æ˜¯å¾ˆå¤šé—®é¢˜çš„æ¥æºã€‚</p>
<p>ä½†åŒå­¦ä»¬ä¸€å®šæ˜¯æ‡’å¾—å»æµ‹è¯•çš„ã€‚<span class="float-right">â€”â€” jyy</span></p>
</blockquote>
<p>Online Judge: ä¼šæŠŠåˆ†é…çš„ç»“æœä¿å­˜åˆ°ä¸€ä¸ªå¹¶å‘æ•°æ®ç»“æ„ä¸­</p>
<ul>
<li>ç”¨ C11 <a href="https://en.cppreference.com/w/c/atomic"><code>stdatomic.h</code></a> å®ç°<ul>
<li>ä¿è¯åˆæ³•çš„ kalloc/kfree åºåˆ— (æ²¡æœ‰ double-free æˆ– use-after-free)</li>
<li>ä½†ä¸€ä¸ª CPU çš„ç”³è¯·çš„å†…å­˜å¯ä»¥åœ¨å¦ä¸€ä¸ª CPU free (RTFM)</li>
</ul>
</li>
</ul>
<div class="fragment">
<hr></hr>
<p>æƒ³ç®€å•ä¸€ç‚¹ï¼Ÿ</p>
<ul>
<li>åœ¨ CPU æœ¬åœ°ç¼“å­˜æœ¬ CPU çš„ allocation log (è‡ªæ—‹é”ä¿æŠ¤)</li>
<li>éš”ä¸€æ®µæ—¶é—´è¿›è¡Œ free<ul>
<li>è·å–è‡ªæ—‹é” â€œå·å–â€ å…¶ä»–çº¿ç¨‹çš„æ—¥å¿—</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="workload">æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼šä¸ä»…æ˜¯ Workload</h2>
<blockquote>
<p>åŸºæœ¬æƒ³æ³•: workload + åœ¨é€‚å½“çš„æ—¶å€™æ’å…¥ <code>delay()</code></p>
<ul>
<li>è¿™æ‰æ˜¯ Online Judge æµ‹è¯•çš„ç²¾é«“<ul>
<li>allocation-biased/free-biased/mixed</li>
</ul>
</li>
</ul>
</blockquote>
<p>ABBA (deadlock), ABA (AV), BA (OV) éƒ½å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è§¦å‘</p>
<ul>
<li>å¦‚ä½•èªæ˜åœ°æ’å…¥ delayï¼Ÿ<ul>
<li>æ˜¯ä¸ªæŠ€æœ¯æ´»<ul>
<li>K. Sen. <a href="https://dl.acm.org/doi/10.1145/1375581.1375584">Race directed random testing of concurrent programs</a>. In <em>Proc. of PLDI</em>, 2008.</li>
<li>D. Chen, et al. <a href="https://dl.acm.org/doi/10.1145/3236024.3236077">Testing multithreaded programs via thread speed control</a>. In <em>Proc. of ESEC/FSE, 2018</em>.</li>
<li>G. Li, et al. <a href="https://dl.acm.org/doi/10.1145/3341301.3359638">Efficient scalable thread-safety-violation detection: Finding thousands of concurrency bugs during testing</a>. In <em>Proc. SOSP</em>, 2019.</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="error-failure">Error â†’ Failure: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ£€æŸ¥ï¼</h2>
<blockquote>
<p>å¾ˆå¤šç¨‹åºåº”è¯¥æ»¡è¶³çš„ specification å¹¶æ²¡æœ‰è¢«æ£€æŸ¥</p>
<ul>
<li>C/C++ ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œå°±è®© undefined behavior å‘ç”Ÿ<ul>
<li>å¹¶ä¸æ€»æ˜¯æ˜¾ç° â€œæ˜¾è‘—â€ çš„åæœ</li>
<li>ç»™ä½ ä¸€ç§ç¨‹åºå¥½åƒæ²¡é—®é¢˜çš„é”™è§‰</li>
</ul>
</li>
</ul>
</blockquote>
<p>åœ¨ç¨‹åºä¸­è®¾è®¡å„ç§æ£€æŸ¥ (å°±åƒ <a href="../static/wiki/os/2020/demos/spinlock-xv6.c">spinlock.c</a> é‚£æ ·)</p>
<ul>
<li>double acquire, dangling release, æŒæœ‰é”æ—¶å¼€ä¸­æ–­, ä¸é…å¯¹çš„ unlock</li>
</ul>
<hr></hr>
<p>å°æŠ€å·§</p>
<ul>
<li>ç»Ÿè®¡ cpu çš„ spin count<ul>
<li>å¦‚æœè¶…è¿‡æŸä¸ªæ˜æ˜¾ä¸æ­£å¸¸çš„æ•°å€¼å°±æŠ¥å‘Š</li>
<li><code>getcallerpcs()</code> è®°å½•çš„ PC å°±æœ‰ä»·å€¼äº†<ul>
<li>ä¸€ç§’è¯Šæ–­æ­»é”</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="double-allocation">æ›´å¤šçš„æ£€æŸ¥: Double-Allocation</h2>
<p>å†…å­˜åˆ†é…è¦æ±‚ï¼šå‡è®¾å·²åˆ†é…çš„é›†åˆ <math>S = [l_0, r_0) \cup [l_1, r_1) \cup \ldots \cup [l_n, r_n)</math></p>
<ul>
<li>kalloc(<math>s</math>) è¿”å›çš„ <math>[l, r)</math> æ»¡è¶³ <math>[l, r) \cap S = \varnothing</math></li>
<li>å¦‚æœå®ç°äº† thread-local allocation + å¹¶å‘çš„ freeï¼Œå…¶å®å¾ˆå®¹æ˜“å¼„é”™</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">wl_kalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="n">kalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">panic_on</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="s">"double-allocation"</span><span class="p">);</span>
      <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl_kfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Compile Error</span>
    <span class="n">panic_on</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"double-free"</span><span class="p">);</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="buffer-overrun">æ›´å¤šçš„æ£€æŸ¥: Buffer Overrun</h2>
<p>Canary (é‡‘ä¸é›€) å¯¹ä¸€æ°§åŒ–ç¢³éå¸¸æ•æ„Ÿ</p>
<ul>
<li>ç”¨ç”Ÿå‘½é¢„è­¦çŸ¿äº•ä¸‹çš„ç“¦æ–¯æ³„éœ² (since 1911)</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/canary_with_miner.jpg" width="400px"></img></p>
<p>Canary</p>
<ul>
<li>â€œç‰ºç‰²â€ ä¸€äº›å†…å­˜å•å…ƒï¼Œæ¥é¢„è­¦ memory bug çš„å‘ç”Ÿ<ul>
<li>(ç¨‹åºè¿è¡Œæ—¶æ²¡æœ‰åŠ¨ç‰©å—åˆ°å®è´¨çš„ä¼¤å®³)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="canary">Canary çš„ä¾‹å­ï¼šä¿æŠ¤å†…æ ¸æ ˆ</h2>
<div class="codehilite"><pre><span></span><span class="cp">#define MAGIC 0x5a5aa5a5</span>
<span class="k">typedef</span> <span class="n">u32</span> <span class="n">canary_t</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">kernel_stack</span> <span class="p">{</span>
  <span class="n">canary_t</span> <span class="n">__c1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">4096</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">canary_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
  <span class="n">canary_t</span> <span class="n">__c2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="kt">void</span> <span class="nf">canary_init</span><span class="p">(</span><span class="n">canary_t</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">canary_check</span><span class="p">(</span><span class="n">canary_t</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">panic_on</span><span class="p">((</span><span class="o">*</span><span class="n">c</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MAGIC</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kstack_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">kernel_stack</span> <span class="o">*</span><span class="n">stk</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">canary_check</span><span class="p">(</span><span class="o">&</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">__c1</span><span class="p">,</span> <span class="s">"kernel stack overflow"</span><span class="p">);</span>
  <span class="n">canary_check</span><span class="p">(</span><span class="o">&</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">__c2</span><span class="p">,</span> <span class="s">"kernel stack underflow"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kstack_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kernel_stack</span> <span class="o">*</span><span class="n">stk</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">canary_init</span><span class="p">(</span><span class="o">&</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">__c1</span><span class="p">);</span>
  <span class="n">canary_init</span><span class="p">(</span><span class="o">&</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">__c2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">çƒ«çƒ«çƒ«å’Œå±¯å±¯å±¯</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/GET.jpg" width="220px"></img></p>
<p>msvc ä¸­ debug mode çš„ guard/fence/canary (<code>MAGIC</code>)</p>
<ul>
<li>æœªåˆå§‹åŒ–æ ˆ: <code>0xcccccccc</code></li>
<li>æœªåˆå§‹åŒ–å †: <code>0xcdcdcdcd</code></li>
<li>å¯¹è±¡å¤´å°¾: <code>0xfdfdfdfd</code></li>
<li>å·²å›æ”¶å†…å­˜: <code>0xdddddddd</code></li>
</ul>
<div class="codehilite"><pre><span></span>python3
&gt;&gt;&gt; (b'\xcc' * 80).decode('gb2312')
'çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«'
&gt;&gt;&gt; (b'\xcd' * 80).decode('gb2312')
'å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯å±¯'
</pre></div>


<blockquote>
<p>æ‰‹æŒä¸¤æŠŠé”Ÿæ–¤æ‹·ï¼Œå£ä¸­ç–¾å‘¼çƒ«çƒ«çƒ«</p>
<p>è„šè¸åƒæœµå±¯å±¯å±¯ï¼Œç¬‘çœ‹ä¸‡ç‰©é”˜é”˜é”˜</p>
<p>â€”â€”ä¸è¦ç¬‘å•¦ï¼Œå®ƒä»¬åœ¨æ— å½¢ä¸­ä¿æŠ¤ä½ ï¼</p>
<p>(ä»¿ä½›è¿™äº›æ›¾ç»å¯æ€•çš„å½¢è±¡é«˜å¤§äº†è®¸å¤š)</p>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="sanitizers">æ›´å¤šçš„æ£€æŸ¥: Sanitizers</h2>
<blockquote>
<p>â€œåŠ¨æ€ç¨‹åºåˆ†æâ€</p>
<ul>
<li>åœ¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œè§‚æµ‹å’Œæ£€æŸ¥</li>
<li>é€‚å½“çš„æ—¶å€™å¯¹ç¨‹åºè¡Œä¸ºè¿›è¡Œè°ƒæ§</li>
</ul>
</blockquote>
<p>å¸¸è§çš„åŠ¨æ€åˆ†æï¼šæ£€æŸ¥æŸäº› specification æ˜¯å¦è¢«è¿å</p>
<p><span class="float-right"><img src="../static/wiki/os/2019/img/observe.jpg" width="150px/"></img></span>
<ul>
<li>å¯ä»¥æŠŠåŠ¨æ€åˆ†æç†è§£æˆä¸¤ä¸ªéƒ¨åˆ†<ul>
<li>ä¸€ä¸ªéƒ¨åˆ†ä¸æ–­åœ°åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰“å°æ—¥å¿— <ul>
<li>lock, unlock, memory access, ...</li>
</ul>
</li>
<li>å¦ä¸€ä¸ªéƒ¨åˆ†è§£ææ—¥å¿—ï¼ŒæŸ¥çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜<ul>
<li>lockdep: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ABBA</li>
</ul>
</li>
</ul>
</li>
<li>ä»˜å‡ºç¨‹åºå˜æ…¢çš„ä»£ä»·<ul>
<li>ä½†æ˜¯éå¸¸å€¼å¾— â† <span class="red">jyy çš„ä¸»è¦ç ”ç©¶æ–¹å‘ï¼Œå¿«æ¥å–è‡ªå·± (è¯¯</span></li>
</ul>
</li>
</ul></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="sanitizers-contd">æ›´å¤šçš„æ£€æŸ¥: Sanitizers (cont'd)</h2>
<blockquote>
<p>å‰æ‰€æœªæœ‰çš„å®è—ï¼ï¼ï¼</p>
<ul>
<li>å¦‚æœä½ ä¸çŸ¥é“ã€æ²¡ç”¨è¿‡ lint å’Œ sanitizersï¼Œæ ¹æœ¬ä¸èƒ½ç®—ä¼šç¼–ç¨‹ã€‚</li>
</ul>
</blockquote>
<ul>
<li><a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a> (asan)<ul>
<li>æ£€æŸ¥å„ç§éæ³•åœ°å€è®¿é—®: buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, memory leak (lsan)</li>
<li>demo: <a href="../static/wiki/os/2020/demos/uaf.c">uaf.c</a>; <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html">kasan ç°å·²åŠ å…¥ Linux å†…æ ¸</a></li>
</ul>
</li>
<li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a> (msan)<ul>
<li>æ£€æŸ¥æœªåˆå§‹åŒ–çš„è¯»å–</li>
</ul>
</li>
<li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">ThreadSanitizer</a> (tsan)<ul>
<li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•°æ®ç«äº‰ (data race)</li>
</ul>
</li>
<li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UBSanitizer</a> (ubsan)<ul>
<li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨å„ç§çœ‹èµ·æ¥æ²¡é—®é¢˜çš„ undefined behavior: misaligned pointer, signed integer overflow, ...</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>ä¸‰ç§ â€œé”™è¯¯â€ï¼šfault, error, and failure</p>
<ul>
<li>Fault â†’ Error: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼<ul>
<li>æ„é€ æ›´å¼ºçš„ workloads</li>
</ul>
</li>
<li>Error â†’ Failure: æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ£€æŸ¥ï¼<ul>
<li>assertions, sanitizers, ...</li>
</ul>
</li>
</ul>
<p>ä¸‰ç§å¹¶å‘ bugs</p>
<ul>
<li>æ­»é” (AA/ABBA)ã€åŸå­æ€§è¿å (ABA)ã€é¡ºåºè¿å (BA)</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜ï¼š</p>
<ul>
<li>åšå¥½ Lab1 çš„æµ‹è¯•æ¡†æ¶<ul>
<li>è™½ç„¶å¤§å®¶å¯ä»¥ç¡¬æ¥ (xjb æ”¹ç¨‹åºç›´åˆ° Online Judge é€šè¿‡)</li>
<li>ä½†æ€»æœ‰ä¸€å¤©å¤§å®¶ä¼šé¢å¯¹äº¤ä»˜ä»£ç ç»™å®¢æˆ·çš„åœºæ™¯</li>
</ul>
</li>
<li>Further reading<ul>
<li>K. Serebryany, et al. <a href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany">AddressSanitizer: A fast address sanity checker</a>. In <em>Proc. of USENIX ATC</em>, 2012.</li>
</ul>
</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>