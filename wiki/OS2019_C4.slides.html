<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/wiki.css"/>
<link rel="stylesheet" href="../static/css/slides.css"/>


    <title>[C] å¹¶å‘Bugs</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: True

class: center, middle

# [C] å¹¶å‘Bugs

è’‹ç‚å²© <jyy@nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# æœ¬è®²æ¦‚è¿°

> å¼•å­ï¼šåŒæ­¥ã€äº’æ–¥çš„æ—¶å€™æˆ‘ä»¬å·²ç»è®²äº†å¾ˆå¤šâ€œä¸å¯¹â€çš„æ¡ˆä¾‹ï¼šå“²â™‚å­¦å®¶æ­»é”ï¼›joinå¤±è´¥ï¼›æ¡ä»¶å˜é‡signalé”™çº¿ç¨‹ï¼›â€¦â€¦
>
> * å¹¶å‘bugæœ‰æ— å›ºå®šçš„æ¨¡å¼ï¼Ÿ
> * æˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•å°½å¯èƒ½åœ°æ‰¾åˆ°/é¿å…å®ƒä»¬ï¼Ÿ

----

* æ­»é” (ABBA)
* åŸå­æ€§è¿å (ABA)
* é¡ºåºè¿å (BA)
* æ•°æ®ç«äº‰

---

class: center, middle

# æ­»é”

---

# æ­»é” (Deadlock)

> A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action, such as sending a message or more commonly releasing a lock.

----

å‡ºç°çº¿ç¨‹â€œäº’ç›¸ç­‰å¾…â€çš„æƒ…å†µ (è·¯å£ç©ºé—´ = èµ„æº)

.center[<img src="../static/wiki/os/2019/img/deadlock-car.jpg" width=400px/>]

---

# æ­»é”ï¼šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ

å‡è®¾ä½ çš„spinlockä¸å°å¿ƒé”™è¯¯åœ°æ‰“å¼€äº†ä¸­æ–­

----

```c
void normal_code() {
  spin_lock(&list_lock);
  spin_lock(&xxx);
  spin_unlock(&xxx); // ---------+
}                          //    |
void interrupt_handler() { //    |
  spin_lock(&list_lock);   // <--+
  spin_unlock(&list_lock);
}
```

---

# æ­»é”ï¼šæ›´å¸¸è§çš„æƒ…å†µ

ä½ ä¸€ä¸ç•™ç¥å°±å¿˜è®°äº†lock orderâ€¦â€¦

* é€»è¾‘è¯»èµ·æ¥æ²¡æœ‰ä»€ä¹ˆå¤§æ¯›ç—…ï¼Œä½†å¯èƒ½åŒæ—¶`move_obj(1, 2)`; `move_obj(2, 1)`â€¦â€¦
* ABBA deadlock

----

```c
void move_obj(int i, int j) {
  spin_lock(&lock[i]);
  spin_lock(&lock[j]);
  arr[i] = NULL;
  arr[j] = arr[i];
  spin_unlock(&lock[j]);
  spin_unlock(&lock[i]);
}
```



---

class: center, middle

# é¿å…æ­»é”

---

# é¿å…æ­»é”ï¼šåŸç†

æ­»é”äº§ç”Ÿçš„å››ä¸ªæ¡ä»¶ ([Edward G. Coffman](https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr.), 1971):

* äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨
* è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æº
* ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤º
* å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»

------

> â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æºã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€

--

count: false

>  â€”â€”.red[æ•™ç§‘ä¹¦å¼çš„ï¼Œå®Œå…¨æ­£ç¡®çš„åºŸè¯]

---

# é¿å…æ­»é”ï¼šåŸç† (cont'd)

é¿å…AAå‹çš„æ­»é”

* AAå‹çš„æ­»é”éå¸¸å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤
* [spinlock.c](/static/wiki/os/2019/demos/spinlock.c) (`if (holding(lk)) panic();`)

----

ä¸ºäº†é¿å…ABBAå‹çš„æ­»é”

* ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„
* ä¸¥æ ¼æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é” (æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆè¿™æ­£ç¡®ï¼Ÿ)

---

# Lock Ordering: æ­£ç¡®æ€§

.center[<img src="../static/wiki/os/2019/img/lock-ordering.png" width=700px/>]

---

# Lock Ordering: åº”ç”¨

Lock Orderingæ˜¯ä¿è¯æ­£ç¡®æ€§çš„é‡è¦é€”å¾„

.center[<img src="../static/wiki/os/2019/img/lock-ordering.jpg" width=500px/>]

---

# åœ¨åº”ç”¨Lock Orderingä¹‹å‰

> Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. Practice will tell you that this approach doesn't scale: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.
>
> The best locks are encapsulated: they .blue[*never get exposed in headers*], and are .blue[*never held around calls to non-trivial functions outside the same file*]. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.

---

# è®©ç¨‹åºå‘˜é¿å…æ­»é”ï¼Ÿ.red[é‚£å°±å®Œäº†]

è°ƒè¯•å…¬ç†ï¼šæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„

* .blue[å¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Šâ€¦â€¦]

----

[lockdep](OS_lockdep): Kernel Lock Validator (since 2.6.17)

* ä¸ºæ¯ä¸€ä¸ªâ€œlock classâ€æ£€æŸ¥(åˆ†é…ä¸€ä¸ªkey)
  * æ¯ä¸ªé™æ€é”éƒ½æ˜¯ä¸€ä¸ªclassï¼škey = åœ°å€
  * åŠ¨æ€åˆ†é…çš„é”ï¼Œç›¸åŒinitialization siteæ˜¯ä¸€ä¸ªclass .green[é—®é¢˜ï¼šå¦‚ä½•å®ç°keyï¼Ÿ]
* åœ¨è¿è¡Œæ—¶è§‚å¯Ÿæ‰€æœ‰çš„lock/unlock
  * lock = push; unlock = pop; .green[å †æ ˆä¿å­˜åœ¨å“ªé‡Œï¼Ÿ]
  * è®°å½•ä¸­æ–­(soft/hardirq)/è¯»å†™ä¿¡æ¯

---

# lockdep: æ­»é”æ£€æŸ¥

* Lock ordering (<math>L_1 \to L_2</math>; <math>L_2 \to L_1</math>)
  * æ¯å½“æ£€æµ‹åˆ°ä¸€å¯¹æ–°çš„<math>L_1 \to L_2</math>æ—¶æ£€æŸ¥
* é…å¯¹ï¼šç¦æ­¢lock(A); lock(B); unlock(A); unlock(B)
* æ²¡æœ‰`pushfcli()`çš„è‡ªæ—‹é”ä¸èƒ½åœ¨ä¸­æ–­ä¸­è·å¾—

----

.float-right[<img src="../static/wiki/os/2019/img/observe.jpg" width=150px/>] lockdepåœ¨è¿è¡Œæ—¶â€œæš—ä¸­è§‚å¯Ÿâ€ç¨‹åºçš„æ‰§è¡Œ

* â€œåŠ¨æ€ç¨‹åºåˆ†æâ€ï¼›â€œç›‘æ§â€
* lockdepæ˜¯ç¼–è¯‘åœ¨å†…æ ¸ä»£ç ä¸­çš„ï¼›ä½†æˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥ä¸º.red[ä»»ä½•ç¨‹åº]åšè¿™æ ·çš„hacking
  * instrumentationï¼šåœ¨ç¼–è¯‘æ—¶/äºŒè¿›åˆ¶æ—¶æ’å…¥æˆ‘ä»¬çš„ä»£ç 
  * hookingï¼šè¿è¡Œæ—¶hack lock/unlockå‡½æ•°

---

# Live Lock: æ²¡æœ‰å®é™…è¿›å±•

è€æ€»æ‰“ç”µè¯ç»™ç§˜ä¹¦ï¼šâ€œè¿™å‡ å¤©æˆ‘é™ªä½ å»åŒ—äº¬ç©ç©ï¼Œä½ å‡†å¤‡ä¸€ä¸‹â€

ç§˜ä¹¦æ‰“ç”µè¯ç»™è€å…¬ï¼šâ€œè¿™å‡ å¤©æˆ‘è¦å’Œè€æ€»å»åŒ—äº¬å¼€ä¼šâ€

è€å…¬æ‰“ç”µè¯ç»™æƒ…äººï¼šâ€œè¿™å‡ å¤©æˆ‘è€å©†ä¸åœ¨å®¶ï¼Œé™ªæˆ‘â€

æƒ…äººæ‰“ç”µè¯ç»™è¾…å¯¼å­¦ç”Ÿï¼šâ€œè¿™å‡ å¤©è€å¸ˆæœ‰äº‹ï¼Œåœè¯¾â€

å­¦ç”Ÿæ‰“ç”µè¯ç»™çˆ·çˆ·ï¼šâ€œè¿™å‡ å¤©ä¸ä¸Šè¯¾ï¼Œçˆ·çˆ·ä½ é™ªæˆ‘ç©â€

çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šâ€œåŒ—äº¬å»ä¸äº†äº†ï¼Œå­™å­è¦æˆ‘é™ªâ€

ç§˜ä¹¦ç»™è€å…¬æ‰“ç”µè¯ï¼šâ€œè€æ€»çªç„¶æœ‰äº‹ä¸å»åŒ—äº¬å¼€ä¼šäº†â€

è€å…¬ç»™æƒ…äººæ‰“ç”µè¯ï¼šâ€œè€å©†ä¸èµ°äº†ï¼Œä¸‹æ¬¡å†è¯´â€

æƒ…äººç»™è¾…å¯¼å­¦ç”Ÿæ‰“ç”µè¯ï¼šâ€œè¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€

å­¦ç”Ÿç»™çˆ·çˆ·æ‰“ç”µè¯ï¼šâ€œ555è€å¸ˆè¯´è¿™å‡ å¤©ç…§å¸¸ä¸Šè¯¾â€

çˆ·çˆ·ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼šè¿˜æ˜¯å»åŒ—äº¬å§ï¼Œä½ å‡†å¤‡å‡†å¤‡

---

class: center, middle

# å¹¶å‘bugï¼šä¸ä»…æ˜¯æ­»é”

---

# ç¨‹åºå‘˜ï¼šèŠ±å¼çŠ¯é”™

å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·

* äº’æ–¥é”(lock/unlock) - åŸå­æ€§
* æ¡ä»¶å˜é‡(wait/signal) - åŒæ­¥

----

å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)

å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)

----

>åœ¨ç ”ç©¶è¿‡ä¸€å †bug report (Non-deadlock/deadlock): MySQL (14/9), Apache (13/4), Mozilla
>(41/16), OpenOffice (6/2): .red[97%çš„éæ­»é”å¹¶å‘bugéƒ½æ˜¯AVæˆ–OV]ã€‚
>
>Shan Lu, et al. [Learning from mistakes: A comprehensive study on real world concurrency bug characteristics](https://dl.acm.org/citation.cfm?id=1346323). (ASPLOS'08)

---

# åŸå­æ€§è¿å (AV)

â€œABAâ€â€”â€”æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†

* æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜

----

.center[<img src="../static/wiki/os/2019/img/av-bug.png" width=700px/>]

---

# é¡ºåºè¿å (OV)

â€œBAâ€â€”â€”æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ

* å¸¸è§çš„æƒ…å†µï¼šuse after free	

----

.center[<img src="../static/wiki/os/2019/img/ov-bug.png" width=700px/>]

---

# å…³é”®é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ

ç¨‹åºå‘˜.red[åœ¨æœ¬åœ°è·‘äº†å‡ ä¸‡æ¬¡æµ‹è¯•ï¼Œéƒ½æ²¡å‘ç°å•¥æ¯›ç—…]ï¼Œç»“æœéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒé‡Œï¼Œ.red[ğŸ’¥çˆ†ç‚¸äº†]

----

Empirical studyç»™äº†æˆ‘ä»¬æ›´å¤šæœ‰è¶£çš„å‘ç°ï¼š

* Almost all (96%) of the examined concurrency bugs are guaranteed to manifest if certain partial order between .blue[*2 threads*] is enforced. 
* Many (66%) of the examined non-deadlock concurrency bugsâ€™ manifestation involves concurrent accesses to .blue[*only one variable*]. 
* Almost all (97%) of the examined deadlock bugs involve .blue[*two threads*] circularly waiting for at most two resources. 

---

class: center, middle

# Hacking Time!

---

# æšä¸¾çº¿ç¨‹è°ƒåº¦

æ‰¾å¹¶å‘bugå˜æˆäº†ä¸€ä¸ªæœç´¢é—®é¢˜

* å¦‚ä½•é©±åŠ¨ç¨‹åºæŒ‰ç…§æŒ‡å®šçš„è°ƒåº¦æ‰§è¡Œï¼Ÿ
* å¦‚ä½•åœ¨æµ·é‡çš„è°ƒåº¦é‡Œæ‰¾åˆ°å¯èƒ½æœ‰bugçš„é‚£ä¸ªï¼Ÿ

.center[<img src="../static/wiki/os/2019/img/tree.jpg" width=500px/>]

.center[(0: çº¿ç¨‹<math>t_1</math>æ‰§è¡Œä¸€æ­¥ï¼›1: çº¿ç¨‹<math>t_2</math>æ‰§è¡Œä¸€æ­¥)]

---

# æ•°æ®ç«äº‰(Data Races)

AV/OVçš„ä¸€ä¸ªå¸¸è§åŸå› 

* .blue[ä¸¤ä¸ªçº¿ç¨‹]å¯¹.green[åŒä¸€ä¸ªå…±äº«å˜é‡]çš„.red[éåªè¯»å¹¶å‘è®¿é—®]
* ad-hoc synchronizationåŸºæœ¬éƒ½æ˜¯data races

----

Data racesæ—¢ç„¶é‚£ä¹ˆæœ‰å®³ï¼Œèƒ½ä¸èƒ½è‡ªåŠ¨å¸®æˆ‘ä»¬æ‰¾å‡ºæ¥ï¼Ÿ

* [é™æ€æ£€æŸ¥(æ‰«ææºä»£ç )](http://theory.stanford.edu/~srirams/papers/cav2007.html)
* [åŠ¨æ€æ£€æŸ¥(åœ¨å†…å­˜è®¿é—®/åŒæ­¥/äº’æ–¥æ“ä½œæ—¶è®°å½•logï¼Œç„¶åæ£€æŸ¥log)](https://dl.acm.org/citation.cfm?id=781528)

---

# HB Race Detection

åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¢åŠ æ—¥å¿—

* t:lock(&lk)/unlock(&lk)/t:read(x)/t:write(x)

.center[<img src="../static/wiki/os/2019/img/hb.gif" width=400px/>]

---

# å¹¶å‘Bugsï¼šå°ç»“

å’Œbugæ–—æ™ºæ–—å‹‡ï¼šä»£ç  = æ­¦å™¨

* è¿è¡Œæ—¶èŠ±å¼æ”¶é›†log
* åœ¨logé‡ŒèŠ±å¼æ‰¾bug

----

<del>å¼ºåŠ¿å¹ä¸€æ³¢æˆ‘ä»¬çš„ç ”ç©¶å·¥ä½œ</del>
</textarea>

<script src="../static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
</script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>