<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>[C5] é“¾æ¥ä¸åŠ è½½</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="c5">[C5] é“¾æ¥ä¸åŠ è½½</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class="center middle"><h1 id="46">ä¸‹å‘¨ä¸€ (4.6) æ¸…æ˜æ”¾å‡ï¼Œæ— ç›´æ’­</h1>
<p><br></br>
<h1 id="10-oj">æš‚å®šç¬¬ 10 å‘¨æœŸä¸­åœ¨çº¿ (OJ) æµ‹éªŒ</h1></p></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>æˆ‘ä»¬å·²ç»ç†è§£è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œç®¡ç†å®ƒçš„ç³»ç»Ÿè°ƒç”¨</p>
<ul>
<li>é€šè¿‡ <code>/proc/[pid]/maps</code> æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„</li>
</ul>
<p>åœ°å€ç©ºé—´ç»ˆç©¶æ˜¯å±äºè¿›ç¨‹ (è¿è¡Œçš„ç¨‹åº) çš„</p>
<ul>
<li>æ˜¯æ—¶å€™ç³»ç»Ÿåœ°è®²è§£ç¨‹åºæ˜¯æ€ä¹ˆä»æºä»£ç åˆ°æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œçš„äº†</li>
</ul>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>é™æ€é“¾æ¥ä¸åŠ è½½<ul>
<li>Hello ç¨‹åºçš„é“¾æ¥ä¸åŠ è½½</li>
</ul>
</li>
<li>åŠ¨æ€é“¾æ¥ä¸åŠ è½½<ul>
<li>éœ€æ±‚åˆ†æ</li>
<li>è‡ªå·±åŠ¨æ‰‹å®ç°åŠ¨æ€åŠ è½½</li>
<li>ELF æ–‡ä»¶çš„åŠ¨æ€é“¾æ¥ä¸åŠ è½½</li>
</ul>
</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">é™æ€é“¾æ¥ä¸åŠ è½½</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¼–è¯‘/é“¾æ¥çš„éœ€æ±‚</h2>
<blockquote>
<p>éœ€æ±‚ï¼šå…è®¸å¼•ç”¨å…¶ä»–æ–‡ä»¶ (C æ ‡å‡†ç§°ä¸ºç¼–è¯‘å•å…ƒ, compilation unit) é‡Œå®šä¹‰çš„ç¬¦å·</p>
<ul>
<li>C ä¸é˜»æ­¢ä½ éšä¾¿å£°æ˜ç¬¦å·çš„ç±»å‹</li>
<li>ä½†ç±»å‹ä¸åŒ¹é…æ˜¯ undefined behavior (å‘)</li>
</ul>
</blockquote>
<div class="codehilite"><pre><span></span><span class="c1">// a.c</span>
<span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="c1">// b.c</span>
<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1">// main.c</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span> <span class="c1">// å¯ä»¥è¯•è¯• extern int foo;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%d + %d = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">));</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¨‹åºçš„ç¼–è¯‘</h2>
<p>main åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¤–éƒ¨çš„ç¬¦å·å°±åªèƒ½ â€œç•™ç©ºâ€ äº†</p>
<ul>
<li>æ³¨æ„æŒ‡ä»¤ä¸­çš„ <code>00 00 00 00</code> offset</li>
</ul>
<div class="codehilite"><pre><span></span>0000000000000000 &lt;main&gt;:
   0:   48 83 ec 08             sub    $0x8,%rsp
   4:   8b 35 00 00 00 00       mov    0x0(%rip),%esi  # y
   a:   8b 3d 00 00 00 00       mov    0x0(%rip),%edi  # x
  10:   e8 00 00 00 00          callq  15 &lt;main+0x15&gt;  # foo
  15:   8b 15 00 00 00 00       mov    0x0(%rip),%edx  # x
  1b:   8b 0d 00 00 00 00       mov    0x0(%rip),%ecx  # y
  21:   48 8d 35 00 00 00 00    lea    0x0(%rip),%rsi  # stdout
  28:   41 89 c0                mov    %eax,%r8d       # foo(x, y)
  2b:   bf 01 00 00 00          mov    $0x1,%edi       # 1
  30:   31 c0                   xor    %eax,%eax
  32:   e8 00 00 00 00          callq  37 &lt;main+0x37&gt;  # __printf_chk
  37:   31 c0                   xor    %eax,%eax
  39:   5a                      pop    %rdx
  3a:   c3                      retq   
</pre></div>


<ul>
<li>readelf å¯ä»¥æŸ¥çœ‹ relocation éœ€è¦å¡«å…¥çš„æ‰€æœ‰æ•°æ®<ul>
<li>æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆè¦ <code>-4</code>?</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¨‹åºçš„é™æ€é“¾æ¥</h2>
<p>ä½¿ç”¨ gcc çš„ <code>-Wl,--verbose</code> å¯ä»¥å°† <code>--verbose</code> ä¼ é€’ç»™ ld</p>
<ul>
<li>è¿‘è·ç¦»è§‚å¯Ÿ ld çš„è¡Œä¸º<ul>
<li>ldscript ä¸­å„ä¸ª section æŒ‰ç…§ä½•ç§é¡ºåº â€œç²˜è´´â€</li>
<li>ctors/dtors (constructors/destructors) çš„å®ç°<ul>
<li>æˆ‘ä»¬ç”¨è¿‡ <code>__attribute__((constructor))</code> </li>
</ul>
</li>
<li>åªè¯»æ•°æ®å’Œè¯»å†™æ•°æ®ä¹‹é—´çš„ padding<ul>
<li><code>. = DATA_SEGMENT_ALIGN ...</code></li>
</ul>
</li>
</ul>
</li>
<li>è¿™æ˜¯å¤§å®¶ RTFM ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹</li>
</ul>
<hr></hr>
<p>æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶</p>
<ul>
<li>æ‰€æœ‰å¼•ç”¨çš„å‡½æ•°ä»£ç éƒ½åœ¨ (<code>main</code>, <code>foo</code>, <code>___printf_chk</code>, ...)</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="elf-aout">é™æ€ ELF åŠ è½½å™¨ï¼šåŠ è½½ a.out æ‰§è¡Œ</h2>
<p>ç±»ä¼¼äº AbstractMachine ä¸­çš„ boot loader</p>
<ul>
<li>æ ¹æ® ELF program headerï¼Œå°†æ–‡ä»¶ä¸­æŒ‡å®šçš„éƒ¨åˆ†ç§»åŠ¨åˆ°å†…å­˜</li>
<li>æ“ä½œç³»ç»Ÿåœ¨ execve æ—¶å®Œæˆ<ul>
<li>æ“ä½œç³»ç»Ÿåœ¨å†…æ ¸æ€è°ƒç”¨ mmap<ul>
<li>(è¿›ç¨‹è¿˜æœªå‡†å¤‡å¥½æ—¶ï¼Œç”±å†…æ ¸ç›´æ¥æ‰§è¡Œ â€œç³»ç»Ÿè°ƒç”¨â€)</li>
<li>æ˜ å°„å¥½ a.out ä»£ç ã€æ•°æ®ã€å †åŒºã€å †æ ˆã€vvar, vdso, vsyscall</li>
</ul>
</li>
<li>æ›´ç®€å•çš„å®ç°ï¼šç›´æ¥è¯»å…¥è¿›ç¨‹åœ°å€ç©ºé—´<ul>
<li>è¯¾åä¹ é¢˜ï¼šé˜…è¯» <a href="../static/wiki/os/2020/demos/xv6-exec.c">xv6-exec.c</a> (loader)</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="fragment">
<hr></hr>
<ul>
<li>é™æ€é“¾æ¥çš„ç¨‹åºå°±ä» ELF entry å¼€å§‹æ‰§è¡Œ<ul>
<li>ç±»ä¼¼ç¬¬ä¸€æ¬¡ä»£ç è¯¾æ—¶çš„ â€œæœ€å°â€ ç¨‹åº</li>
<li>ä¹‹åå°±å˜æˆæˆ‘ä»¬ç†Ÿæ‚‰çš„<span class="red">çŠ¶æ€æœº</span><ul>
<li>å”¯ä¸€çš„è¡Œä¸ºå°±æ˜¯æ‰§è¡ŒæŒ‡ä»¤ (ç³»ç»Ÿè°ƒç”¨)</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">åŠ¨æ€é“¾æ¥ä¸åŠ è½½</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">åŠ¨æ€åŠ è½½ä»£ç ï¼šéœ€æ±‚åˆ†æ</h2>
<p>ä¾‹å­ï¼šlibc.so</p>
<ul>
<li>300K æ¡æŒ‡ä»¤ï¼Œ2 MiB å¤§å°<ul>
<li>æ¯ä¸ªç¨‹åºå¦‚æœéƒ½é™æ€é“¾æ¥ï¼Œæµªè´¹çš„ç©ºé—´å¾ˆå¤§</li>
<li>æœ€å¥½æ˜¯æ•´ä¸ªç³»ç»Ÿé‡Œåªæœ‰ä¸€ä¸ª libc çš„å‰¯æœ¬<ul>
<li>æ–‡ä»¶ç³»ç»Ÿé‡Œåªæœ‰ä¸€ä¸ªå‰¯æœ¬ (libc.so)</li>
<li>å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå‰¯æœ¬</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>é—®é¢˜ï¼šçœŸçš„æ•´ä¸ªæ“ä½œç³»ç»Ÿé‡Œåªæœ‰ä¸€ä¸ª libc çš„å‰¯æœ¬å—ï¼Ÿ</p>
<ul>
<li>æ–¹æ³• 1: çœ‹ Linux Kernel çš„ trace</li>
<li>æ–¹æ³• 2: è°ƒè¯• Linux Kernel, æŸ¥çœ‹å†…å­˜æ˜ å°„ (QEMU monitor)</li>
<li>æ–¹æ³• 3: ç®€å•åšä¸ªå®éªŒ</li>
</ul>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux">åŠ¨æ€åŠ è½½ä»£ç ï¼šLinux ç³»ç»Ÿçš„è¡Œä¸º</h2>
<p>åˆ›å»ºä¸€ä»½å¾ˆå¤§çš„ä»£ç ï¼Œç„¶ååˆ›å»ºå¾ˆå¤šè¿›ç¨‹å¼•ç”¨è¿™ä¸ªä»£ç </p>
<ol>
<li>é€šè¿‡ fork åˆ›å»ºçˆ¶å­è¿›ç¨‹</li>
<li>åœ¨ç»ˆç«¯ä¸­å¯åŠ¨ç‹¬ç«‹çš„è¿›ç¨‹</li>
</ol>
<hr></hr>
<ul>
<li><p>huge.S</p>
<div class="codehilite"><pre><span></span><span class="na">.globl</span> <span class="no">foo</span>
<span class="nl">foo:</span>
  <span class="c1"># 128 MiB of nop</span>
  <span class="na">.fill</span> <span class="mi">1024</span> <span class="p">*</span> <span class="mi">1024</span> <span class="p">*</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0x90</span>
  <span class="nf">ret</span>
</pre></div>

</li>
<li><p>huge.c</p>
<div class="codehilite"><pre><span></span><span class="n">foo</span><span class="p">();</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"pid = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></div>


</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è‡ªå·±åŠ¨æ‰‹å®ç°åŠ¨æ€åŠ è½½</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="1">å®ç°åŠ¨æ€åŠ è½½ (1)</h2>
<blockquote>
<p>éœ€æ±‚ï¼šåŠ è½½çº¯ç²¹çš„ä»£ç </p>
</blockquote>
<p>æˆ‘ä¹Ÿä¼šï¼</p>
<ul>
<li>ç¼–è¯‘æˆ Position Independent Code (PIC)<ul>
<li>å¼•ç”¨ä»£ç  (è·³è½¬) å…¨éƒ¨ä½¿ç”¨ PC ç›¸å¯¹å¯»å€</li>
<li>x86 å·²ç»æ˜¯è¿™æ ·äº†</li>
</ul>
</li>
<li>ç›´æ¥æŠŠä»£ç  mmap è¿›è¿›ç¨‹çš„åœ°å€ç©ºé—´å°±è¡Œäº†</li>
</ul>
<div class="codehilite"><pre><span></span>.globl foo
foo:
  movl $1, %eax
  ret
</pre></div>

<p>ä»£ç å±•ç¤º: <a href="">loader.c</a></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="2">å®ç°åŠ¨æ€åŠ è½½ (2)</h2>
<blockquote>
<p>éœ€æ±‚å˜äº† ğŸ¤”</p>
<ul>
<li>åŠ è½½ä»£ç ï¼Œå¹¶ä¸”ä»£ç æœ‰é™„å¸¦çš„æ•°æ®</li>
<li>åŠ¨æ€é“¾æ¥åº“å…‰æœ‰ä»£ç æ²¡æœ‰æ•°æ®ä¸è¡Œ</li>
</ul>
</blockquote>
<p>è¿™ä¸ªå¥½åŠï¼Œä»£ç å’Œæ•°æ®åœ¨ä¸€èµ·ï¼Œç”¨ PC ç›¸å¯¹å¯»å€å°±å¥½äº†</p>
<ul>
<li>x86: æˆ‘ä»¬ä¸æ”¯æŒ rip å¯»å€â€¦â€¦</li>
<li><code>call __i686.get_pc_thunk.bx</code><ul>
<li>è·å¾—ä¸‹æ¡æŒ‡ä»¤çš„åœ°å€</li>
<li>æ€è€ƒé¢˜ï¼š<span class="green">å¦‚ä½•å®ç°</span>ï¼Ÿ</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span>x: # æ•°æ®ä¸èƒ½å…±äº« (MAP_PRIVATE æ–¹å¼æ˜ å°„)
  .int 0

.globl bar
bar:
  addl $1, x(%rip)
  movl x(%rip), %eax
  ret
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="3">å®ç°åŠ¨æ€åŠ è½½ (3)</h2>
<blockquote>
<p>éœ€æ±‚åˆåŒå’å•å˜äº† ğŸ˜‚</p>
<ul>
<li>å…è®¸è®¿é—®å…¶ä»–åŠ¨æ€é“¾æ¥åº“å¯¼å‡ºçš„ç¬¦å· (ä»£ç /æ•°æ®)</li>
<li>ä¹Ÿåˆç†â€¦â€¦ (æ¯”å¦‚æˆ‘ä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶å°±æœ‰è¿™ä¸ªéœ€æ±‚)</li>
</ul>
</blockquote>
<p>æœ‰ç‚¹éº»çƒ¦ï¼šç¬¦å·çš„åœ°å€æ˜¯è¿è¡Œ (åŠ è½½) æ—¶æ‰èƒ½ç¡®å®šçš„</p>
<ul>
<li><span class="red">å¿…é¡»åœ¨è¿è¡Œæ—¶è§£æç¬¦å·åœ°å€</span><ul>
<li>æŸ¥è¡¨ (ç¼–è¯‘æˆ <code>call *table[foo]</code>)</li>
<li><del>é‡å¡« (ç›¸å½“äºåœ¨è¿è¡Œæ—¶é‡åšé™æ€é“¾æ¥)</del> â† è¿èƒŒäº†åˆè¡· (ä¸ºä»€ä¹ˆï¼Ÿ)</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span>.globl ..bar
..bar: bar:
  .quad 0

.globl baz
baz:
  movq bar(%rip), %rdi
  call *%rdi
  ret
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="pic">PIC + æŸ¥è¡¨å®ç°åŠ¨æ€é“¾æ¥</h2>
<blockquote>
<p>è€ƒè™‘å®é™…ä¸­çš„åŠ¨æ€é“¾æ¥ (å…±äº«ä»£ç ) çš„éœ€æ±‚</p>
<ul>
<li>main è¦è°ƒç”¨ libc ä¸­çš„ printf</li>
<li>printf è¦è°ƒç”¨ libfoo ä¸­çš„ foo</li>
</ul>
</blockquote>
<p>libld ç”±æ“ä½œç³»ç»ŸåŠ è½½ (ç”©é”…æˆåŠŸ)</p>
<ol>
<li>libld åŠ è½½ libfoo, ä¸€åˆ‡é¡ºåˆ©</li>
<li>libld åŠ è½½ libc<ul>
<li>libc å¯¹ foo çš„è°ƒç”¨è¢«ç¼–è¯‘æˆ <code>call *libc.tab[FOO]</code></li>
<li>libld è°ƒç”¨ <code>_dl_runtime_resolve</code> è§£æç¬¦å·ï¼Œå¡«å…¥ <code>libc.tab[FOO]</code></li>
</ul>
</li>
<li>libld å®Œæˆ main çš„åˆå§‹åŒ–<ul>
<li>a.out å¯¹ printf çš„è°ƒç”¨è¢«ç¼–è¯‘æˆ <code>call *a.out.tab[PRINTF]</code></li>
<li>libld è§£æ printf çš„åœ°å€ï¼Œå¡«å…¥ <code>a.out.tab[PRINTF]</code></li>
</ul>
</li>
</ol></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="elf">ELF: åŠ¨æ€é“¾æ¥å’ŒåŠ è½½</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="got-global-offset-table">GOT (Global Offset Table)</h2>
<p>GOT: shared object ç”¨æ¥å­˜å‚¨åŠ¨æ€ç¬¦å·çš„è¡¨æ ¼</p>
<ul>
<li>åº“å‡½æ•°æœ‰</li>
<li>å¯æ‰§è¡Œæ–‡ä»¶ä¹Ÿæœ‰<ul>
<li>æ‰€ä»¥ä½ ç”¨ file æŸ¥çœ‹ a.out å’Œ libc.so éƒ½æ˜¯ â€œshared objectâ€</li>
</ul>
</li>
</ul>
<div class="fragment">
<hr></hr>
<p>GOT ä¸­å‚¨å­˜çš„æ•°æ®</p>
<ul>
<li><code>GOT[0]</code>: <code>.dynamic</code> èŠ‚çš„åœ°å€</li>
<li><code>GOT[1]</code>: link map<ul>
<li>ç”¨äºéå†ä¾èµ–çš„åŠ¨æ€é“¾æ¥åº“</li>
</ul>
</li>
<li><code>GOT[2]</code>: <code>_dl_runtime_resolve</code> çš„åœ°å€<ul>
<li><code>call *GOT[2]</code> å¯ä»¥å®Œæˆç¬¦å·è§£æ</li>
</ul>
</li>
<li><code>GOT[i]</code>: ç¨‹åºæ‰€éœ€çš„åŠ¨æ€ç¬¦å·åœ°å€ (printf, ...)</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç¬¦å·è§£æï¼šæ–°éœ€æ±‚</h2>
<blockquote>
<p>èƒ½å¦é™ä½å®é™…æ²¡æœ‰è°ƒç”¨ç¬¦å·çš„å¼€é”€ï¼Ÿ</p>
</blockquote>
<p>ç¨‹åºå¯èƒ½ä¼šå¼•ç”¨å¾ˆå¤šç¬¦å·</p>
<ul>
<li>ä½†æ‰§è¡Œæ—¶å¯èƒ½å¤§éƒ¨åˆ†ç¬¦å·éƒ½æ²¡ç”¨åˆ°<ul>
<li>é€ä¸ª <code>_dl_runtime_resolve</code> å°±æµªè´¹äº†</li>
<li>ä¾‹å­ 1: è¿è¡Œåº“<ul>
<li>è¿è¡Œåº“å¯èƒ½åªæœ‰å¾ˆå°‘éƒ¨åˆ†ä»£ç è¢«è°ƒç”¨ï¼Œä½†ç¬¦å·éƒ½å¿…é¡»è¢«è§£æ</li>
</ul>
</li>
<li>ä¾‹å­ 2: busybox<ul>
<li>å‘½ä»¤æ‰§è¡Œæ—¶é—´å¯èƒ½å°äºç¬¦å·è§£æçš„æ—¶é—´</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lazy-symbol-resolution">Lazy Symbol Resolution</h2>
<blockquote>
<p>æƒ³æ³•ï¼šåŠ è½½æ—¶ç½®ä¸º <code>NULL</code>, ç”¨æ—¶åˆ¤æ–­/è§£æ</p>
</blockquote>
<p>ä½¿ç”¨ä¸€å°æ®µ â€œtrampoline codeâ€</p>
<ul>
<li>å¦‚æœç¬¦å·è§£ææœªå®Œæˆï¼Œè§£æç¬¦å·</li>
<li>è·³è½¬åˆ°è§£æåçš„ç¬¦å·æ‰§è¡Œ</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">printf_internal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GOT</span><span class="p">[</span><span class="n">PRINTF</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">GOT</span><span class="p">[</span><span class="n">PRINTF</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_dl_runtime_resolve</span><span class="p">(</span><span class="s">"printf"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">GOT</span><span class="p">[</span><span class="n">PRINTF</span><span class="p">](...);</span>
<span class="p">}</span>
</pre></div>

<div class="codehilite"><pre><span></span># ç¼–è¯‘å™¨ï¼šæŠŠå‘ printf (åŠ¨æ€é“¾æ¥åº“) çš„è°ƒç”¨ç¿»è¯‘æˆ
call printf_internal
</pre></div>


<ul>
<li>åå¤„ï¼šfast path å¤šä¸€æ¬¡åˆ¤æ–­<ul>
<li>call + load + åˆ¤æ–­ + jmp</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lazy-symbol-resolution-contd">Lazy Symbol Resolution (cont'd)</h2>
<blockquote>
<p>é»‘ç§‘æŠ€ï¼šè®©åˆå§‹çš„ <code>printf@GOT</code> æŒ‡å‘ trampoline çš„ä¸‹ä¸€æ¡æŒ‡ä»¤</p>
</blockquote>
<div class="codehilite"><pre><span></span>0000000000000510 &lt;.plt&gt;:
 510:   ff 35 aa 0a 20 00    pushq  0x200aaa(%rip)  # 200fc0 &lt;GOT+0x8&gt;
 516:   ff 25 ac 0a 20 00    jmpq   *0x200aac(%rip) # 200fc8 &lt;GOT+0x10&gt;
                                                    # GOT[2], è¿˜è®°å¾—å—ï¼Ÿ
 51c:   0f 1f 40 00          nopl   0x0(%rax)

0000000000000520 &lt;printf@plt&gt;:
 520:   ff 25 aa 0a 20 00    jmpq   *0x200aaa(%rip) # printf@GOT
 526:   68 00 00 00 00       pushq  $0x0
 52b:   e9 e0 ff ff ff       jmpq   510 &lt;.plt&gt;
</pre></div>


<ul>
<li>åªæœ‰ä¸¤æ¡æŒ‡ä»¤<ul>
<li><code>call printf@plt; jmp *a.out.GOT[PRINTF]</code></li>
</ul>
</li>
<li>å¯¹ç°ä»£å¤„ç†å™¨éå¸¸å‹å¥½<ul>
<li>æœ‰ branch-target-buffer (BTB), å‡ ä¹ä¸æŸå¤±æ€§èƒ½</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>åŠ¨æ€é“¾æ¥ä¸€ç›´æ˜¯å¤§éƒ¨åˆ†åŒå­¦æ— æ³•æŒæ¡çš„éš¾é¢˜â€¦â€¦</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦æŠŠéœ€æ±‚ (é—®é¢˜) è¿›è¡Œåˆ†è§£</li>
<li>ä»åŠ è½½çš„è§†è§’ç†è§£é“¾æ¥<ul>
<li>éœ€è¦åŠ è½½ä¸€æ®µä»£ç  (foo)<ul>
<li>PIC (ä»£ç ä½¿ç”¨ PC ç›¸å¯¹å¯»å€) + mmap</li>
</ul>
</li>
<li>ä»£ç éœ€è¦ä¼´éšæ•°æ® (bar)<ul>
<li>æ•°æ®ä½¿ç”¨ PC ç›¸å¯¹å¯»å€ + mmap</li>
</ul>
</li>
<li>éœ€è¦è§£æåŠ¨æ€ç¬¦å· (printf)<ul>
<li>æŸ¥è¡¨ (GOT)</li>
<li>ä¼˜åŒ–: PLT, lazy symbol resolve</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜ï¼š</p>
<ul>
<li>æ›´å¤šçš„å®è—: ld-linux (8), <a href="../static/wiki/os/2020/demos/xv6-exec.c">xv6-exec.c</a></li>
<li>MiniLab: C Read-Eval-Print-Loop</li>
<li>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å†™ä¸€ä¸ªé™æ€ ELF64 åŠ è½½å™¨ (ä½¿ç”¨ mmap)</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>