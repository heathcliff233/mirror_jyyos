<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/wiki.css"/>
<link rel="stylesheet" href="../static/css/slides.css"/>


    <title>åŒæ­¥</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: True

class: center, middle

# åŒæ­¥

è’‹ç‚å²© <jyy@nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# æœ¬è®²æ¦‚è¿°

> å¤ä¹ ï¼šåŸå­æ“ä½œã€è‡ªæ—‹é”ã€äº’æ–¥é”å®ç°äº’æ–¥
>
> ä½†ä»…æœ‰äº’æ–¥æ—¶ï¼Œå®ç°çº¿ç¨‹è¡Œä¸ºçš„æ§åˆ¶ä¾æ—§å¾ˆå›°éš¾(æˆ–è€…è¯´ä¸å¤ªè‡ªç„¶)ï¼Œä¾‹å¦‚`join()`â€”â€”ä½ èƒ½ç”¨äº’æ–¥é”å®ç°`join()`å—ï¼Ÿ
>
> * .red[åŒæ­¥æœºåˆ¶]ï¼šæ›´å®¹æ˜“çš„ç†è§£å¹¶å‘æ§åˆ¶

----

* åŒæ­¥ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€å“²å­¦å®¶åƒé¥­é—®é¢˜
* æ¡ä»¶å˜é‡
* ä¿¡å·é‡

----

Warning:

* Lab1å·²ç»å¸ƒç½®
* å¹¶å‘.red[éœ€è¦å¤´è„‘æ¸…é†’]ï¼Œè¯¾åä¸€å®šè¦è¯»æ•™æ

---

class: center, middle

# åŒæ­¥

---

# åŒæ­¥ (Synchronization)

ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»

* iTunesåŒæ­¥(æ‰‹æœº vs ç”µè„‘)
* å˜é€Ÿç®±åŒæ­¥å™¨(åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)
* åŒæ­¥ç”µæœº(è½¬å­ä¸ç£åœºé€Ÿåº¦ä¸€è‡´)
* åŒæ­¥ç”µè·¯(ç”±æ—¶é’Ÿé©±åŠ¨)
* çº¿ç¨‹åŒæ­¥(åœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€)

----

å¼‚æ­¥ (Asynchronous) = ä¸åŒæ­¥

* ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬(å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)

---

# å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥

ç­‰å¾…æŸä¸ªæ±‡åˆç‚¹åå„è‡ªç»§ç»­è¡ŒåŠ¨ .float-right[<img src="../static/wiki/os/2019/img/ge.jpg" width=200px/>] 

* NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥
* èˆå‹ï¼šç­‰æˆ‘å†™å®Œè¿™æ®µä»£ç å°±åƒé¥­
* å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜

----

* ä¸¤ä¸ªçº¿ç¨‹å„è‡ªåœ¨å®ŒæˆæŸä»¶äº‹(å¹¶å‘)

* åœ¨æœªæ¥å­˜åœ¨æŸä¸ªæ—¶åˆ»ï¼Œåœ¨æ¡ä»¶æ»¡è¶³åï¼Œä¸¤ä¸ªçº¿ç¨‹åœ¨ä¸€ä¸ªå¯é¢„æœŸçš„çŠ¶æ€ (â€œåŒæ­¥â€)

---

# åŒæ­¥çš„ä¾‹å­

åŒæ­¥ï¼šâ€œç³»ç»Ÿä¸­å­˜åœ¨ä¸€ä¸ªæ—¶åˆ»ï¼Œä¸¤ä¸ªçº¿ç¨‹çš„`sync()`åŒæ—¶è¿”å›â€

* ä½†å› ä¸ºå¹¶å‘æ‰§è¡Œæ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤syncä¹‹åçš„æ“ä½œå¯èƒ½æœ‰å…ˆå

```c
void npy_thread() {
  play_game(); // ä¸çŸ¥é“è¦ç©å¤šä¹…
  sync();
}

void me_thread() {
  ... // ä¹Ÿä¸çŸ¥é“è¦å¤šä¹…
  sync();
  complain(); // ~!@*#!%@#%
}
```



---

# ä¾‹å­ï¼šå®ç°join

```c
int done; // bug

void workload() {
  // workload
  asm volatile("lock addq $1, %0" :
               "=m"(done)); // é¡ºåºã€åŸå­ã€å¯è§
}

int main() {
  for (int i = 0; i < nworkers; i++) 
    create(workload);
  while (done != nworkers); // ç­‰å¾…ï¼Œç›´åˆ°done == nworkers
  printf("All done\n");
}
```

---

class: center, middle

# ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜

---

# ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜

å¹¶å‘æ§åˆ¶ä¸­çš„æœ€ç»å…¸é—®é¢˜ï¼Œ.red[èƒ½è§£å†³90%çš„å®é™…å¹¶å‘é—®é¢˜]

* ç”Ÿäº§è€…(çº¿ç¨‹)ç”Ÿäº§èµ„æº(ä¸€ä¸ªå¯¹è±¡)ï¼Œç”Ÿäº§æ—¶é—´ä¸ç¡®å®š
* æ¶ˆè´¹è€…(çº¿ç¨‹)æ¶ˆè´¹èµ„æº(å–èµ°ä¸€ä¸ªå¯¹è±¡)ï¼Œæ¶ˆè´¹æ—¶é—´ä¹Ÿä¸ç¡®å®š

----

éœ€è¦ä¸€ä¸ª.red[å¹¶å‘é˜Ÿåˆ—]ï¼š

```c
void consumer_thread() {
  while (1) {
    object_t *obj = dequeue(); // spinï¼šé˜Ÿåˆ—å¯èƒ½æ²¡æœ‰å…ƒç´ 
    if (obj) consume(obj);
  }
}
void producer_thread() {
  while (1) {
    object_t *obj = produce();
    while (enqueue(obj) != SUCC); // spin: é˜Ÿåˆ—å¯èƒ½ç©ºé—´ä¸è¶³
  }
}
```

---

# æ€è€ƒé¢˜ï¼š.green[å¦‚ä½•å®ç°å¹¶å‘é˜Ÿåˆ—ï¼Ÿ]

æ”¯æŒ`enqueue(obj)` (è¿”å›SUCC/FAIL)ã€dequeue() (è¿”å›å¯¹è±¡æˆ–NULL)

å‡è®¾ï¼š

* é˜Ÿåˆ—çš„å¤§å°æœ‰é™(é™æ€æ•°ç»„åˆ†é…)
* `enqueue`åœ¨ç©ºé—´ä¸è¶³æ—¶è¿”å›FAIL
* é˜Ÿåˆ—æ“ä½œç«‹å³è¿”å›ï¼Œä¸ä¼šå¼•èµ·çº¿ç¨‹ç¡çœ 

---

# ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šç®€åŒ–

 æœ‰ä¸¤ç§çº¿ç¨‹

```c
void type1_thread() {
  while (1) printf("("); // enqueue
}
void type2_thread() {
  while (1) printf(")"); // dequeue
}
```

åœ¨ä¸å—å¹¶å‘æ§åˆ¶çš„å‰æä¸‹ï¼Œä»»æ„çš„æ‹¬å·åºåˆ—éƒ½æ˜¯åˆæ³•çš„ï¼›ä½†ç”Ÿäº§è€…-æ¶ˆè´¹è€…éœ€è¦æ»¡è¶³ï¼š

* ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€
* æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡<math>n</math>
* ä¾‹å¦‚<math>n=3</math>ï¼Œ`((()))(((`åˆæ³•ï¼›`(((())))`ä¸åˆæ³•

---

class: center, middle

# æ¡ä»¶å˜é‡

---

# Conditional Variables (CV)

éå¸¸ç›´è§‚çš„åŒæ­¥æ–¹æ³•ï¼šä¸€ä¸ªæ¡ä»¶å˜é‡ä»£è¡¨â€œæŸä¸ªæ¡ä»¶æ»¡è¶³â€ï¼Œæ”¯æŒï¼š

* .red[**ç­‰å¾…**]æŸä¸ªæ¡ä»¶æ»¡è¶³åå‘ç”Ÿ
* æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œ.red[**å”¤é†’ä¸€ä¸ª**]æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹
* æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œ.red[**å”¤é†’æ‰€æœ‰**]æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹

---

# CV API

å¯¹äºä¸€ä¸ªconditional variable cï¼š

* .red[wait(c)] 
  *  ç­‰å¾…cä¸Šçš„äº‹ä»¶å‘ç”Ÿ (ä¸éœ€è¦spin)
* .red[signal/notify(c)] ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ·
  * æŠ¥å‘Šcä¸Šçš„äº‹ä»¶å‘ç”Ÿ
  * å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…cï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹
* .red[broadcast/notifyAll(c)] ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ·
  * æŠ¥å‘Šcä¸Šçš„äº‹ä»¶å‘ç”Ÿ
  * å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾…cçš„çº¿ç¨‹

---



# CV: å®ç°join

```c
void worker(int id) {
  ...
  done[id] = 1; // éœ€è¦doneå—ï¼Ÿ
  signal(&joins); // æŠ¥å‘Šï¼šâ€œæœ‰äººç»“æŸå•¦ï¼â€
}

int main() {
  for (int i = 0; i < nworkers; i++)
    create(worker, i);
  for (int i = 0; i < nworkers; i++)
    while (!done[i]) // tricky code
      wait(&joins); // ç­‰å¾…ï¼šæœ‰äººç»“æŸ
}
```

---

# CV: å®ç°join (cont'd)

```c
void worker(int id) {
  ...
  mutex_lock(&mutex);
  done[id] = 1; // å¯èƒ½å’Œreadå¹¶å‘æ‰§è¡Œ
  signal(&joins);
  mutex_unlock(&mutex);
}

int main() {
  for (int i = 0; i < nworkers; i++)
    create(worker, i);
  for (int i = 0; i < nworkers; i++) {
    lock(&mutex);
    if (!done[i]) {
      wait(&joins, &mutex);
    }
    unlock(&mutex);
}
```



---

# CV: å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

```c
void producer_thread() {
  while (1) {
    // [ TBD ]
    printf("("); // push
    // [ TBD ]
  }
}

void consumer_thread() {
  while (1) {
    // [ TBD ]
    printf(")"); // pop
    // [ TBD ]
  }
}
```

---

# ç”Ÿäº§è€…-æ¶ˆè´¹è€… (cont'd)

```c
void producer_thread() {
  while (1) {
    mutex_lock(&mutex);
    if (count == n) wait(&cond, &mutex); // ç­‰å¾…â€œæœ‰ç©ºé—²â€
    printf("("); // push
    count++; signal(&cond);
    mutex_unlock(&mutex);
  }
}

void consumer_thread() {
  while (1) {
    mutex_lock(&mutex);
    if (count == 0) wait(&cond, &mutex); // ç­‰å¾…â€œæœ‰æ•°æ®â€
    printf(")"); // pop
    count--; signal(&cond);
    mutex_unlock(&mutex);
  }
}
```

---

# å‡­ä»€ä¹ˆç®—æ³•æ˜¯å¯¹çš„ï¼Ÿ

æ„Ÿè°¢äº’æ–¥é”æä¾›çš„åŸå­æ€§ã€é¡ºåºã€å¯è§æ€§

* æˆ‘ä»¬åªéœ€è¦è®¨è®ºcountå’Œçº¿ç¨‹çš„çŠ¶æ€

.center[<img src="/static/wiki/os/2019/img/cv-reason.png" width=450px/>]

---

# å°ç»“ï¼šæ¡ä»¶å˜é‡å®ç°å¹¶å‘æ§åˆ¶

ä¸€ä¸ªæ¡ä»¶å˜é‡ä»£è¡¨ä¸€ä¸ªâ€œæ¡ä»¶â€

* wait()ç­‰å¾…æ¡ä»¶å‘ç”Ÿ
* æ¡ä»¶å‘ç”Ÿåsignal()å”¤é†’ç­‰å¾…çš„çº¿ç¨‹
* å’Œäº’æ–¥é”è”åˆä½¿ç”¨

---

class: center, middle

# ä¿¡å·é‡

---

# æ¸¸æ³³æ± ç®¡ç†

* `in(&pool)` - ç­‰å¾…ç®¡ç†å‘˜ç»™ä»–ä¸€ä¸ªæ‰‹ç¯ï¼›å¦‚æœæ²¡æœ‰åˆ™æ’é˜Ÿç­‰å¾…
* `out(&pool)` - æŠŠæ‰‹ç¯è¿˜ç»™ç®¡ç†å‘˜

 .center[<img src="../static/wiki/os/2019/img/swim-pool.png" width=700px/>] 

---

# æ¸¸æ³³æ± ç®¡ç† (cont'd)

å®Œå…¨æ²¡æœ‰å¿…è¦é™åˆ¶æ‰‹ç¯çš„æ•°é‡

* ç®¡ç†å‘˜å¯ä»¥æŒæœ‰ä»»æ„æ•°é‡çš„æ‰‹ç¯(æ¸¸æ³³æ± å®¹é‡ä¸Šé™)
* å…ˆè¿›å…¥æ¸¸æ³³æ± çš„åŒå­¦å…ˆå¾—åˆ°
* åè¿›å…¥æ¸¸æ³³æ± çš„åŒå­¦éœ€è¦ç­‰å¾…(å¤å¤©ä¸‹é¥ºå­æ—¶çš„æƒ…å†µ)

----

E. W. Dijkstraä¸€å®šæ˜¯æ¸¸æ³³çˆ±å¥½è€…(è¯¯

---

# æ¸¸æ³³æ± ç®¡ç† (cont'd)

 .float-right[<img src="../static/wiki/os/2019/img/doraemon.gif" width=300px/>] 

æ¸¸æ³³æ± å¯ä»¥â€œä¸å­˜åœ¨â€â€”â€”çº¿ç¨‹å¯ä»¥ä»»æ„â€œå˜å‡ºâ€ä¸€ä¸ªæ‰‹ç¯

* æŠŠæ‰‹ç¯çœ‹æˆæ˜¯ä»¤ç‰Œ
* å¾—åˆ°ä»¤ç‰Œçš„å¯ä»¥è¿›å…¥æ‰§è¡Œ
* å¯ä»¥éšæ—¶åˆ›å»ºä»¤ç‰Œ

----

â€œæ‰‹ç¯â€ = â€œä»¤ç‰Œâ€ = â€œä¸€ä¸ªèµ„æºâ€

P(&sem) - prolaag = try + decrease; wait; down; in

* ç­‰åˆ°ä¸€ä¸ªæ‰‹ç¯åè¿”å›(å¦‚æœæ­¤æ—¶æœ‰ç©ºé—²çš„æ‰‹ç¯ï¼Œç«‹å³è¿”å›)

V(&sem) - verhoog = increase; post; up; out

* åˆ›é€ ä¸€ä¸ªæ‰‹ç¯

---

# ä¿¡å·é‡

 .center[<img src="../static/wiki/os/2019/img/semaphore.jpg" width=700px/>] 

---

# ä¿¡å·é‡ (cont'd)

ä¿¡å·é‡ = äº’æ–¥é” + æ¡ä»¶å˜é‡

* P/Væ˜¯åŸå­æ“ä½œ
* ä»…æœ‰ä¸€ä¸ªæ‰‹ç¯ = äº’æ–¥é”
* P = wait; V = signal
* å› ä¸ºè®¡æ•°å™¨çš„å­˜åœ¨ï¼Œä¸ä¼šå‘ç”Ÿsignalâ€œä¸¢å¤±â€

---

# ä¿¡å·é‡ï¼šå®ç°join

ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹ï¼šæ¯ä¸€å•ä½â€œ.red[èµ„æº]â€æ˜¯ä»€ä¹ˆã€ä»€ä¹ˆæ—¶å€™åˆ›é€ ã€ä»€ä¹ˆæ—¶å€™è·å–

```c
void worker() {
  ...
  V(&joins); // åˆ›å»ºä¸€ä¸ªæ‰‹ç¯
}

void main() {
  for (int i = 0; i < nworkers; i++)
    create(worker);
  for (int i = 0; i < nworkers; i++) // é›†é½nä¸ª
    P(&joins); // P()è¿”å› -> å¾—åˆ°ä¸€ä¸ªæ‰‹ç¯
}
```

---

# ä¿¡å·é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

```c
void producer() {
  P(&empty); // P()è¿”å› -> å¾—åˆ°æ‰‹ç¯
  mutex_lock(&mutex);
  printf("(");
  mutex_unlock(&mutex);
  V(&fill);
}

void consumer() {
  P(&fill);
  mutex_lock(&mutex);
  printf(")");
  mutex_unlock(&mutex);
  V(&empty);
}
```



---

class: center, middle

# å“²å­¦å®¶åƒé¥­é—®é¢˜

---

# é—®é¢˜å®šä¹‰

æ¯ä¸ªçº¿ç¨‹`id`å¿…é¡»è·å¾—lhs (`id`)å’Œrhs (`(id+1) % n`)ç¼–å·çš„èµ„æºæ‰èƒ½ç»§ç»­

* æƒ³è±¡æˆå“²å­¦å®¶(çº¿ç¨‹)æœ‰æ—¶æ€è€ƒï¼Œæœ‰æ—¶åƒé¥­
* åƒé¥­éœ€è¦åŒæ—¶å¾—åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„å‰å­
* å½“å‰å­è¢«å…¶ä»–äººå æœ‰æ—¶ï¼Œå¿…é¡»ç­‰å¾…

.center[<img src="../static/wiki/os/2019/img/dining-philosophers.jpg" width=300px/>]

---

# Spinning

å¾ˆå®¹æ˜“è¯´æ˜æ­£ç¡®ï¼Œä½†ä¼šå¿™ç­‰å¾…

```c
void philosopher(int id) {
  while (1) {
    think();
    for (int acquired = 0; !acquired; ) {
      spin_lock(&lock);
      if (empty[lhs] && empty[rhs]) {
        empty[lhs] = empty[rhs] = 0; 
        acquired = 1;
      }
      spin_unlock(&lock);
    }
    eat();
    emtpy[lhs] = empty[rhs] = 1;
    __sync_synchronize();
  }
}
```



---

# ä¸€ä¸ªå°è¯•

å®ƒèƒ½æ­£ç¡®å®ç°å‰å­æ— å†²çªè®¿é—®ï¼Œä½†å®ƒæ­£ç¡®å—ï¼Ÿ

* ä½ æœ‰åˆ«çš„åŠæ³•å—ï¼Ÿ

```c
void philosopher(int id) {
  while (1) {
    think();
    mutex_lock(&locks[lhs]);
    mutex_lock(&locks[rhs]);
    eat();
    mutex_unlock(&locks[rhs]);
    mutex_unlock(&locks[lhs]);
  }
}
```

---

# ä¸€ä¸ªGeneral Solution

è®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†æ‰€æœ‰çš„å‰å­

```c
void philosopher(int id) {
  while (1) {
    think();
    send_request(id, EAT);
    P(allowed[id]); // ç›´åˆ°managerå…è®¸æˆ‘åƒäº†æ‰å¼€å§‹
    eat();
    send_request(id, DONE);
  }
}

void manager() {
  while (1) {
    (id, status) = receive_request();
    if (status == EAT) { ... }
    if (status == DONE) { ... }
  }
}
```

---

# ä¸€ä¸ªäººçš„ç“¶é¢ˆ

æœ¬æ¥å¤§å®¶å¯ä»¥æ¬¢å¿«åœ°åŒæ—¶ä¸¾èµ·å‰å­ï¼Œç°åœ¨éº»çƒ¦äº†ï¼Œæ¯æ¬¡éƒ½è¦æ‰¾é‚£ä¸ªäººï¼Œä»–è¿˜æ˜¯ä¸²è¡Œå¤„ç†çš„â€¦â€¦

* ä¸€å¤§æ¡Œäººåƒé¥­ï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜çš„æ„Ÿè§‰

----

.red[æŠ›å¼€workloadè°ˆä¼˜åŒ–å°±æ˜¯è€æµæ°“]

* eat (å®é™…çš„workload)æ—¶é—´å¯èƒ½è¿œå¤§äºè¯·æ±‚(å‡ ä¸ªå†…å­˜æ“ä½œ)æ—¶é—´
* å¦‚æœä¸€ä¸ªmanageræä¸å®šï¼Œå¯ä»¥åˆ†å¤šä¸ª <-- .blue[è¿™å‡ ä¹è§£å†³äº†100%çš„å·¥ä¸šç•Œé—®é¢˜]
</textarea>

<script src="../static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
</script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>