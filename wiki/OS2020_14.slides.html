<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>è¾“å…¥/è¾“å‡ºè®¾å¤‡</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è¾“å…¥/è¾“å‡ºè®¾å¤‡</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>å¾ˆå¤šäºº (ä½ ä»¬çš„åŒå­¦ä»¬ã€å®¶é•¿ä»¬) éƒ½æœ‰ä¸€ä¸ªè®¤è¯†</p>
<ul>
<li>â€œè®¡ç®—æœºç³»å°±æ˜¯è£… (ä¿®) ç”µè„‘çš„â€</li>
<li><del>ä½†ä¸Šäº†è®¡ç®—æœºç³»å‘ç°æ ¹æœ¬ä¸æ˜¯è¿™ä¹ˆå›äº‹å•Š</del><ul>
<li>å› ä¸ºå¤§å®¶å¯¹ç”µè„‘çš„å°è±¡åªæœ‰ I/O è®¾å¤‡</li>
</ul>
</li>
</ul>
<p>é—®é¢˜ï¼šCPU å’Œæ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•è®¿é—®/ç®¡ç† I/O è®¾å¤‡çš„ï¼Ÿ</p>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>I/O è®¾å¤‡å’Œæ€»çº¿<ul>
<li>6 ä¸ªè®¾å¤‡çš„ä¾‹å­</li>
</ul>
</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="io">I/O è®¾å¤‡</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io">I/O è®¾å¤‡</h2>
<blockquote>
<p>I/O è®¾å¤‡æ˜¯æ²Ÿé€šè®¡ç®—æœºå’Œç‰©ç†ä¸–ç•Œçš„æ¡¥æ¢</p>
<ul>
<li>æ²¡æœ‰ I/O è®¾å¤‡ï¼Œè®¡ç®—æœºå°±åªèƒ½ â€œè®¡ç®—â€<ul>
<li>æŠŠå†…å­˜é‡Œçš„å€¼æ¬åˆ°å¯„å­˜å™¨ã€è¿ç®—ã€å†™å›</li>
</ul>
</li>
</ul>
</blockquote>
<p>åœ¨ CPU çœ‹æ¥</p>
<ul>
<li><p>I/O è®¾å¤‡æ˜¯ä¸€ä¸ªèƒ½ä¸ CPU äº¤æ¢æ•°æ®çš„æ¥å£</p>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/canonical-device.png" width="600px"></img></p>
</li>
<li><p>å®é™…ä¸Š CPU å’Œè®¾å¤‡çš„æ§åˆ¶å™¨äº¤äº’</p>
<ul>
<li>CPU å¹¶ä¸çŸ¥é“å›¾å½¢æ˜¯å¦‚ä½•æ‰“å°åˆ°çº¸ä¸Šã€åƒç´ ç‚¹æ˜¯æ€ä¹ˆç»˜åˆ¶åˆ°å±å¹•ä¸Šçš„</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="cpu-io">CPU å¦‚ä½•è®¿é—® I/O è®¾å¤‡ï¼Ÿ</h2>
<p>I/O è®¾å¤‡ä»¥<span class="red">å¯¼çº¿</span> (å®é™…æ˜¯æŸç§æ¥å£åè®®) çš„æ–¹å¼è¿æ¥åˆ°è®¡ç®—æœºä¸Šçš„</p>
<ul>
<li>è€å¼é”®ç›˜/é¼ æ ‡ (PS/2)</li>
<li>æ˜¾å¡çš„æ’æ§½ (PCIe)</li>
<li>ä¼˜ç›˜çš„æ’å£ (USB type-A/type-C)</li>
<li>â€¦â€¦</li>
</ul>
<hr></hr>
<p>CPU ä½¿ç”¨ port I/O æˆ– memory-mapped I/O è®¿é—®</p>
<ul>
<li>ä½¿ç”¨ in/out æŒ‡ä»¤ï¼Œè®¿é—® I/O è®¾å¤‡çš„å¯„å­˜å™¨<ul>
<li>ä¾‹å­ï¼šé”®ç›˜ã€é¼ æ ‡ã€ä¸²å£</li>
</ul>
</li>
<li>ç›´æ¥æ‰§è¡Œ memory dereference è®¿é—® memory-mapped I/O è®¾å¤‡<ul>
<li>ä¾‹å­ï¼šæ˜¾å­˜ã€PCIã€APIC</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="1">ä¾‹å­ (1): é”®ç›˜æ§åˆ¶å™¨</h2>
<p>IBM PC/AT 8042 PS/2 (Keyboard) Controller</p>
<ul>
<li>â€œç¡¬ç¼–ç â€ åˆ°ä¸¤ä¸ª I/O port: <code>0x60</code> (data), <code>0x64</code> (status/command)</li>
</ul>
<table>
<thead>
<tr>
<th>Command Byte</th>
<th>Use</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>0xED</td>
<td>LED ç¯æ§</td>
<td>ScrollLock/NumLock/CapsLock</td>
</tr>
<tr>
<td>0xF3</td>
<td>è®¾ç½®é”®ç›˜é‡å¤é€Ÿåº¦</td>
<td>30Hz - 2Hz; Delay: 250 - 1000ms</td>
</tr>
<tr>
<td>0xF4/0xF5</td>
<td>æ‰“å¼€/å…³é—­</td>
<td>N/A</td>
</tr>
<tr>
<td>0xFE</td>
<td>é‡æ–°å‘é€</td>
<td>N/A</td>
</tr>
<tr>
<td>0xFF</td>
<td>RESET</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">);</span>
<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// æ²¡æœ‰è¾“å…¥</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// é¼ æ ‡</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">&</span> <span class="mh">0xff</span><span class="p">;</span>
    <span class="c1">// æŒ‰é”®çš„ â€œæ‰«æç â€</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="2">ä¾‹å­ (2): ç£ç›˜æ§åˆ¶å™¨</h2>
<p>ATA controller</p>
<ul>
<li>primary: <code>0x1f0 - 0x1f7</code>; secondary: <code>0x170 - 0x177</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">waitdisk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">in_byte</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">)</span> <span class="o">&</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="c1">// status (read)</span>
      <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">;</span> <span class="c1">// RDY (ready)</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">readsect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sect</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">waitdisk</span><span class="p">();</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>          <span class="c1">// sector count (1)</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f3</span><span class="p">,</span> <span class="n">sect</span><span class="p">);</span>       <span class="c1">// sector</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f4</span><span class="p">,</span> <span class="n">sect</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>  <span class="c1">// cylinder (low)</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f5</span><span class="p">,</span> <span class="n">sect</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span> <span class="c1">// cylinder (high)</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f6</span><span class="p">,</span> <span class="p">(</span><span class="n">sect</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">);</span> <span class="c1">// drive</span>
  <span class="n">out_byte</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>       <span class="c1">// command (write)</span>

  <span class="n">waitdisk</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SECTSIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span>
    <span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_long</span><span class="p">(</span><span class="mh">0x1f0</span><span class="p">);</span> <span class="c1">// data</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="3">ä¾‹å­ (3): ä¸­æ–­æ§åˆ¶å™¨</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/6502-pinout.jpg" width="300px"></img></p>
<p>CPU æœ‰ä¸€ä¸ªä¸­æ–­å¼•è„š</p>
<ul>
<li>æ”¶åˆ°æŸä¸ªç‰¹å®šçš„ç”µä¿¡å·ä¼šè§¦å‘ä¸­æ–­<ul>
<li>ä¿å­˜ 5 ä¸ªå¯„å­˜å™¨ (cs, rip, rflags, ss, rsp)</li>
<li>è·³è½¬åˆ°ä¸­æ–­å‘é‡è¡¨å¯¹åº”é¡¹æ‰§è¡Œ</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ç³»ç»Ÿä¸­çš„å…¶ä»–è®¾å¤‡å¯ä»¥å‘ä¸­æ–­æ§åˆ¶å™¨è¿çº¿</p>
<ul>
<li>Intel 8259 PIC<ul>
<li>programmable interrupt controller</li>
<li>å¯ä»¥è®¾ç½®ä¸­æ–­å±è”½ã€ä¸­æ–­è§¦å‘ç­‰â€¦â€¦</li>
</ul>
</li>
<li>APIC (Advanced PIC)<ul>
<li>local APIC<ul>
<li>ä¸­æ–­å‘é‡è¡¨, IPI, æ—¶é’Ÿä¸­æ–­, â€¦â€¦</li>
</ul>
</li>
<li>I/O APIC<ul>
<li>å…¶ä»– I/O è®¾å¤‡</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="4">ä¾‹å­ (4): æ€»çº¿</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="cpu-io">å›é¡¾ï¼šCPU å¦‚ä½•è®¿é—® I/O è®¾å¤‡ï¼Ÿ</h2>
<blockquote>
<ul>
<li>ä½¿ç”¨ in/out æŒ‡ä»¤ï¼Œè®¿é—® I/O è®¾å¤‡çš„å¯„å­˜å™¨</li>
<li>ç›´æ¥æ‰§è¡Œ memory dereference è®¿é—® memory-mapped I/O è®¾å¤‡</li>
</ul>
</blockquote>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/6502-pinout.jpg" width="300px"></img></p>
<hr></hr>
<p>ä½†æˆ‘ä»¬çš„å¤„ç†å™¨åªæœ‰å¾ˆå°‘é‡çš„æ¥å£</p>
<ul>
<li>6502 (8-bit): 40 pins</li>
<li>8086 (16-bit): 40 pins</li>
<li>80386DX (32-bit): 132 pins</li>
<li>LGA1151 (64-bit): 1151 pins<ul>
<li><del>è·ª CPU çš„æ¢—</del></li>
<li>è¿™äº›æŒ‡ä»¤æ˜¯å¦‚ä½•æ§åˆ¶é‚£ä¹ˆå¤š I/O è®¾å¤‡çš„ï¼Ÿ</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io">æ€»çº¿ï¼šä¸€ä¸ªç‰¹æ®Šçš„ I/O è®¾å¤‡</h2>
<blockquote>
<p>æä¾› â€œ<span class="red">å¦ä¸€ä¸ªåœ°å€ç©ºé—´</span>â€ å’Œåœ°å€ç©ºé—´ä¸Šçš„è®¾å¤‡è®¿é—®</p>
<ul>
<li>æŠŠæ”¶åˆ°çš„åœ°å€ (æ€»çº¿åœ°å€) å’Œæ•°æ®è¿›è¡Œè½¬å‘</li>
<li>ä¾‹å­: port I/O çš„ç«¯å£å°±æ˜¯æ€»çº¿ä¸Šçš„åœ°å€<ul>
<li>IBM PC çš„ CPU å…¶å®åªçœ‹åˆ°è¿™ä¸€ä¸ª I/O è®¾å¤‡</li>
</ul>
</li>
</ul>
</blockquote>
<div class="fragment">
<p>è¿™æ · CPU åªéœ€è¦ç›´è¿ä¸€ä¸ªæ€»çº¿ (ä¾‹å¦‚ä»Šå¤©æ˜¯ PCI) å°±è¡Œäº†</p>
<ul>
<li>æ€»çº¿å¯ä»¥æ¡¥æ¥å…¶ä»–æ€»çº¿ (ä¾‹å¦‚ PCI â†’ USB)</li>
<li><code>lspci -tv</code> å’Œ <code>lsusb -tv</code>: æŸ¥çœ‹ç³»ç»Ÿä¸­æ€»çº¿ä¸Šçš„è®¾å¤‡<ul>
<li>æ¦‚å¿µç®€å•ï¼Œå®é™…éå¸¸å¤æ‚â€¦â€¦<ul>
<li>ç”µæ°”ç‰¹æ€§</li>
<li>burst ä¼ è¾“</li>
<li>ä¸­æ–­</li>
<li>DMA (ä¸éœ€è¦ CPU å‚ä¸çš„æ•°æ®å¤åˆ¶)</li>
<li>çƒ­æ’æ‹” (plug-and-play)</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="pci-device-probe">ä¾‹å­ï¼šPCI Device Probe</h2>
<p><a href="../static/wiki/os/2020/demos/pci-probe.c">pci-probe.c</a> (AbstractMachine, x86-64/i386)</p>
<ul>
<li>è¯•ç€ç»™ QEMU å¢åŠ  <code>-soundhw ac97</code> çš„è¿è¡Œé€‰é¡¹</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pciconf_read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kt">uint16_t</span> <span class="n">id</span>   <span class="o">=</span> <span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">vendor</span> <span class="o">=</span> <span class="n">info</span> <span class="o">&</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%02d:%02d device %x by vendor %x"</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">vendor</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x100e</span> <span class="o">&&</span> <span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x8086</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">" &lt;-- This is an Intel e1000 NIC card!"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="5-dma">ä¾‹å­ (5): DMA</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸­æ–­æ²¡èƒ½è§£çš„é—®é¢˜</h2>
<p>å‡è®¾ç¨‹åºå¸Œæœ›å†™å…¥ 1GiB çš„æ•°æ®åˆ°ç£ç›˜</p>
<ul>
<li>å³ä¾¿ç£ç›˜å·²ç»å‡†å¤‡å¥½ï¼Œä¾ç„¶éœ€è¦éå¸¸æµªè´¹ç¼“æ…¢çš„å¾ªç¯</li>
<li>out æŒ‡ä»¤å†™å…¥çš„æ˜¯è®¾å¤‡ç¼“å†²åŒºï¼Œéœ€è¦å»<span class="red">æ€»çº¿</span>ä¸Šç»•ä¸€åœˆ<ul>
<li>cache disable; store å…¶å®å¾ˆæ…¢çš„</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="n">GiB</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">outl</span><span class="p">(</span><span class="n">PORT</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>

<blockquote>
<p>èƒ½ä¸èƒ½è®¾è®¡ä¸€ä¸ª I/O è®¾å¤‡æ¥å®Œæˆè®¾å¤‡å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Ÿ</p>
</blockquote>
<p>å¥½åƒ <code>memcpy_to_port(ATA0, buf, length);</code></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="direct-memory-access-dma">Direct Memory Access (DMA)</h2>
<p>DMA: åœ¨ç³»ç»Ÿé‡Œå¢åŠ ä¸€ä¸ªæ–°çš„ CPU, ä¸“é—¨æ‰§è¡Œ â€œ<code>memcpy</code>â€ ç¨‹åº</p>
<ul>
<li>ä¸è§‰å¾—ç”¨é€šç”¨å¤„ç†å™¨å®ç°å®ƒå¤ªæµªè´¹äº†ï¼Ÿ<ul>
<li>å®é™…å®ç°ï¼šç›´æ¥æŠŠ DMA æ§åˆ¶å™¨è¿æ¥åœ¨æ€»çº¿å’Œå†…å­˜ä¸Š</li>
<li>(PCI æ€»çº¿è‡ªå¸¦ DMA)</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">enum</span> <span class="n">dma_mtype</span> <span class="p">{</span> <span class="n">DMA_MEMORY</span><span class="p">,</span> <span class="n">DMA_MMIO</span><span class="p">,</span> <span class="n">DMA_PIO</span><span class="p">,</span> <span class="n">DMA_PCIE</span> <span class="p">};</span>
<span class="k">struct</span> <span class="n">dma_rq</span> <span class="p">{</span>
  <span class="k">enum</span> <span class="n">dma_mtype</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">;</span>
  <span class="kt">uintptr_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">;</span>
  <span class="kt">uint8_t</span>   <span class="n">trunk</span><span class="p">[</span><span class="n">TRUNK_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">dma_processor</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wait_for_rq</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uintptr_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">chunk_size</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dma_load</span> <span class="p">(</span><span class="o">&</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">dma_store</span><span class="p">(</span><span class="o">&</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">trunk</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">raise_interrupt</span><span class="p">(</span><span class="n">IRQ_DMA</span><span class="p">);</span> <span class="c1">// inter-processor interrupt</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="dma">DMA: å†…å­˜ä¸€è‡´æ€§</h2>
<p>è¿˜è®°å¾— â€œå¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒâ€ å—ï¼Ÿ</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">do_dma</span><span class="p">(...)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_rq</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
  <span class="n">notify_dma_device</span><span class="p">();</span> <span class="c1">// DMA æ˜¯å¦çœ‹åˆ°å†™å…¥ buf çš„æ•°æ®ï¼Ÿ</span>
<span class="p">}</span>
</pre></div>


<p>å¦‚æœä½ çŸ¥é“ä¸€äº› CPU å†…éƒ¨çš„å·¥ä½œåŸç†ï¼Œä¸€å®šä¼šè§‰å¾— â€œè¿™äº‹ä¸ç®€å•â€</p>
<ul>
<li><code>movl $1, (x)</code> â†’ store buffer â†’ L1 cache (write back) â†’ L2 cache (write back) â†’ L3 cache (write back)<ul>
<li>DMA å¦‚æœç›´æ¥è®¿é—®å†…å­˜ï¼Œå²‚ä¸æ˜¯æ ¹æœ¬æ— æ³•å’Œ CPU äº¤æµäº†ï¼Ÿ</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="dma-contd">DMA: å†…å­˜ä¸€è‡´æ€§ (cont'd)</h2>
<p>ç¡¬ä»¶ç»´æŠ¤ä¸€è‡´æ€§</p>
<ul>
<li>æ‰€ä»¥çŸ¥é“ä¸ºä»€ä¹ˆ CPU è¦å¸¦ PCIe lanes äº†å§</li>
<li>cache é‡Œçš„çƒ­æ•°æ®å¯ä»¥ç›´æ¥è¿› DMA!</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/Z390.png" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="dma-contd">DMA: å†…å­˜ä¸€è‡´æ€§ (cont'd)</h2>
<p>è½¯ä»¶/ç¡¬ä»¶å…±åŒç»´æŠ¤ä¸€è‡´æ€§</p>
<ul>
<li>Linux: <code>dma_alloc_coherent()</code></li>
<li>Windows: <code>KeFlushIoBuffers()</code></li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/DMA-coherence.png" width="600px"></img></p></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="6-gpu">ä¾‹å­ (6): GPU</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="gpu-io">GPU: æ—¢æ˜¯ I/O è®¾å¤‡ï¼Œä¹Ÿæ˜¯å¤„ç†å™¨</h2>
<p>GPU çš„åŠŸèƒ½å®é™…æ˜¯æ‰§è¡Œå¤šå¤„ç†å™¨å¹¶è¡Œç¨‹åº (ä¾‹å¦‚ OpenGL, CUDA, ...)</p>
<ul>
<li>å°†æ‰§è¡Œç»“æœå†™å…¥å†…å­˜ (å’Œ/æˆ–è§†é¢‘è¾“å‡º)</li>
<li>nvcc: æŠŠ main ç¼–è¯‘/é“¾æ¥æˆ ELF; hello ç¼–è¯‘æˆ GPU æŒ‡ä»¤</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">__global__</span> 
<span class="kt">void</span> <span class="nf">hello</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">];</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Hello "</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&</span><span class="n">ad</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span> <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&</span><span class="n">bd</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span> 

  <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span> <span class="c1">// DMA</span>
  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span> 

  <span class="n">dim3</span> <span class="n">dimBlock</span><span class="p">(</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
  <span class="n">dim3</span> <span class="n">dimGrid</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
  <span class="n">hello</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span> <span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span> <span class="c1">// åœ¨ GPU æ‰§è¡Œ</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span> <span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="p">...</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="gpu">GPU å’Œæ¸¸æˆæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h2>
<p>æˆ‘ä»¬å†™è¿‡ amgame äº†ï¼Œæ¸¸æˆä¸å°±æ˜¯ç”»ç‚¹ä¹ˆâ€¦â€¦</p>
<ul>
<li>ä½† CPU ç”»ä¸è¿‡æ¥å•Š<ul>
<li>4K 60fps: 497,664,000 pixel/s</li>
<li>å¤§å‹ 3D æ¸¸æˆçš„åœºæ™¯<ul>
<li>å‡ ç™¾ä¸‡ä¸ªå¤šè¾¹å½¢æè¿°å½¢çŠ¶, tessellation, å„ç§ shaders (ä¾‹å¦‚ <a href="https://zhuanlan.zhihu.com/p/41269520">ambient occlusion</a>), ...</li>
<li>æˆ‘ä»¬éœ€è¦è¶…é«˜æ€§èƒ½çš„å¹¶è¡Œå¤„ç†å™¨ (GPU)!</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/death-stranding.jpg" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="gpu">GPU çš„å†…éƒ¨æ„é€ </h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/turing-sm.jpg" width="350px"></img></p>
<p>éå¸¸å¤æ‚çš„å¼‚æ„å¤šå¤„ç†å™¨ç³»ç»Ÿ</p>
<ul>
<li>Nvidia RTX 2080 Ti: 68 SMs<ul>
<li>Streaming Multiprocessor<ul>
<li>INT32, FP32, Tensor/RT Cores</li>
<li>å¯ä»¥çœ‹æˆ 64 ä¸ª â€œCUDAâ€ cores</li>
</ul>
</li>
</ul>
</li>
<li>SM ä¹‹é—´æ˜¯ L2 Cache</li>
<li>æ¯ä¸ª core éƒ½åªåšå°‘é‡çš„äº‹æƒ…<ul>
<li>(å°±åƒ DMA)</li>
<li>å¯¹æ¯” CPU: æ›´ä½çš„åŠŸè€—ã€æ›´å¤šçš„æ•°é‡</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="gpu-rendering-pipeline">GPU å’Œ Rendering Pipeline</h2>
<p><span class="center"><img src="../static/wiki/os/2019/img/gpu-1.png" width="800px"></img></span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="rendering-pipeline">Rendering Pipeline å’Œæ¸¸æˆçš„å…³ç³»ï¼Ÿ</h2>
<p>åœ¨åŸå§‹å›¾å½¢ä¸Šåš<span class="red">åƒç´ çº§</span>çš„ä¿®æ”¹å°±å¯ä»¥å®ç°å‡ ä¹ä»»ä½•è§†è§‰æ•ˆæœ</p>
<ul>
<li>æ›´ä½•å†µ 3D æ¸¸æˆæœ‰å‡†ç¡®çš„æ¨¡å‹ã€å…‰æºã€æè´¨ç­‰ä¿¡æ¯</li>
<li>é‚£äº›ç‚«é…·çš„ç”»é¢éƒ½æ˜¯ â€œè®¡ç®—å‡ºæ¥â€ éª—ä½ çš„ ğŸ˜‚</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/ps.jpg" width="500px"></img>
<img alt="" class="center" src="../static/wiki/os/2020/slides/img/before-after-ps.jpg" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="cpu-gpu">å°ç»“: CPU å’Œ GPU å¦‚ä½•ç»™æˆ‘ä»¬å¸¦æ¥å¿«ä¹ï¼Ÿ</h2>
<blockquote>
<p>æ¸¸æˆ (å¨±ä¹äº§ä¸š) é›†è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¹‹å¤§æˆ</p>
<ul>
<li>æ¸¸æˆ/ç¡¬ä»¶å‚å•†å‹¾ç»“ï¼Œæ›´å¥½çš„ç¡¬ä»¶ã€æ›´å¥½ç©çš„æ¸¸æˆ</li>
<li>å¤§å®¶èŠ± (ä¸ç®—å¤ªè´µçš„) é’±ä¹°å¿«ä¹ (<del>äº‘ç©å®¶è¡€èµš</del>)</li>
</ul>
</blockquote>
<p><span class="float-right"><img src="../static/wiki/os/2019/img/g-fat.gif" width="300px"></img></span></p>
<p>åœ¨æ¸¸æˆçš„æ¯ä¸€å¸§</p>
<ul>
<li>æ¸¸æˆå¼•æ“åœ¨ CPU ä¸­æ›´æ–°æ¸¸æˆé€»è¾‘<ul>
<li>UI å…ƒç´  â†’ <span class="blue">äººæœºäº¤äº’</span></li>
<li>ç©å®¶çš„çŠ¶æ€</li>
<li>æ€ªç‰©çš„ä½ç½®</li>
<li>AI çš„å†³ç­– â†’ <span class="blue">äººå·¥æ™ºèƒ½</span></li>
</ul>
</li>
<li>CPU å‡†å¤‡å¥½ä»£ç å’Œæ•°æ®ç»™ GPU â†’ <span class="blue">ä½“ç³»ç»“æ„</span><ul>
<li>cudaMemcpy, ... â†’ <span class="blue">è®¡ç®—æœºç³»ç»Ÿ</span></li>
<li>é€šçŸ¥æ˜¾ç¤ºæ§åˆ¶å™¨æ¸²æŸ“ <code>render&lt;&lt;&lt;dim1,dim2&gt;&gt;&gt;(...)</code> â†’ <span class="blue">ç¼–è¯‘å™¨/PL</span></li>
<li>rendering pipeline â†’ <span class="blue">è®¡ç®—æœºå›¾å½¢å­¦</span></li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>I/O è®¾å¤‡ä¸é©±åŠ¨</p>
<ul>
<li>3 ä¸ªç®€å•è®¾å¤‡çš„ä¾‹å­<ul>
<li>é”®ç›˜ã€ç£ç›˜, PIC</li>
</ul>
</li>
<li>3 ä¸ªå¤æ‚è®¾å¤‡çš„ä¾‹å­<ul>
<li>æ€»çº¿, DMA, GPU</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜</p>
<ul>
<li>æ ¹æ® lecture notes é˜…è¯»æ•™ç§‘ä¹¦ç›¸åº”éƒ¨åˆ†</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>