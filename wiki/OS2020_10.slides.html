<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>è™šæ‹ŸåŒ–ï¼šå¤„ç†å™¨è°ƒåº¦</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è™šæ‹ŸåŒ–ï¼šå¤„ç†å™¨è°ƒåº¦</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•åœ¨çº¿ç¨‹/è¿›ç¨‹ä¹‹é—´åˆ‡æ¢ (åˆ†æ—¶è™šæ‹ŸåŒ–å¤„ç†å™¨)</p>
<ul>
<li>è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜<ul>
<li>ç³»ç»Ÿé‡Œæœ‰å¾ˆå¤šè¿›ç¨‹</li>
<li>ä¸‹æ¬¡ä¸­æ–­ååº”è¯¥è®©å“ªä¸ªåœ¨å¤„ç†å™¨ä¸Šè¿è¡Œï¼Ÿ<ul>
<li>è¿˜è®°å¾— <a href="../static/wiki/os/2020/demos/trivial-os.c">trivial-os.c</a> æ˜¯æ€ä¹ˆåšå¾—å—ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>å¤„ç†å™¨è°ƒåº¦</p>
<ul>
<li>å¤„ç†å™¨è°ƒåº¦é—®é¢˜</li>
<li>å•å¤„ç†å™¨åˆ†æ—¶è°ƒåº¦</li>
<li>å¤šå¤„ç†å™¨è°ƒåº¦</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å¤„ç†å™¨è°ƒåº¦</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸€ä¸ªæ‰¹å¤„ç†ç³»ç»Ÿæ—¶ä»£å°±æœ‰çš„å¤è€é—®é¢˜</h2>
<p>æœ‰ <math class="inline-math">n</math> ä¸ªä»»åŠ¡ï¼Œåˆ†åˆ«éœ€è¦ <math class="inline-math">t_1, t_2, \ldots, t_n</math> æ—¶é—´å®Œæˆ</p>
<ul>
<li>ä»»åŠ¡ä¸€æ—¦å¼€å§‹å°±è¦å®Œæˆåˆ°ç»“æŸ (æ‰¹å¤„ç†)</li>
<li>æŒ‰ç…§ä»€ä¹ˆé¡ºåºå®Œæˆå®ƒä»¬æœ€å¥½ï¼Ÿ<ul>
<li>ä»¿ä½›è®¡ç®—ä¸­å¿ƒå‰ä¸€å¤©æ¥æ”¶ä»£ç ï¼Œç¬¬äºŒå¤©è¿è¡Œç»™å‡ºç»“æœ</li>
</ul>
</li>
</ul>
<div class="fragment">
<blockquote>
<p>ä¸»è¦é—®é¢˜ï¼šä»€ä¹ˆæ˜¯ â€œå¥½â€ï¼Ÿ</p>
<ul>
<li><del>é¢†å¯¼çš„ä»»åŠ¡å…ˆå®Œæˆæ¯”è¾ƒå¥½</del> (æ¨¡å‹é‡Œæ²¡æœ‰è¿™ä¸€ç‚¹)</li>
<li>æœ€å°åŒ– cost: <span class="red">å¹³å‡å®Œæˆæ—¶é—´</span><ul>
<li>å°å­¦ç”Ÿéƒ½ä¼šåš (!)</li>
<li>Shortest Job First (SJF)</li>
</ul>
</li>
<li>â€¦â€¦</li>
</ul>
</blockquote>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ”¹å˜æˆ‘ä»¬çš„å‡è®¾</h2>
<p>ä»»åŠ¡å¯ä»¥åœ¨ä¸€å¤©ä¸­çš„ä»»æ„æ—¶åˆ»åˆ°è¾¾</p>
<ul>
<li>ä»»åŠ¡çš„ cost = å®Œæˆæ—¶é—´ - åˆ°è¾¾æ—¶é—´</li>
<li>å¦‚ä½•æœ€å°åŒ–æ‰€æœ‰ä»»åŠ¡çš„å¹³å‡ cost?</li>
</ul>
<div class="fragment">
<blockquote>
<p>åœ¨ä»»æ„æ—¶åˆ»ï¼Œå¦‚æœæœ‰ <math class="inline-math">k</math> ä¸ªä»»åŠ¡åœ¨ç­‰å¾…ï¼Œè¿™ä¸ªæ—¶åˆ»å°±è¦ä»˜å‡º <math class="inline-math">k</math> çš„ cost</p>
<ul>
<li>æ‰€ä»¥åº”è¯¥ä»¥å‡å°‘ <math class="inline-math">k</math> ä¸ºæœ€ä¼˜å…ˆè€ƒè™‘<ul>
<li>è®©å½“å‰<span class="red">å‰©ä½™æ‰§è¡Œæ—¶é—´æœ€å°</span>çš„ä»»åŠ¡æ‰§è¡Œï¼</li>
<li>æ–°åˆ°çš„ short job ä¼š â€œæŠ¢å â€ å½“å‰ job æ‰§è¡Œ<ul>
<li>Shortest Time-to-Completion First (STCF)</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>ç®—æ³•é¢˜æ—¶é—´åˆ°æ­¤ç»“æŸ</p>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="1">å•å¤„ç†å™¨åˆ†æ—¶è°ƒåº¦ (1)</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸­æ–­/ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶ã€å¤„ç†å™¨è°ƒåº¦ç­–ç•¥</h2>
<blockquote>
<p>ä¸­æ–­ (æœºåˆ¶, mechanism: æä¾›ä»€ä¹ˆåŠŸèƒ½)</p>
</blockquote>
<ul>
<li>è¿›ç¨‹ä¸å†ç‹¬å å¤„ç†å™¨ç›´åˆ°è¿è¡Œå®Œæˆ</li>
<li>æ“ä½œç³»ç»Ÿä»£ç å¯ä»¥å®šæ—¶å¼ºåˆ¶å¾—åˆ°æ‰§è¡Œ<ul>
<li>ä¿å­˜å¯„å­˜å™¨ (ä¸Šä¸‹æ–‡) åˆ°å†…å­˜</li>
</ul>
</li>
</ul>
<hr></hr>
<blockquote>
<p>å¤„ç†å™¨è°ƒåº¦ (ç­–ç•¥, policy: å¦‚ä½•ä½¿ç”¨è¿™äº›åŠŸèƒ½)</p>
</blockquote>
<ul>
<li>ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šè¿›ç¨‹ç­‰å¾…æ‰§è¡Œ<ul>
<li>æ“ä½œç³»ç»Ÿä»£ç æ‰§è¡Œè°ƒåº¦ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹</li>
<li>ä½¿ç”¨ä¸­æ–­è¿”å›æœºåˆ¶è¿è¡Œä¸Šä¸‹æ–‡</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å•å¤„ç†å™¨åˆ†æ—¶è°ƒåº¦ï¼šåŸºæœ¬å‡è®¾</h2>
<blockquote>
<ol>
<li>è¿›ç¨‹æ˜¯ <code>while (1) do_sth()</code> çš„å¾ªç¯<ul>
<li>æ‰§è¡Œè®¡ç®—ï¼Œä½¿ç”¨ CPU</li>
<li>ç­‰å¾… I/O è¿”å›ï¼Œä¸ä½¿ç”¨ CPU (é€šå¸¸æ—¶é—´è¾ƒé•¿)</li>
</ul>
</li>
<li>å¤„ç†å™¨ä»¥å›ºå®šçš„é¢‘ç‡è¢«ä¸­æ–­</li>
<li>éšæ—¶å¯èƒ½æœ‰æ–°çš„è¿›ç¨‹è¢«åˆ›å»º/æ—§çš„è¿›ç¨‹é€€å‡º</li>
</ol>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="round-robin">ç­–ç•¥: Round-Robin</h2>
<p>å‡è®¾å½“å‰ <math class="inline-math">T_i</math> è¿è¡Œ</p>
<ul>
<li>ä¸­æ–­åè¯•å›¾åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçº¿ç¨‹ <math class="inline-math">T_{(i+1)\,\textrm{mod}\,n}</math></li>
<li>å¦‚æœä¸‹ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾… I/O è¿”å›ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª<ul>
<li>å¦‚æœç³»ç»Ÿæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¸éœ€è¦ CPUï¼Œå°±è°ƒåº¦ idle è¿›ç¨‹æ‰§è¡Œ</li>
<li>æ‰§è¡Œ <code>hlt</code> æŒ‡ä»¤è¿›å…¥ä½åŠŸè€—æ¨¡å¼ç­‰å¾…ä¸­æ–­</li>
</ul>
</li>
</ul>
<hr></hr>
<p>æˆ‘ä»¬çš„ <a href="../static/wiki/os/2020/demos/thread-os.c">thread-os.c</a> å®é™…ä¸Šå®ç°äº† Round-Robin çš„è°ƒåº¦å™¨</p>
<ul>
<li>ä¸­æ–­ä¹‹é—´çš„è¿›ç¨‹æ‰§è¡Œç§°ä¸º â€œæ—¶é—´ç‰‡â€ (time-slicing)</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/sched-rr.png" width="650px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç­–ç•¥ï¼šå¼•å…¥ä¼˜å…ˆçº§</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/haorenka.jpg" width="250px"></img></p>
<p>UNIX niceness</p>
<ul>
<li>-20 .. 19<ul>
<li>è¶Š niceï¼Œè¶Šè¢«ä¸ nice çš„äººæŠ¢å </li>
<li>-20: æå; most favorable to the process</li>
<li>19: æå¥½; least favorable to the process</li>
<li><del>å¥½äººæµä¸‹äº†æ‚”æ¨çš„æ³ªæ°´</del></li>
</ul>
</li>
<li>nice ç›¸å·® 10, CPU è·å¾—ç›¸å·® 10 å€<ul>
<li>nice ç›¸å·® 1 å¤§çº¦ç›¸å·® 1.25 å€</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/unix-nice.jpg" width="750px"></img></p>
<ul>
<li>ä¸å¦¨è¯•ä¸€è¯•: nice/renice</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="mlfq">ç­–ç•¥ï¼šå¤šçº§åé¦ˆè°ƒåº¦ (MLFQ)</h2>
<blockquote>
<p>å‡è®¾ï¼šç³»ç»Ÿé‡Œæœ‰ä¸¤ç§è¿›ç¨‹</p>
<ul>
<li>äº¤äº’è¿›ç¨‹ (vi, vscode, ...), å¤§éƒ¨åˆ†æ—¶å€™åœ¨ç­‰å¾…<ul>
<li>ä¼˜å…ˆè°ƒåº¦å®ƒä»¬èƒ½æå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘å¡é¡¿ (è¯•æƒ³ Round-Robin)</li>
</ul>
</li>
<li>è®¡ç®—è¿›ç¨‹ (gcc, ld, ...), åœ¨å¤„ç†å™¨ç©ºé—²æ—¶æ‰æ‰§è¡Œ</li>
</ul>
</blockquote>
<div class="fragment">
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/MLFQ.png" width="400px"></img></p>
<p>è®¾ç½®è‹¥å¹²ä¸ª Round-Robin é˜Ÿåˆ—</p>
<ul>
<li>æ¯ä¸ªé˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªä¼˜å…ˆçº§</li>
</ul>
<p>è°ƒåº¦ç­–ç•¥</p>
<ul>
<li>ä¼˜å…ˆè°ƒåº¦é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—</li>
<li>ç”¨å®Œæ—¶é—´ç‰‡ (è¢«ä¸­æ–­) â†’ ?</li>
<li>ä¸»åŠ¨è®©å‡º CPU ç­‰å¾… I/O â†’ ?<ul>
<li>å¾ˆç›´è§‚ä¹Ÿå¾ˆæœ‰è¶£ï¼Œè¯·é˜…è¯»æ•™ç§‘ä¹¦</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="complete-fair-scheduling-cfs">Complete Fair Scheduling (CFS)</h2>
<blockquote>
<p>è¯•å›¾å»æ¨¡æ‹Ÿä¸€ä¸ª â€œIdeal Multi-Tasking CPUâ€: </p>
<ul>
<li>â€œIdeal multi-tasking CPUâ€ is a (non-existent :-)) CPU that has 100% physical power and which can run each task at precise equal speed, in parallel, each at <math>1/n</math>. For example: if there are 2 tasks running, then it runs each at 50% physical power â€” i.e., actually in parallel.</li>
</ul>
</blockquote>
<p>è®©ç³»ç»Ÿé‡Œçš„æ‰€æœ‰è¿›ç¨‹å°½å¯èƒ½å…¬å¹³åœ°å…±äº«å¤„ç†å™¨</p>
<ul>
<li>è®°å½•ç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹çš„ç²¾ç¡®è¿è¡Œæ—¶é—´ (vruntime, nanoseconds)</li>
<li>ä¸­æ–­å‘ç”Ÿåï¼Œåˆ‡æ¢åˆ° vruntime æœ€å°‘çš„è¿›ç¨‹æ‰§è¡Œ<ul>
<li>ä¸‹æ¬¡ä¸­æ–­åï¼Œå½“å‰è¿›ç¨‹çš„ vruntime å¯èƒ½å°±ä¸æ˜¯æœ€å°çš„äº†</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="complete-fair-scheduling-contd">Complete Fair Scheduling (cont'd)</h2>
<blockquote>
<p>å¤æ‚çš„æƒ…å†µ (1): åˆ›å»ºæ–°è¿›ç¨‹/çº¿ç¨‹</p>
<ul>
<li>å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ vruntime</li>
</ul>
</blockquote>
<pre class="codehilite"><code class="language-c">static void task_fork_fair(struct task_struct *p) {
  struct sched_entity *se = &p-&gt;se, *curr;
  ...
  rq_lock(rq, &rf);
  update_rq_clock(rq);
  cfs_rq = task_cfs_rq(current);
  curr = cfs_rq-&gt;curr;
  if (curr) {
    update_curr(cfs_rq);
    se-&gt;vruntime = curr-&gt;vruntime; // ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ vruntime
  }
  place_entity(cfs_rq, se, 1);
  ...</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="complete-fair-scheduling-contd">Complete Fair Scheduling (cont'd)</h2>
<blockquote>
<p>å¤æ‚çš„æƒ…å†µ (2): I/O</p>
<ul>
<li>I/O (ä¾‹å¦‚ 1 åˆ†é’Ÿ) ä»¥åå›æ¥ vruntime ä¸¥é‡è½å</li>
<li>ä¸ºäº†èµ¶ä¸Šï¼ŒCPU ä¼šå…¨éƒ¨å½’å®ƒæ‰€æœ‰</li>
</ul>
</blockquote>
<p>è§£å†³ï¼šå”¤é†’çš„çº¿ç¨‹</p>
<ul>
<li>è·å¾— â€œæœ€å°â€ çš„ vruntime (å¯ä»¥ç«‹å³è¢«æ‰§è¡Œ)</li>
</ul>
<pre class="codehilite"><code class="language-c">if (renorm && curr)
  se-&gt;vruntime += cfs_rq-&gt;min_vruntime;</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="complete-fair-scheduling-contd">Complete Fair Scheduling (cont'd)</h2>
<blockquote>
<p>å®ç°ä¼˜å…ˆçº§</p>
<ul>
<li>è®©å¥½äººçš„æ—¶é—´å˜å¾—å¿«ä¸€äº›ï¼Œåäººçš„æ—¶é—´å˜å¾—æ…¢ä¸€äº›â€¦â€¦</li>
<li>vrt[i] / vrt[j] çš„å¢åŠ æ¯”ä¾‹ = wt[j] / wt[i]</li>
</ul>
</blockquote>
<pre class="codehilite"><code class="language-c">const int sched_prio_to_weight[40] = {
  /* -20 */ 88761, 71755, 56483, 46273, 36291,
  /* -15 */ 29154, 23254, 18705, 14949, 11916,
  /* -10 */  9548,  7620,  6100,  4904,  3906,
  /*  -5 */  3121,  2501,  1991,  1586,  1277,
  /*   0 */  1024,   820,   655,   526,   423,
  /*   5 */   335,   272,   215,   172,   137,
  /*  10 */   110,    87,    70,    56,    45,
  /*  15 */    36,    29,    23,    18,    15,
};</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="complete-fair-scheduling">Complete Fair Scheduling: å®ç°</h2>
<blockquote>
<p>æ€è€ƒé¢˜ï¼šç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ç»´æŠ¤æ‰€æœ‰è¿›ç¨‹çš„ vruntime?</p>
</blockquote>
<p>æˆ‘ä»¬éœ€è¦ä»€ä¹ˆæ“ä½œ</p>
<div class="fragment">
<ul>
<li>ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤æ˜ å°„ <math class="inline-math">t \mapsto vt(t)</math><ul>
<li>ç»´æŠ¤è¿›ç¨‹çš„ vruntime <math class="inline-math">vt(t) \leftarrow vt(t) + \Delta_t / w</math></li>
<li>æ‰¾åˆ° <math class="inline-math">t</math> æ»¡è¶³ <math class="inline-math">vt(t)</math> æœ€å°</li>
<li>è¿›ç¨‹åˆ›å»º/é€€å‡º/ç¡çœ /å”¤é†’æ—¶æ’å…¥/åˆ é™¤ <math class="inline-math">t</math></li>
</ul>
</li>
</ul>
</div>
<div class="fragment">
<p>åˆæ˜¯æœ‰åºé›†åˆï¼ä¸Šä¸€ä¸ªè§åˆ°çš„æœ‰åºé›†åˆï¼šåœ°å€ç©ºé—´ä¸­çš„å†…å­˜æ˜ å°„</p>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/rbtree.svg" width="500px"></img></p>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸€ä¸ªå°ç»†èŠ‚ï¼šæ•´æ•°æº¢å‡º</h2>
<p>64-bit æ— ç¬¦å·æ•´æ•°å¦‚æœå­˜å‚¨ä»¥çº³ç§’ä¸ºå•ä½çš„æ—¶é—´</p>
<ul>
<li><math>2^{64} / 10^9 / 3600 / 24 / 365 = 584.9</math> (å¹´)</li>
<li>å‡å¦‚çœŸçš„æœ‰è¿è¡Œçš„é‚£ä¹ˆä¹…çš„ç³»ç»Ÿâ€¦â€¦</li>
</ul>
<div class="fragment">
<blockquote>
<p>åŸºæœ¬å‡è®¾ï¼šç³»ç»Ÿçš„æ‰€æœ‰æ—¶é—´éƒ½æ˜¯ç›¸å¯¹ â€œæœ€è¿‘â€ çš„</p>
<ul>
<li>signed integer overflow â†’ UB<ul>
<li>ä½† unsigned integer overflow ä¿è¯ wrap-around</li>
</ul>
</li>
<li>å§‹ç»ˆä½¿ç”¨ time-delta çš„æ­£è´Ÿæ¥åˆ¤å®šå¤§å°</li>
</ul>
</blockquote>
<pre class="codehilite"><code class="language-c">static inline u64 min_vruntime(u64 min_vruntime, u64 vruntime) {
  s64 delta = (s64)(vruntime - min_vruntime);
  if (delta &lt; 0) min_vruntime = vruntime;
  return min_vruntime;
}

static inline int entity_before(struct sched_entity *a,
                                struct sched_entity *b) {
  return (s64)(a-&gt;vruntime - b-&gt;vruntime) &lt; 0;
}</code></pre>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="2">å•å¤„ç†å™¨åˆ†æ—¶è°ƒåº¦ (2)</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io">å®é™…æƒ…å†µï¼šä¸æ­¢æ˜¯è®¡ç®—å’Œ I/O</h2>
<blockquote>
<p>è°ƒåº¦ç­–ç•¥çš„å¤æ‚æ€§æ¥æº</p>
<ul>
<li>å› ä¸ºçº¿ç¨‹ä¸æ˜¯ <code>while (1)</code> çš„å¾ªç¯</li>
<li>è¿›ç¨‹/çº¿ç¨‹ä¸æ˜¯çº¯ç²¹çš„è®¡ç®—æˆ– (é•¿æ—¶é—´) I/O<ul>
<li><span class="red">ç­‰å¾…äº’æ–¥é”/ä¿¡å·é‡</span></li>
<li>æˆ–æ˜¯éå¸¸çŸ­æš‚çš„ I/O ç­‰å¾… (æ¯”ä¸€ä¸ªæ—¶é—´ç‰‡çŸ­å¾ˆå¤š)</li>
</ul>
</li>
</ul>
</blockquote>
<div class="fragment">
<p>åœ¨æ­¤æƒ…å½¢ä¸‹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>round-robin?<ul>
<li>è€ƒè™‘ä¸‰ä¸ªè¿›ç¨‹/çº¿ç¨‹: producer, consumer, <code>while (1)</code></li>
<li>Lab 2 ä½ ä»¬å°±ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜äº†<ul>
<li>ä¸»è¦æ˜¯å› ä¸ºæ²¡æœ‰ç²¾ç¡®çš„æ—¶é—´ç»Ÿè®¡</li>
</ul>
</li>
</ul>
</li>
<li>CFS?<ul>
<li>ä¼¼ä¹æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼šçº¿ç¨‹æœ‰ç²¾ç¡®çš„ accounting ä¿¡æ¯<ul>
<li>producer/consumer è¢«å”¤é†’åä¼šæ­£ç¡®åˆ†äº« CPU</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="so-far-so-good">So Far, So Good...</h2>
<p>è¿›ç¨‹/çº¿ç¨‹å…¬å¹³åœ°å…±äº« CPU</p>
<ul>
<li>æ”¯æŒç¡çœ ã€ç­‰å¾…ã€fork</li>
<li>åäººæœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œèƒ½æ›´å¤šåœ°è·å¾—è¢«æ‰§è¡Œçš„æœºä¼š</li>
</ul>
<div class="fragment">
<blockquote>
<p>å¹¶å‘ bugs è¿˜åœ¨ç­‰ç€å¤§å®¶å‘¢ï¼</p>
<ul>
<li>å¤„ç†å™¨è°ƒåº¦ä¸­æœ‰ä¸€ç±»éå¸¸æœ‰è¶£çš„å¹¶å‘ bug</li>
</ul>
</blockquote>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="priority-inversion">ä¼˜å…ˆçº§åè½¬ (Priority Inversion)</h2>
<pre class="codehilite"><code class="language-c">void bad_guy() { // é«˜ä¼˜å…ˆçº§
  while (1) {
    mutex_lock(&lk);
    ...
    mutex_unlock(&lk);
  }
}

void nice_guy() { // ä¸­ä¼˜å…ˆçº§
  while (1) ;
}

void very_nice_guy() { // æœ€ä½ä¼˜å…ˆçº§
  while (1) {
    mutex_lock(&lk);
    ...
    mutex_unlock(&lk);
  }
}</code></pre>


<ul>
<li>very nice guy åœ¨æŒæœ‰é”çš„æ—¶å€™è®©å‡ºäº†å¤„ç†å™¨â€¦â€¦<ul>
<li>bad guy é¡ºä¾¿ä¹Ÿæ— æ³•è¿è¡Œäº† (nice guy æŠ¢åœ¨äº†å®ƒå‰é¢ ğŸ‘)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="the-first-bug-on-mars"><a href="https://news.ycombinator.com/item?id=13210478">The First Bug on Mars</a></h2>
<blockquote>
<p>Sojourner â€œæ¢è·¯è€…å·â€ (PathFinder), 1997 å¹´ 7 æœˆ 4 æ—¥ç€é™†</p>
<ul>
<li>å¤§å®¶å‡ºç”Ÿå‰å‘ç”Ÿçš„äº‹æƒ…ï¼Œä½†æˆ‘ä¾ç„¶æœ‰å°è±¡</li>
<li>ç€é™†å‡ å¤©åï¼Œå‡ºç°ç³»ç»Ÿé‡å¯å’Œæ•°æ®ä¸¢å¤±</li>
</ul>
</blockquote>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/PATHCOV.jpg" width="300px"></img>
ç¡¬ä»¶é…ç½®</p>
<ul>
<li>Lander: IBM RISC 6000 Single Chip (Rad6000 SC) 20 MIPS CPU, 128 MiB RAM, 6 MiB EEPROM<ul>
<li>æ“ä½œç³»ç»Ÿ: VxWorks å®æ—¶æ“ä½œç³»ç»Ÿ<ul>
<li>å®æ—¶ï¼šä»»åŠ¡å¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…å®Œæˆ</li>
<li>ASI/MET task: å¤§æ°”æˆåˆ†ç›‘æµ‹ (ä½ä¼˜å…ˆçº§)</li>
<li><code>bc_dist</code> task: åˆ†å‘ä»»åŠ¡ (ä¸­ä¼˜å…ˆçº§)</li>
<li><code>bc_sched</code> task: æ€»çº¿è°ƒåº¦ (é«˜ä¼˜å…ˆçº§)</li>
</ul>
</li>
</ul>
</li>
<li>Rover: 0.1 MIPS Intel 80C85 CPU, 512 KiB RAM, 176 KiB Flash SSD</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="the-first-bug-on-mars-contd">The First Bug on Mars (cont'd)</h2>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/marsbot.png" width="750px"></img></p>
<ul>
<li>(ä½ä¼˜å…ˆçº§) <code>select -&gt; pipeIoctl -&gt; selNodeAdd -&gt; mutex_lock</code></li>
<li>(é«˜ä¼˜å…ˆçº§) <code>pipeWrite -&gt; mutex_lock</code></li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¼˜å…ˆçº§åè½¬ï¼šä¿®å¤</h2>
<blockquote>
<p>éå®æ—¶ç³»ç»Ÿï¼šCFS åŸºæœ¬æ»¡è¶³è¦æ±‚</p>
<ul>
<li>ä½ä¼˜å…ˆçº§è¿›ç¨‹ä¹Ÿèƒ½è·å¾—æ—¶é—´æ‰§è¡Œ</li>
<li>ä¸€æ—¦é‡Šæ”¾é”ï¼Œé«˜ä¼˜å…ˆçº§è¿›ç¨‹å°±èƒ½æ‰§è¡Œäº†</li>
</ul>
<p>å®æ—¶ç³»ç»Ÿï¼šå¦‚ä½•è§£å†³ï¼Ÿ</p>
</blockquote>
<ul>
<li>ä¼˜å…ˆçº§ç»§æ‰¿ (Priority Inheritance)/ä¼˜å…ˆçº§æå‡ (Priority Ceiling)<ul>
<li>æŒæœ‰ mutex çš„çº¿ç¨‹/è¿›ç¨‹ä¼šç»§æ‰¿ block åœ¨è¯¥ mutex ä¸Šçš„æœ€é«˜ä¼˜å…ˆçº§</li>
<li>ä¸æ€»æ˜¯èƒ½ work (ä¾‹å¦‚æ¡ä»¶å˜é‡å”¤é†’)</li>
</ul>
</li>
</ul>
<div class="fragment">
<ul>
<li>åœ¨ç³»ç»Ÿä¸­åŠ¨æ€ç»´æŠ¤èµ„æºä¾èµ–å…³ç³»<ul>
<li>ä¼˜å…ˆçº§ç»§æ‰¿æ˜¯å®ƒçš„ç‰¹ä¾‹</li>
<li>ä¼¼ä¹æ›´å›°éš¾äº†â€¦â€¦</li>
</ul>
</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>é¿å…é«˜/ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡äº‰æŠ¢èµ„æº<ul>
<li>å¯¹æ½œåœ¨çš„ä¼˜å…ˆçº§åè½¬è¿›è¡Œé¢„è­¦ (lockdep)</li>
<li>TX-based: å†²çªçš„ TX å‘ç”Ÿæ—¶ï¼Œæ€»æ˜¯ä½ä¼˜å…ˆçº§çš„ abort</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å¤šå¤„ç†å™¨è°ƒåº¦</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å¤šå¤„ç†å™¨è°ƒåº¦</h2>
<blockquote>
<p>è°ƒåº¦ç­–ç•¥çš„å¤æ‚æ€§æ¥æº</p>
<ul>
<li>å› ä¸ºç³»ç»Ÿä¸­æœ‰å¤šä¸ªå¤„ç†å™¨</li>
<li><span class="red">è¿›ç¨‹åœ¨å¤„ç†å™¨é—´è¿ç§»å¯¹ç¼“å­˜éå¸¸ä¸å‹å¥½</span></li>
</ul>
</blockquote>
<p>Trade-offs</p>
<ul>
<li>ä¸è¿ç§»å§ï¼šå¤„ç†å™¨ workload ä¸å¹³è¡¡</li>
<li>è¿ç§»å§ï¼šä»˜å‡ºä¸€äº›éš¾ä»¥ä¼°è®¡çš„æˆæœ¬</li>
</ul>
<hr></hr>
<p>æœ¬è´¨ (ä¹Ÿæ˜¯å›°éš¾): å¯¹ç³»ç»Ÿæœªæ¥çš„è¡Œä¸ºè¿›è¡Œé¢„æµ‹</p>
<ul>
<li>é€šå¸¸å‡è®¾ç³»ç»Ÿ workload çŸ­æ—¶é—´ä¸ä¼šå˜åŒ–<ul>
<li>å®šæ—¶çš„ load balancing (Linux Kernel)</li>
</ul>
</li>
<li>ä½†è¿™æ˜æ˜¾ä¸å¯¹å•Š<ul>
<li>çº¿ç¨‹å°‘ã€åŒæ­¥å¤šçš„æ—¶å€™<ul>
<li>load balance é¢‘ç‡ä¸è¶³, â€œä¸€æ ¸å‡ºåŠ›ï¼Œä»–äººå›´è§‚â€</li>
<li>ä¸è¦ç¬‘ï¼Œä½ ä»¬çš„ Lab2 ä¹Ÿä¼š</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="contd">å¤šå¤„ç†å™¨è°ƒåº¦ (cont'd)</h2>
<blockquote>
<p>â€œAnd you have to realize that there are not very many things that have aged as well as the scheduler. Which is just another proof that scheduling is easy.â€<span class="float-right">â€”â€”Linus Torvalds, 2001</span></p>
</blockquote>
<div class="fragment">
<p>çœŸä»¥ä¸ºè°ƒåº¦æ˜¯ä¸ªæŒºç®€å•çš„é—®é¢˜ï¼Ÿ</p>
<ul>
<li>As a central part of resource management, the OS thread scheduler must maintain the following, simple, invariant: make sure that ready threads are scheduled on available cores.</li>
<li>As simple as it may seem, we found that this invariant is often broken in Linux. Cores may stay idle for seconds while ready threads are waiting in runqueues.<ul>
<li>J. Lozi, et al. <a href="https://dl.acm.org/doi/10.1145/2901318.2901326">The Linux scheduler: A decade of wasted cores</a>. In <em>Proc. of EuroSys</em>, 2016. </li>
<li>å¤šå¤„ç†å™¨è°ƒåº¦ä¾ç„¶æ˜¯ open problem</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ•°æ®ä¸­å¿ƒçš„å¤šå¤„ç†å™¨è°ƒåº¦</h2>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/data-center.jpg" width="500px"></img></p>
<p>é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ (æœç´¢ã€è´­ç‰©è½¦ã€â€¦â€¦) â†’ è´¨é‡å¿…é¡»å¾—åˆ°ä¿è¯</p>
<ul>
<li>Amazon: 100ms å»¶è¿Ÿ = å°‘å– 1% çš„è´§ç‰©<ul>
<li>æƒ³æƒ³æ·˜å®/äº¬ä¸œ/æ‹¼å¤šå¤š...çš„ 1% æ˜¯å¤šä¹ˆå¤©å¤§çš„æ•°é¢â€¦â€¦</li>
</ul>
</li>
</ul>
<p>ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ (ç´¢å¼•ã€è§†é¢‘è½¬ç ã€â€¦â€¦) â†’ å°½å¯èƒ½æŠŠæœåŠ¡å™¨å¡«æ»¡</p>
<ul>
<li>ä¼°è®¡ Google æœ‰ 2.5 million å°æœåŠ¡å™¨ (2016)<ul>
<li>æé«˜ 1% çš„åˆ©ç”¨ç‡éƒ½èŠ‚çº¦å·¨å¤§çš„æœºå™¨/èƒ½é‡</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ— ç©·å°çš„ nice å€¼ï¼Ÿ</p>
<ul>
<li><span class="red">ä¸ï¼Œæ²¡ç”¨</span>ã€‚å¹¶è¡Œçš„ä»»åŠ¡å¯èƒ½ä¼šå ç”¨ I/O, pollute cache/buffer, ...</li>
</ul>
</blockquote></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>å¤„ç†å™¨è°ƒåº¦</p>
<ul>
<li>æœºåˆ¶<ul>
<li>ä¸­æ–­/ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿›å…¥æ“ä½œç³»ç»Ÿä»£ç æ‰§è¡Œ</li>
<li>æ“ä½œç³»ç»Ÿä»£ç å¯ä»¥é€‰æ‹©ä»»ä½•ä¸€ä¸ªçº¿ç¨‹/è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</li>
<li><span class="red">è®¾è®¡ rock-solid çš„æœºåˆ¶ï¼Œæ”¯æŒä»»ä½•ç­–ç•¥</span></li>
</ul>
</li>
<li>ç­–ç•¥<ul>
<li>Round-Robin, MLFQ, CFS, ...</li>
<li><span class="red">æ ¹æ®å®é™…æƒ…å†µ (workload) å°è¯•å„ç§ç­–ç•¥</span></li>
</ul>
</li>
<li>çœŸå®ç³»ç»Ÿçš„å¤æ‚æ€§æ¥æº<ul>
<li>ä¼˜å…ˆçº§ã€ä¼˜å…ˆçº§åè½¬ã€å¤šå¤„ç†å™¨â€¦â€¦</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜</p>
<ul>
<li>é˜…è¯»: J. Bouron, et al. <a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf">The battle of the schedulers: FreeBSD ULE vs. Linux CFS</a>. In <em>Proc. of USENIX ATC</em>, 2018.</li>
<li>å¼€å§‹åš Lab2!</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>