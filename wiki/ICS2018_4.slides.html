<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/wiki.css"/>
<link rel="stylesheet" href="../static/css/slides.css"/>


    <title>æ•°æ®çš„æœºå™¨çº§è¡¨ç¤º</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: True
class: center, middle

# æ•°æ®çš„æœºå™¨çº§è¡¨ç¤º

è’‹ç‚å²© <jyy@nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# æ¦‚è¿°

æ•°æ®çš„æœºå™¨çº§è¡¨ç¤ºå¤ä¹ 

* æ•´æ•°ï¼šä½è¿ç®—
* æ‰©å±•çŸ¥è¯†ï¼šUndefined Behavior
* IEEE754 æµ®ç‚¹æ•°

---

class: center, middle

# æ•´æ•°ï¼šç¥å¥‡çš„ä½è¿ç®—

---

# ä¸ºä»€ä¹ˆä¼šæœ‰ä½è¿ç®—ï¼Ÿ

åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œä¸€ä¸ª`int`ç±»å‹æ˜¯ç‰©ç†ä¸–ç•Œä¸­..., -1, 0, 1, 2, â€¦çš„è¡¨ç¤º

ä½†è®¡ç®—æœºä¸–ç•Œï¼Œæ•´æ•°å…¶å®æ˜¯ç”¨.red[å›ºå®šé•¿åº¦çš„01å­—ç¬¦ä¸²]è¡¨ç¤ºçš„ (å›é¡¾æ•°å­—ç”µè·¯è¯¾)ï¼Œ01å­—ç¬¦ä¸²å¤©ç”Ÿæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

* `&` (ä¸), `|` (æˆ–), `~` (é)

* `^` (å¼‚æˆ–)

* `<<` (å·¦ç§»ä½), `>>` (å³ç§»ä½)

----

ä¹ é¢˜ï¼š.red[ç”¨ä¸Šè¿°ä½è¿ç®—å’Œå¸¸æ•°å®ç°4ä½æ•´æ•°çš„åŠ æ³•]è¿ç®—

* æç¤ºï¼šä½¿ç”¨æ•°å­—ç”µè·¯ä¸­çš„çŸ¥è¯†
* æœ‰åŠ æ³•å°±å¯ä»¥å®ç°ä¹˜æ³•ã€åˆ†æ”¯(`cond ? a : b`)ã€é™¤æ³•â€¦â€¦


---

# æŠŠæ•´æ•°çœ‹ä½œ01å­—ç¬¦ä¸²

`(uint32_t)142857` â†’ `0000 0000 0000 0010 0010 1110 0000 1001`

ä¸€ä¸ªæ•´æ•°å°±å¯ä»¥çœ‹æˆæ˜¯<math>\{0,1,2,\ldots,31\}</math>çš„ä¸€ä¸ª.red[å­é›†] <math>S</math>

------

ä¸€ä¸ªæ•´æ•°æ“ä½œå¯ä»¥å¹¶è¡Œå¯¹å…¶ä¸­çš„æ‰€æœ‰01æ¯”ç‰¹æ“ä½œ

- C++ä¸­æœ‰`bitset<size>`ï¼Œæ€§èƒ½éå¸¸å¯è§‚

----

C++ä¸­æœ‰`bitset<size>`ï¼Œæ€§èƒ½éå¸¸å¯è§‚

* æµ‹è¯•æ˜¯å¦<math>x\in S</math>ï¼š`(S >> x) & 1`
* æ±‚<math>S' = S\cup\{x\}</math>ï¼š`S | (1 << x)`
* .red[ä¹ é¢˜]ï¼šæ±‚<math>|S|,S_1 \cup S_2, S_1 \cap S_2, S_1 \setminus S_2</math>
* .red[ä¹ é¢˜]ï¼šéå†<math>S</math>ä¸­çš„æ‰€æœ‰å…ƒç´ 

---

# è¿”å›<math>S\ne\varnothing</math>ä¸­çš„æŸä¸ªå…ƒç´ 

æœ‰äºŒè¿›åˆ¶æ•°`x = 0b+++++100`ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°æœ€åé‚£ä¸ª`100`

æƒ³æ³•ï¼šé€ å‡ºä¸€äº›æ•°å­—ï¼Œèƒ½æŠŠ`+++++`çš„éƒ¨åˆ†ç»™æŠµæ¶ˆæ‰ï¼š

| è¡¨è¾¾å¼ | ç»“æœ         |
| ------ | ------------ |
| `x`    | `0b+++++100` |
| `x-1`  | `0b+++++011` |
| `~x`   | `0b-----011` |
| `~x+1` | `0b-----100` |

--

count: false

----

ä¸€äº›æœ‰è¶£çš„å¼å­ï¼š

* `x & (x-1)` â†’ `0b+++++000`ï¼›`x ^ (x-1)` â†’ `0b00000111`

* `x & (~x+1)` â†’ `0b00000100` (lowbit â­ï¸)
  * `x & -x`, `(~x & (x-1)) + 1`éƒ½æ˜¯ç­‰ä»·çš„

---

# 01ä¸²ï¼šå•æŒ‡ä»¤å¤šæ•°æ®

01å‘é‡ç‚¹ç§¯(ç”¨äº01çŸ©é˜µä¹˜æ³•)ï¼š

* `__builtin_popcount(a & b)`ï¼›popcountï¼šæ±‚<math>|S|</math>

```c
int popcount(uint32_t S) {
  int n = 0;
  for (; S; n++) {
    S = S & (S-1);
  }
  return n;
}
int popcount1(uint32_t S) { // SIMD
  S = (S & 0x55555555) + ((S >> 1) & 0x55555555);
  S = (S & 0x33333333) + ((S >> 2) & 0x33333333);
  S = (S & 0x0F0F0F0F) + ((S >> 4) & 0x0F0F0F0F);
  S = (S & 0x00FF00FF) + ((S >> 8) & 0x00FF00FF);
  S = (S & 0x0000FFFF) + ((S >> 16) & 0x0000FFFF);
  return S;
}
```



---

# 01ä¸²ï¼šå•æŒ‡ä»¤å¤šæ•°æ®

ä¸€ä¸ª32ä½æ•´æ•°å¯ä»¥å­˜å‚¨16ä¸ª0..2çš„æ•°å­—`a0, a1, ... a15`

æˆ‘ä»¬å¸Œæœ›è®¡ç®—ï¼š

.center[`(a0 \* b0) mod 3, (a1 \* b1) mod 3, ... (a15 \* b15) mod 3`]

ç»“æœåŒæ ·ä¿å­˜åœ¨ä¸€ä¸ª32ä½æ•´æ•°ä¸­

----

æç¤ºï¼š`(a * b) mod 3 = ((ah * 2 * b) + (al * b)) mod 3`

æ¥ä¸‹æ¥æ˜¯.red[æ•°å­—ç”µè·¯]è¯¾çš„å†…å®¹

---

# ä¸€æœ¬å¥½ä¹¦

<img class="float-right" src="../static/wiki/ics/2018/slides/img/hackers_delight.jpg" width="200px"/>

> Henry S. Warren, Jr. *Hacker's Delight* (2ed), Addison-Wesley, 2012.

è®©ä½ ç†è§£å†™å‡ºæ›´å¿«çš„ä»£ç å¹¶ä¸æ˜¯â€œççŒœâ€ï¼Œè€Œæ˜¯æœ‰æ–¹æ³•å¯å¾ªçš„

- ä¸»è¦å†…å®¹æ˜¯å„ç§ç¥å¥‡ä¼˜åŒ–
- å®˜æ–¹ç½‘ç«™ï¼š[hackersdelight.org](http://hackersdelight.org/)
- è§è¯†ä¸€ä¸‹çœŸæ­£çš„â€œå¥‡æŠ€æ·«å·§â€ï¼Œä»¥åŠè¯¾å ‚ä¸Šè®²çš„éƒ½æ˜¯è¾£ğŸ”

---

class: center, middle

# â˜¢ï¸ Undefined Behavior â˜¢ï¸

---

# Undefined Behavior

> *Undefined behavior* (UB) is the result of executing computer code whose behavior is not prescribed by the language specification to which the code adheres, for the current state of the program. This happens when the translator of the source code makes certain assumptions, but these assumptions are not satisfied during execution. -- Wikipedia

Cå¯¹UBçš„è¡Œä¸ºæ˜¯ä¸åšä»»ä½•çº¦æŸçš„ï¼ŒæŠŠ<font color="red">ç”µè„‘ç‚¸äº†</font>éƒ½è¡Œï¼š

> *Allowing the compiler to do anything it chooses, even "to make demons fly out of your nose"*.

å¸¸è§çš„UBï¼šéæ³•å†…å­˜è®¿é—® (ç©ºæŒ‡é’ˆè§£å¼•ç”¨ã€æ•°ç»„è¶Šç•Œã€å†™åªè¯»å†…å­˜ç­‰)ã€è¢«é›¶é™¤ã€æœ‰ç¬¦å·æ•´æ•°æº¢å‡ºã€å‡½æ•°æ²¡æœ‰è¿”å›å€¼â€¦â€¦(ä¸­ğŸ”«)

* é€šå¸¸çš„åæœæ¯”è¾ƒè½»å¾®ï¼Œæ¯”å¦‚wrong answer, crash

---

# UBï¼šå¾ˆå±é™©

CVE: *Common Vulnerabilities and Exposures*ï¼Œå…¬å¼€å‘å¸ƒè½¯ä»¶ä¸­çš„æ¼æ´

* Buffer/integer overflowå¸¸å¹´å æ®CVEçš„ä¸€å¸­ä¹‹åœ°
* é«˜å±æ¼æ´è®©æ²¡æœ‰ä¿®è¡¥çš„æœºå™¨ç«‹é©¬å®•ğŸ”/å˜æˆè‚‰ğŸ”

----

ä¾‹å­ï¼šCVE-2018-7445 (RouterOS)

```c
while (len) {
  for (i = offset; (i - offset) < len; ++i) {
    dst[i] = src[i+1]; // copy the bytes into the dst buffer
  }
  len = src[i+1]; ...
  offset = i + 1;
}
```

`dst`å¯èƒ½æº¢å‡ºâ€”â€”ç²¾å¿ƒæ„é€ çš„æ•°æ®è¢«å†™å…¥å†…å­˜(UB)ï¼Œæœ€ç»ˆå¯¼è‡´åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œä»»ä½•å‘½ä»¤â€¦â€¦

---

# ä¸ºä»€ä¹ˆéœ€è¦UBï¼Ÿ

* è¿™ä¸å°±æ˜¯ä¸€ä¸‡ä¸ªbug/å®‰å…¨æ¼æ´çš„çš„æ¥æºä¹ˆï¼Ÿ
* Javaå°±æ²¡æœ‰UB (æ‰€æœ‰å­—èŠ‚ç çš„è¡Œä¸ºéƒ½æ˜¯**ç¡®å®š**çš„)

--

count: false

----

C/C++ä»£ç ä¼šç¼–è¯‘æˆæœºå™¨æŒ‡ä»¤æ‰§è¡Œ

* ä¸ºäº†å°½å¯èƒ½é«˜æ•ˆï¼ŒæŒ‡ä»¤<font color="red">ä¸è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥</font>
  * ä¸åˆæ³•çš„äº‹æƒ…çš„åæœåªå¥½undefinedäº†
  * Javaé€‰æ‹©æ‰€æœ‰æŒ‡ä»¤éƒ½è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥(ä¾‹å¦‚æ•°ç»„è®¿é—®)
* ä¸ºäº†<font color="red">å…¼å®¹å¤šç§ç¡¬ä»¶ä½“ç³»ç»“æ„</font>
  * æœ‰äº›ç¡¬ä»¶`/0`ä¼šäº§ç”Ÿå¤„ç†å™¨å¼‚å¸¸
  * æœ‰äº›ç¡¬ä»¶å•¥ä¹Ÿä¸å‘ç”Ÿ
  * åªå¥½undefinedäº†

---

# UBï¼šè­¦æƒ•æ•´æ•°æº¢å‡º



|          è¡¨è¾¾å¼           |                   å€¼                   |
| :-----------------------: | :------------------------------------: |
|       `UINT_MAX+1`        |                   0                    |
|  `INT_MAX+1; LONG_MAX+1`  |   <font color="red">undefined</font>   |
| `char c = CHAR_MAX; c++;` | <font color="blue">varies</font> (???) |
|         `1 << -1`         |   <font color="red">undefined</font>   |
|         `1 << 0`          |                   1                    |
|         `1 << 31`         |   <font color="red">undefined</font>   |
|         `1 << 32`         |   <font color="red">undefined</font>   |
|          `1 / 0`          |   <font color="red">undefined</font>   |
|      `INT_MAX % -1`       |   <font color="red">undefined</font>   |

> W. Dietz, et al. Understanding integer overflow in C/C++. In *Proceedings of ICSE*, 2012.

---

# æ•´æ•°æº¢å‡ºå’Œç¼–è¯‘ä¼˜åŒ–

```c
int f() { return 1 << -1; }
```

.float-right[<img width="150px" src="/static/wiki/ics/2018/slides/img/questions.jpg"/>] è¿™æ˜¾ç„¶æ˜¯ä¸ªUBï¼Œäºæ˜¯ç¼–è¯‘å™¨å¯ä»¥.red[ä»»æ„å¤„ç½®]ï¼š

```
_f:
  0: 55        pushq %rbp
  1: 48 89 e5  movq %rsp, %rbp
  4: 5d        popq %rbp
  5: c3        retq
```

--

count: false

----

ç¼–è¯‘å™¨æŠŠè¿™ä¸ªè®¡ç®—ç›´æ¥.red[åˆ é™¤]äº†ï¼ç¼–è¯‘å™¨èƒ½æ¨æ–­UBçš„æ—¶å€™ï¼Œå¦‚æœå‡è®¾warp-aroundçš„ç®—æœ¯æ–¹å¼ï¼Œå°±å¯èƒ½å¯¼è‡´ä¸¥é‡åæœ

> W. Xi, et al. Towards optimization-safe systems: Analyzing the impact of undefined behavior. In *Proceedings of SOSP*, 2013.

---

class: center, middle

# æµ®ç‚¹æ•°ï¼šIEEE 754

---

# å®æ•°çš„è®¡ç®—æœºè¡¨ç¤º

å®æ•°æ˜¯éå¸¸éå¸¸å¤šå¾—â€¦â€¦<math>\aleph_0 < \mathfrak c</math> (Cantorå¯¹è§’çº¿æ³•)

å¯¹äºç°ä»£è®¡ç®—æœºæ¥è¯´ï¼Œåªå¥½ç”¨.red[32/64ä½01ä¸²]æ¥è¡¨ç¤ºä¸€éƒ¨åˆ†å®æ•°

* ç¡®å®šä¸€ç§æ˜ å°„æ–¹æ³•ï¼ŒæŠŠä¸€ä¸ª01ä¸²æ˜ å°„åˆ°ä¸€ä¸ªå®æ•°
* è¿ç®—èµ·æ¥ä¸å¤ªéº»çƒ¦
* è®¡ç®—è¯¯å·®ä¸å¤ªå¯æ€•

----

äºæ˜¯æœ‰äº†IEEE754 (1bit S, 23/52bits Fraction, 8/11bits Exponent)

.center[<math>x = (-1)^S \times (1.Fraction) \times 2^{Exponent - Bias}</math>]

---

# IEEE754ç›¸å¯¹è¯¯å·®

<math>ulp(x)</math>ï¼šå¤§äºç­‰äº<math>x</math>çš„æœ€å°å¯è¡¨ç¤ºå®æ•°

.center[<img src="../static/wiki/ics/2018/slides/img/ieee754-error.jpg" width="540px"/>]

---

# çœŸç›¸ï¼šå¹¶ä¸æ˜¯è¿™æ ·ï¼

IEEE754é‡Œæœ‰å¾ˆå¤š.red[é›·åŒº]

* éè§„æ ¼åŒ–æ•°(Exponent == 0)
  * <math>x = (-1)^S \times (0.Fraction) \times 2^{-126}</math>

* é›¶
  * `+0.0`, `-0.0`çš„<math>S</math> bitæ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†`+0.0 == -0.0`

* Inf (æ— ç©·å¤§)
  * æ¶ˆç­äº†æº¢å‡ºæ—¶çš„UB
  * ä¸è¦å¿˜è®°`a + b - b == a`åœ¨æµ®ç‚¹æ•°ä¸–ç•Œä¸å†æˆç«‹

* NaN (Not a Number)
  * èƒ½å¤Ÿæ»¡è¶³`x != x`è¡¨è¾¾å¼çš„å€¼

---

# IEEE754ï¼šå¼‚å¸¸å¤æ‚

é™¤äº†æ­£å¸¸çš„æ•°å­—<math>x = (-1)^S \times (1.Fraction) \times 2^{Exponent - Bias}</math>

æ‰€æœ‰çš„è¿ç®—éƒ½è¦è€ƒè™‘éè§„æ ¼åŒ–æ•°, +0.0/-0.0, Inf, NaN

* <img class="float-right" src="../static/wiki/ics/2018/slides/img/bomb.gif" width="200px"/> ä¸€åº¦å¼•èµ·äº†ç¡¬ä»¶å‚å•†çš„ä¼—æ€’ (ç¢°åˆ°éè§„æ ¼æ•°å¹²è„†è½¯ä»¶æ¨¡æ‹Ÿå§)
* å¾ˆå¤šâ€œå¯¹æµ®ç‚¹æ•°ç²¾åº¦è¦æ±‚ä¸é«˜â€ç¡¬ä»¶å‚å•†é€‰æ‹©ä¸å…¼å®¹IEEE 754 (æ¯”å¦‚å„ç§GPUåˆ¶é€ å•†)
* Nvidiaä»Fermiæ‰å¼€å§‹å®Œæ•´æ”¯æŒ754

----

> [An Interview with the old man of floating-point](https://people.eecs.berkeley.edu/~wkahan/ieee754status/754story.html). Reminiscences elicited from [William Kahan ](http://http.cs.berkeley.edu/~wkahan/)by [Charles Severance](http://www.dr-chuck.com/).

---

# å‡­ä»€ä¹ˆï¼Ÿ

> It looked pretty complicated. On the other hand, we had a rationale for everything. -- [William Kahan](http://http.cs.berkeley.edu/~wkahan/), 1989 ACM Turing Award Winner for his *fundamental contributions to numerical analysis*.

.center[+0.0/-0.0ä¿è¯äº†<math>1/(1/\pm\infty)=\pm\infty</math>ï¼›]

.center[ä½†æ‘§æ¯äº†<math>x=y\Leftrightarrow 1/x=1/y</math>ï¼›]

.center[éè§„æ ¼åŒ–æ•°ä¿è¯äº†<math>x = y \Leftrightarrow x - y = 0</math>ï¼›]

.center[â€¦â€¦]

--

count: false

----

.red[IEEE754å¤©æ‰çš„è®¾è®¡ä¿è¯äº†æ•°å€¼è®¡ç®—çš„ç¨³å®š]ï¼Œä½†(å†™æ•™æçš„äººä¹Ÿ)ä¸æ‡‚

> D. Goldberg. [What every computer scientist should know about floating-point arithmetic](https://dl.acm.org/citation.cfm?id=103163). *ACM Computing Surveys*, 23(1), 1991.

---

# æœ‰è¶£çš„æµ®ç‚¹æ•°

.float-right[<img width="200px" src="../static/wiki/ics/2018/slides/img/quake3.jpg"/>] é—®é¢˜ï¼šè®¡ç®—<math>f(x)=1/\sqrt{x}</math>

åº”ç”¨ï¼šSurface Norm (å…‰ç…§/åå°„)

* å¹‚çº§æ•°å±•å¼€ .float-right[<img width="250px" src="../static/wiki/ics/2018/slides/img/surface_norm.png"/>]
* äºŒåˆ†æ³•
* ç‰›é¡¿æ³•
* â€¦â€¦

----

.red[å¦‚ä½•ä¸å€ŸåŠ©ç¡¬ä»¶æŒ‡ä»¤ï¼Œå¿«é€Ÿ(è¿‘ä¼¼)è®¡ç®—<math>f(x)</math>]ï¼Ÿ

---

# ç¥å¥‡<math>O(1)</math>ä»£ç 

```c
float Q_rsqrt( float number ) {
  union { float f; uint32_t i; } conv;
  float x2 = number * 0.5F;
  conv.f = number;
  conv.i = 0x5f3759df - ( conv.i >> 1 );
  conv.f = conv.f * ( 1.5F - ( x2 * conv.f * conv.f ) );
  return conv.f;
}
```

> Matthew Robertson. [A Breif History of InvSqrt](/static/wiki/ics/rsqrt.pdf), *Bachelor Thesis, The University of New Brunswick*, 2012.


</textarea>

<script src="../static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
</script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>