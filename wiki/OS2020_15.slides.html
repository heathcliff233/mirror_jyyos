<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>è®¾å¤‡é©±åŠ¨ç¨‹åº</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è®¾å¤‡é©±åŠ¨ç¨‹åº</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>æˆ‘ä»¬è®²äº† CPU æ€ä¹ˆè®¿é—® I/O è®¾å¤‡</p>
<p>åº”ç”¨ç¨‹åºæ€ä¹ˆè®¿é—®ï¼Ÿ</p>
<ul>
<li>æ“ä½œç³»ç»Ÿæä¾›æ¥å£</li>
</ul>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>I/O è®¾å¤‡çš„æŠ½è±¡</li>
<li>è®¾å¤‡é©±åŠ¨ç¨‹åº</li>
<li>åº”ç”¨ç¨‹åºçœ¼ä¸­çš„ I/O è®¾å¤‡</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="io">I/O è®¾å¤‡çš„æŠ½è±¡</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io">I/O è®¾å¤‡ï¼šå›é¡¾</h2>
<blockquote>
<p>æˆ‘ä»¬çœŸæ­£ â€œä½¿ç”¨â€ è®¡ç®—æœº (è®¡ç®—æœºä¸å¤–ç•Œäº¤äº’) çš„éƒ¨åˆ† (â€œå¤–è®¾â€)</p>
<ul>
<li>é”®ç›˜ã€é¼ æ ‡ã€æ˜¾ç¤ºå™¨ã€è§¦æ‘¸å±ã€éŸ³ç®±ã€æ‰“å°æœºâ€¦â€¦</li>
</ul>
</blockquote>
<p>å®é™…ä¸Š I/O è®¾å¤‡æ˜¯ â€œä¸€ç»„èƒ½ä¸ CPU äº¤æ¢æ•°æ®çš„æ¥å£â€</p>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/canonical-device.png" width="600px"></img></p>
<ul>
<li>CPU ä½¿ç”¨æŒ‡ä»¤è®¿é—®è®¾å¤‡å¯„å­˜å™¨/å­˜å‚¨</li>
<li>åœ¨æ­¤æ„ä¹‰ä¸Šï¼Œæ›´å¤šçš„ä¸œè¥¿éƒ½å±äº I/O è®¾å¤‡<ul>
<li>ä¸­æ–­æ§åˆ¶å™¨ã€æ€»çº¿, DMA, GPU, ...</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io">æ“ä½œç³»ç»Ÿï¼šåº”è¯¥å¯¹ I/O è®¾å¤‡åšä»€ä¹ˆï¼Ÿ</h2>
<p>åº”ç”¨ç¨‹åºæœ‰è®¿é—® I/O è®¾å¤‡çš„éœ€æ±‚</p>
<ul>
<li><code>printf</code> å¸Œæœ›è¾“å‡ºå­—ç¬¦åˆ°å±å¹•/ç£ç›˜</li>
<li>æµè§ˆå™¨éœ€è¦å‘ url å‘é€ HTTPS è¯·æ±‚</li>
<li>â€¦â€¦</li>
</ul>
<div class="fragment">
<p>åº”ç”¨ç›´æ¥è®¿é—® I/O è®¾å¤‡çš„åæœ</p>
<ul>
<li>å†ä¹Ÿæ— æ³•å†™å‡º portable çš„ä»£ç <ul>
<li>printf å¹¶ä¸æƒ³çŸ¥é“å®ƒå‘å“ªä¸ªè®¾å¤‡ä¸Šå†™æ•°æ®</li>
<li>æµè§ˆå™¨ä¹Ÿä¸æƒ³çŸ¥é“ç”¨å“ªä¸ªå‚å•†çš„ç½‘å¡æŠŠæ•°æ®å‘å‡ºå»</li>
</ul>
</li>
<li>åº”ç”¨ä¹‹é—´éœ€è¦äº’æ–¥ã€åŒæ­¥ã€åå•†è®¾å¤‡èµ„æºçš„ä½¿ç”¨<ul>
<li>ğŸ˜‚ ä½ ä¸å¯èƒ½æŠŠè¿™ä»¶äº‹åšå¯¹çš„</li>
<li>è®¾å¤‡ç›´è¿ç‰©ç†ä¸–ç•Œï¼Œå¯èƒ½å‘ç”Ÿç‰©ç†æ€§çš„ä¼¤å®³</li>
</ul>
</li>
</ul>
</div>
<div class="fragment">
<blockquote>
<p>æ“ä½œç³»ç»Ÿéœ€è¦å¯¹è®¾å¤‡è¿›è¡Œ<span class="red">æŠ½è±¡</span> (è™šæ‹ŸåŒ–)</p>
</blockquote>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="io-api">éœ€æ±‚åˆ†æï¼šI/O è®¾å¤‡è®¿é—® API è®¾è®¡</h2>
<p>printf</p>
<ul>
<li>å¸Œæœ›å‘è®¾å¤‡å†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²<ul>
<li><code>write(dev, "hello");</code> (è¿˜è®°å¾— ANSI Escape Code å—ï¼Ÿ)</li>
</ul>
</li>
</ul>
<p>æµè§ˆå™¨</p>
<ul>
<li>å¸Œæœ›ä»æŸä¸ª TCP è¿æ¥ä¸­è¯»å‡ºæ•°æ®<ul>
<li><code>read(conn, buf, size);</code></li>
</ul>
</li>
<li>å¸Œæœ›åœ¨å½“å‰çš„ç”»å¸ƒ (canvas) ä¸Šæ‰§è¡Œä¸€äº›ç»˜å›¾æŒ‡ä»¤<ul>
<li><code>write(wm, draw_cmds, size);</code></li>
</ul>
</li>
</ul>
<div class="fragment">
<blockquote>
<p>I/O è®¾å¤‡çš„æŠ½è±¡ï¼šå¯¹è®¾å¤‡ (æ–‡ä»¶æè¿°ç¬¦) çš„ I (read) å’Œ O (write)</p>
</blockquote>
<p>I/O è®¾å¤‡è™½ç„¶å¤æ‚ï¼Œä½†å‡ ä¹éƒ½å¯ä»¥ç†è§£æˆ<span class="red">å­—èŠ‚çš„åºåˆ—</span> (æµæˆ–æ•°ç»„)</p>
<ul>
<li>(read) ä»è®¾å¤‡æŸä¸ªæŒ‡å®šçš„ä½ç½®è¯»å‡ºæ•°æ®</li>
<li>(write) å‘è®¾å¤‡æŸä¸ªæŒ‡å®šä½ç½®å†™å…¥æ•°æ®</li>
<li>(ioctl) è¯»å–/è®¾ç½®è®¾å¤‡çš„çŠ¶æ€</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ“ä½œç³»ç»Ÿï¼šæä¾›ä¸€ä¸ªç¡¬ä»¶æŠ½è±¡å±‚</h2>
<blockquote>
<p>æ“ä½œç³»ç»Ÿçš„æœ¬è´¨ï¼šç®¡ç†ç¡¬ä»¶èµ„æºã€ä¸ºç¨‹åºçš„æ‰§è¡Œæä¾›æœåŠ¡</p>
</blockquote>
<p>åœ¨æ“ä½œç³»ç»Ÿä¸­å»ºç«‹ä¸€ä¸ªæ–°çš„æŠ½è±¡å±‚</p>
<ul>
<li>ä»¥åŒä¸€ä¸ªæ¥å£è®¿é—®ä¸åŒçš„ I/O è®¾å¤‡</li>
<li>å®ç°æ¥å£çš„ä»£ç å°±æ˜¯<span class="red">è®¾å¤‡é©±åŠ¨ç¨‹åº</span><ul>
<li>æŠŠå¯¹è®¾å¤‡çš„ HAL è°ƒç”¨ç¿»è¯‘æˆæŒ‡ä»¤</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ä¾‹å­ï¼šåº”ç”¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶æè¿°ç¬¦</p>
<ul>
<li>æ–‡ä»¶ç³»ç»Ÿ API â†’ (æ“ä½œç³»ç»Ÿä»£ç ç¿»è¯‘æˆ) â†’ HAL API<ul>
<li>HAL API â†’ (è®¾å¤‡é©±åŠ¨ç¿»è¯‘æˆ) â†’ è®¾å¤‡æŒ‡ä»¤ & å“åº”ä¸­æ–­</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è®¾å¤‡é©±åŠ¨ç¨‹åº</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">è®¾å¤‡é©±åŠ¨ï¼šç¡¬ä»¶æŠ½è±¡å±‚çš„å®ç°</h2>
<blockquote>
<p>è®¾å¤‡é©±åŠ¨ç¨‹åºï¼šå¯¹è®¾å¤‡è¿›è¡Œä¸€å®šçš„ç®¡ç†ï¼Œå¯¹ä¸Šå±‚æä¾›ç»Ÿä¸€çš„æ¥å£</p>
<ul>
<li>ä»¥ â€œé¢å‘å¯¹è±¡â€ çš„æ–¹å¼è®¿é—® I/O è®¾å¤‡<ul>
<li>è®¾å¤‡ = æ”¯æŒ read, write, ioctl, ... åŠŸèƒ½çš„å¯¹è±¡</li>
</ul>
</li>
</ul>
</blockquote>
<p>è®¾å¤‡é©±åŠ¨ç¨‹åºæŠŠ HAL API è°ƒç”¨ (read, write, ioctl) ç¿»è¯‘æˆæŒ‡ä»¤</p>
<ul>
<li>port I/O; memory-mapped I/O; æ€»çº¿; DMA; ä¸­æ–­...</li>
</ul>
<div class="fragment">
<hr></hr>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/pmd.gif" width="400px"></img></p>
<p>é“ç†ç®€å•ï¼Œä½†å†™ä»£ç å°±éº»çƒ¦äº†</p>
<ul>
<li>I/O è®¾å¤‡çœ‹èµ·æ¥æ˜¯ä¸ª â€œé»‘ç›’å­â€</li>
<li>å†™é”™ä»»ä½•ä»£ç å°± simply â€œnot workâ€</li>
<li>I/O è®¾å¤‡ååè¿˜æä¾›å·¨å¤šçš„åŠŸèƒ½<ul>
<li>GPU è‡ªå¸¦å¤„ç†å™¨ã€å†…å­˜ã€ç¼–è¯‘å™¨ã€æ•£çƒ­ç®¡ç†ã€â€¦â€¦</li>
<li>ä¾‹å¦‚æƒ³ä¸º â€œè·‘é©¬ç¯â€ ç¼–ç¨‹ã€è°ƒæ•™ GPU ç­‰å°±éœ€è¦å®‰è£…é©±åŠ¨ç¨‹åºå’Œç®¡ç†åº”ç”¨</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lab-2">ä¾‹å­: Lab 2 ç¡¬ä»¶æŠ½è±¡å±‚</h2>
<p>åšäº†å¾ˆå¤š<span class="red">ä¸åˆç†</span>çš„ç®€åŒ–å‡è®¾</p>
<ul>
<li>è®¾å¤‡ä»ç³»ç»Ÿå¯åŠ¨æ—¶å°±å­˜åœ¨ä¸”ä¸ä¼šæ¶ˆå¤±</li>
<li>åªæ”¯æŒè¯»/å†™ä¸¤ç§æ“ä½œ </li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">devops</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="n">device_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span> <span class="p">(</span><span class="n">device_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="n">device_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span> <span class="n">devops_t</span><span class="p">;</span>
</pre></div>

<p>ä»£ç è®²è§£ï¼šdevices.h, dev_tty.c</p>
<ul>
<li>è®¾å¤‡é©±åŠ¨ç¨‹åºï¼šå°†è®¾å¤‡æŠ½è±¡ä¸ºä¸€ä¸ªå¯¹è±¡å’Œæ“ä½œ<ul>
<li>æœªå¿…ä¸€å®šè¦æœ‰ç‰©ç†çš„è®¾å¤‡<ul>
<li><code>/dev/null</code>, <code>/dev/urandom</code>, ...</li>
<li>ä½ ä¹Ÿèƒ½ç†è§£å®ƒä»¬æ€ä¹ˆå®ç°ï¼</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux">ä¾‹å­ï¼šLinux è®¾å¤‡é©±åŠ¨</h2>
<blockquote>
<p><em>Everything is a file</em> (è®¾å¤‡ä¹Ÿæ˜¯)</p>
<ul>
<li>æ‰€ä»¥è®¾å¤‡æä¾›æ–‡ä»¶æ“ä½œå°±å¥½äº†ï¼</li>
<li>è¿™ä¹Ÿå¤ªå¤æ‚äº†å§ï¼Œä¸€å±éƒ½å†™ä¸ä¸‹ (æˆ‘åªåˆ—å‡ºäº†å¤§å®¶ç†Ÿæ‚‰çš„) ğŸ˜‚</li>
</ul>
</blockquote>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">file_operations</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
  <span class="n">loff_t</span> <span class="p">(</span><span class="o">*</span><span class="n">llseek</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="n">loff_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
  <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmap_supported_flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">flush</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="n">fl_owner_t</span> <span class="n">id</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fsync</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="n">loff_t</span><span class="p">,</span> <span class="n">loff_t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">datasync</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>
  <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">sendpage</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
  <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">unlocked_ioctl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
  <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">flock</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file_lock</span> <span class="o">*</span><span class="p">);</span>
  <span class="p">...</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="ioctl">å®é™…ç³»ç»Ÿçš„å¤æ‚æ€§: ioctl</h2>
<p>é“ç†æˆ‘éƒ½æ‡‚</p>
<ul>
<li>æˆ‘ä»¬è§è¿‡ ioctl çš„ä½¿ç”¨äº† (<code>strace stty</code>)</li>
<li>ä½†ä¸ºä»€ä¹ˆä¼šéœ€è¦ä¸¤ä¸ª ioctlï¼Ÿ</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">unlocked_ioctl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
</pre></div>
<div class="fragment">
<ul>
<li><code>unlocked_ioctl</code>: BKL (Big Kernel Lock) æ—¶ä»£çš„é—äº§<ul>
<li>å•å¤„ç†å™¨æ—¶ä»£åªæœ‰ <code>ioctl</code></li>
<li>ä¹‹åå¼•å…¥äº† BKL, <code>ioctl</code> æ‰§è¡Œæ—¶é»˜è®¤æŒæœ‰ BKL</li>
<li>(2.6.11) é«˜æ€§èƒ½çš„é©±åŠ¨å¯ä»¥é€šè¿‡ <code>unlocked_ioctl</code> é¿å…é”</li>
<li>(2.6.36) <code>ioctl</code> ä» <code>struct file_operations</code> ä¸­ç§»é™¤</li>
</ul>
</li>
<li><code>compact_ioctl</code>: æœºå™¨å­—é•¿çš„å…¼å®¹æ€§<ul>
<li>32-bit ç¨‹åºåœ¨ 64-bit ç³»ç»Ÿä¸Šå¯ä»¥ ioctl</li>
<li>æ­¤æ—¶åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿå¯¹ ioctl æ•°æ®ç»“æ„çš„è§£è¯»å¯èƒ½ä¸åŒ (tty)</li>
<li>(è°ƒç”¨æ­¤å…¼å®¹æ¨¡å¼)</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ“ä½œç³»ç»Ÿï¼šå†ç»çš„å˜åŒ–</h2>
<p><code>struct file_operations</code> ä¸€ç›´åœ¨é€‚åº”åº”ç”¨åœºæ™¯çš„å˜åŒ–</p>
<ul>
<li>å•å¤„ç†å™¨ â†’ å¤šå¤„ç†å™¨ (é›†æˆç”µè·¯å·¥è‰ºçº¢åˆ©æ¶ˆå¤±)</li>
<li>å•æœº (hobby project) â†’ æœåŠ¡å™¨ â†’ äº‘è®¡ç®—/æ•°æ®ä¸­å¿ƒ</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/42-years-processor-trend.png" width="800px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ€æ ·åœ¨å¤æ‚æ€§ä¸­ç”Ÿå­˜ä¸‹æ¥ï¼Ÿ</h2>
<blockquote>
<p>ç†è§£æ¯ä¸ªè®¾è®¡èƒŒåçš„å†å²å’ŒåŠ¨æœº</p>
<ul>
<li>ä¸ºä»€ä¹ˆæˆ‘è¦ XXXï¼Ÿ<ul>
<li>XXX = DMA, GPU, select/poll, aio, ...</li>
</ul>
</li>
<li>æ˜¯å› ä¸ºä»¥å‰æœ‰ä¸€ä¸ªç®€å•çš„ YYY ä½†ç°åœ¨ä¸å¤Ÿç”¨äº†<ul>
<li>AbstractMachine, oslab, ...</li>
</ul>
</li>
</ul>
</blockquote>
<p>æ“ä½œç³»ç»Ÿè¯¾çš„ç›®çš„</p>
<ul>
<li>æŒæ¡ (æœ€ç®€) æ“ä½œç³»ç»Ÿè®¾è®¡å’Œå®ç°åŸç†</li>
<li>å­¦ä¼šåœ¨åªæœ‰æ‰‹å†Œçš„æƒ…å†µä¸‹ç”Ÿå­˜ (M5)<ul>
<li>è¿™æ ·ä½ ç»å¤§éƒ¨åˆ†æ—¶å€™éƒ½èƒ½æŠŠæœªçŸ¥çš„ä»£ç  â€œæ˜ å°„â€ (ç®€åŒ–) åˆ°ä½ å­¦è¿‡çš„ä¸œè¥¿<ul>
<li>ä½ ä¼šå‘ç°ä½ å­¦å®Œè¿™é—¨è¯¾ä»¥åï¼Œå°±å¯ä»¥å»ç©çœŸæ­£çš„ç³»ç»Ÿäº†ï¼</li>
<li>Linux Kernel, OpenJDK, LLVM, ...</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">ä¸¤ç±»ç‰¹æ®Šçš„è®¾å¤‡ï¼šç£ç›˜ã€ç½‘å¡</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç£ç›˜ä¸å—è®¾å¤‡</h2>
<p>ç£ç›˜ (å­˜å‚¨è®¾å¤‡) çš„è®¿é—®ç‰¹æ€§</p>
<ol>
<li>ä»¥æ•°æ®å— (block) ä¸ºå•ä½è®¿é—®<ul>
<li>ä¼ è¾“æœ‰ â€œæœ€å°å•å…ƒâ€ï¼Œä¸æ”¯æŒä»»æ„éšæœºè®¿é—®</li>
</ul>
</li>
<li>å¤§ååé‡<ul>
<li>ä½¿ç”¨ DMA ä¼ é€æ•°æ®</li>
</ul>
</li>
<li>åº”ç”¨ç¨‹åºä¸€èˆ¬ä¸ç›´æ¥è®¿é—®<ul>
<li>è®¿é—®è€…é€šå¸¸æ˜¯æ–‡ä»¶ç³»ç»Ÿ (ç»´æŠ¤ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„)</li>
<li>å¤§é‡å¹¶å‘çš„è®¿é—® (æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹éƒ½è¦è®¿é—®æ–‡ä»¶ç³»ç»Ÿ)</li>
</ul>
</li>
</ol></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux-block-io-layer">Linux Block I/O Layer</h2>
<p>æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜è®¾å¤‡ä¹‹é—´çš„æ¥å£</p>
<ul>
<li>I/O è°ƒåº¦å™¨<ul>
<li>æ›¾ç»æ˜¯ â€œç”µæ¢¯â€ è°ƒåº¦å¢åŠ æ€§èƒ½</li>
<li>ç°åœ¨æ˜¯ CFQ ä¿è¯å…¬å¹³æ€§</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/linux-bio.png" width="800px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å—è®¾å¤‡ï¼šæŒä¹…æ•°æ®çš„å¯é æ€§</h2>
<blockquote>
<p>Many storage devices, ... come with <em>volatile write back caches</em></p>
<ul>
<li>the devices signal I/O completion to the operating system before data actually has hit the non-volatile storage</li>
<li>this behavior obviously <em>speeds up</em> various workloads, but ... <em>data integrity</em>...</li>
</ul>
</blockquote>
<p>æˆ‘ä»¬å½“ç„¶å¯ä»¥æä¾›ä¸€ä¸ª ioctl</p>
<ul>
<li>ä½† block layer æä¾›äº†æ›´æ–¹ä¾¿çš„æœºåˆ¶<ul>
<li>åœ¨ block I/O æäº¤æ—¶<ul>
<li><code>| REQ_PREFLUSH</code> ä¹‹å‰çš„æ•°æ®è½ç›˜åæ‰å¼€å§‹</li>
<li><code>| REQ_FUA</code> (force unit access)ï¼Œæ•°æ®è½ç›˜åæ‰è¿”å›</li>
</ul>
</li>
<li>è®¾å¤‡é©±åŠ¨ç¨‹åºä¼šæŠŠè¿™äº› flags ç¿»è¯‘æˆç£ç›˜ (SSD) çš„æ§åˆ¶æŒ‡ä»¤</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç½‘ç»œè®¾å¤‡</h2>
<p>ç½‘ç»œçš„è®¿é—®ç‰¹æ€§</p>
<ol>
<li>é€Ÿåº¦éå¸¸å¿«<ul>
<li>ä¾‹å¦‚ 10,000 Gbps (ä¸‡å…†ç½‘å¡)</li>
</ul>
</li>
<li>å¤§å°ä¸ç¡®å®š<ul>
<li>datagram å¯èƒ½å¾ˆå° (å‡ åä¸ªä¸ª bytes)ã€å¯èƒ½å¾ˆå¤§ (KiB çº§)</li>
</ul>
</li>
<li>å»¶è¿Ÿæ•æ„Ÿ<ul>
<li><code>while (1)  { read(); process(); }</code> å¯èƒ½æ— æ³•è¾¾åˆ°é¢„æœŸçš„æ€§èƒ½<ul>
<li>æ•°æ®ä¸­å¿ƒã€äº‘è®¡ç®—ã€â€¦â€¦</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr></hr>
<p>ç½‘ç»œè®¾å¤‡</p>
<ul>
<li>å†…å­˜ (TX/RX rings) + DMA + ä¸­æ–­</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux-net">Linux net å­ç³»ç»Ÿ</h2>
<p>Linux Kernel ç”¨ç‹¬ç«‹çš„å­ç³»ç»Ÿ (è®¾å¤‡æŠ½è±¡å’Œ API) ç®¡ç†ç½‘ç»œè®¾å¤‡</p>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/net-arch.png" width="810px"></img></p></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="io">åº”ç”¨ç¨‹åºçœ¼ä¸­çš„ I/O è®¾å¤‡</h1>
<p><br></br>
<p>(æ“ä½œç³»ç»Ÿå¯¹è®¾å¤‡ä½œå‡ºçš„æŠ½è±¡)</p></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">è®¾å¤‡ = æ–‡ä»¶</h2>
<p><code>/dev/</code> ä¸­æœ‰å¾ˆå¤šè®¾å¤‡æ–‡ä»¶</p>
<ul>
<li><code>/dev/pts/[x]</code> - pseudo terminal</li>
<li><code>/dev/zero</code> - â€œé›¶â€ è®¾å¤‡</li>
<li><code>/dev/null</code> - â€œnullâ€ è®¾å¤‡</li>
<li><code>/dev/random</code>, <code>/dev/urandom</code> - éšæœºæ•°ç”Ÿæˆå™¨<ul>
<li>è¯•ä¸€è¯•ï¼š<code>head -c 512 [device] | xxd</code></li>
<li>ä»¥åŠè§‚å¯Ÿå®ƒä»¬çš„ strace<ul>
<li>èƒ½çœ‹åˆ°è®¿é—®è®¾å¤‡çš„ç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ä¹‹åæˆ‘ä»¬ä¼šè§£é‡Šæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦‚ä½•å¤„ç†è®¾å¤‡æ–‡ä»¶çš„</p>
<ul>
<li>ä½ ä»¬ä¹Ÿä¼šåœ¨ Lab 3 é‡Œå®ç° vfs (procfs, devfs, ufs)</li>
<li><a href="https://zhuanlan.zhihu.com/p/130318023">è±ªåæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•å¥—é¤ ç°å·²åŠ å…¥å—äº¬å¤§å­¦æ“ä½œç³»ç»Ÿå®éªŒ</a><ul>
<li>å¹¸è¿çš„æ˜¯ï¼Œä½ ä»¬çš„æ–‡ä»¶ç³»ç»Ÿæ¯” Linux ç®€å•å¾—å¤š</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç£ç›˜ (å—è®¾å¤‡)</h2>
<div class="codehilite"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/dev/sda'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
  <span class="n">mm</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
  <span class="n">hexdump</span><span class="o">.</span><span class="n">hexdump</span><span class="p">(</span><span class="n">mm</span><span class="p">[:</span><span class="mi">512</span><span class="p">])</span>
</pre></div>

<p>strace çš„ç»“æœ</p>
<ul>
<li>å®Œå…¨ä½¿ç”¨äº†æ–‡ä»¶ç³»ç»Ÿçš„ API</li>
<li>é¢å¤–æ‰§è¡Œäº† ioctl (<code>TCGETS</code>)ï¼Œè¯¢é—®è®¾å¤‡çš„ç»ˆç«¯é…ç½®<ul>
<li><code>-1</code> (<code>ENOTTY</code>): ä¸æ˜¯ç»ˆç«¯</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span>openat(AT_FDCWD, "/dev/sda", O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFBLK|0660, st_rdev=makedev(8, 0), ...}) = 0
ioctl(3, TCGETS, 0x7ffeb09414a0)        = -1 ENOTTY
lseek(3, 0, SEEK_CUR)                   = 0
fstat(3, {st_mode=S_IFBLK|0660, st_rdev=makedev(8, 0), ...}) = 0
fcntl(3, F_DUPFD_CLOEXEC, 0)            = 4
mmap(NULL, 137438953472, PROT_READ, MAP_SHARED, 3, 0) = 0x7f85a6f14000
write(1, ...)
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="net">ç½‘ç»œ (net å­ç³»ç»Ÿ)</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/power-socket.jpg" width="150px"></img></p>
<p>ç½‘ç»œè®¾å¤‡æ¯”è¾ƒç‰¹æ®Šï¼Œç”±å¦ä¸€ç»„ API ç®¡ç†</p>
<ul>
<li>Berkeley sockets å¥—æ¥å­— (1983)<ul>
<li><a href="https://www.zhihu.com/question/21383903/answer/64103663">å¦ä¸€è¿·æƒ‘ç¿»è¯‘è¡Œä¸º</a> (å¥æŸ„ã€å®â€¦â€¦)</li>
</ul>
</li>
<li>å¤ç”¨äº†æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œç½‘ç»œ API (send, recv, socket, ...)</li>
</ul>
<p>ä¾‹å­: <code>ping baidu.com</code></p>
<div class="codehilite"><pre><span></span>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP) = 3
...
setsockopt(3, SOL_RAW, ICMP_FILTER, ...) = 0
setsockopt(3, SOL_IP,     IP_RECVERR, [1], 4) = 0
setsockopt(3, SOL_SOCKET, SO_SNDBUF,  [324], 4) = 0
setsockopt(3, SOL_SOCKET, SO_RCVBUF,  [65536], 4) = 0
getsockopt(3, SOL_SOCKET, SO_RCVBUF,  [131072], [4]) = 0
fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...}) = 0
write(1, "PING baidu.com (220.181.38.148) "...) = 54
...
sendto(3, "\10\0]*O\216...", 0,
  {sa_family=AF_INET,
   sin_port=htons(0),
   sin_addr=inet_addr("220.181.38.148")}, 16});
recvmsg(3, ...
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="contd">ç½‘ç»œ (cont'd)</h2>
<blockquote>
<p>Socket è¿˜ç”¨äºè¿›ç¨‹é—´/å†…æ ¸é€šä¿¡</p>
</blockquote>
<p>ç½‘ç»œè®¾å¤‡ç®¡ç†: <code>ifconfig -s</code> / <code>ip link</code></p>
<ul>
<li>ifconfig<ul>
<li><code>socket(AF_UNIX, SOCK_DGRAM, 0)          = 3</code></li>
<li><code>socket(AF_INET, SOCK_DGRAM, IPPROTO_IP) = 4</code></li>
<li><code>openat(AT_FDCWD, "/proc/net/dev", O_RDONLY) = 6</code> (procfs)</li>
<li><code>ioctl(5, SIOCGIFFLAGS, {ifr_name="enp0s3", ifr_flags=IFF_UP | IFF_BROADCAST | IFF_RUNNING | IFF_MULTICAST}) = 0</code></li>
</ul>
</li>
<li>ip<ul>
<li><code>socket(AF_NETLINK, SOCK_RAW|SOCK_CLOEXEC, NETLINK_ROUTE) = 3</code></li>
<li><code>sendto(3, {{len=40, type=RTM_GETLINK, flags=...}, ...)</code></li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>è®¾å¤‡é©±åŠ¨ç¨‹åº</p>
<ul>
<li>å°† I/O è®¾å¤‡æŠ½è±¡ä¸ºç»Ÿä¸€çš„æ¥å£ï¼Œå†é€šè¿‡æ–‡ä»¶ç³»ç»Ÿ API ç»™åº”ç”¨ç¨‹åº<ul>
<li>å­—èŠ‚æµ/å­—èŠ‚æ•°ç»„: <code>struct file_operations</code></li>
<li>ä¸¤ç±»æ¯”è¾ƒç‰¹æ®Šçš„è®¾å¤‡ï¼šç£ç›˜ (block)ã€ç½‘å¡ (net)</li>
</ul>
</li>
<li>Linux Kernel 70%+ çš„ä»£ç æ˜¯è®¾å¤‡é©±åŠ¨<ul>
<li>bug å’Œå®‰å…¨æ¼æ´çš„é‡ç¾åŒº</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜</p>
<ul>
<li>æ ¹æ® lecture notes é˜…è¯»æ•™ç§‘ä¹¦ç›¸åº”éƒ¨åˆ†</li>
<li>é˜…è¯» xv6 ç£ç›˜é©±åŠ¨éƒ¨åˆ†çš„ä»£ç  (<code>ide.c</code>)</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>