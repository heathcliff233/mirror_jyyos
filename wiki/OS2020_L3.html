<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
    

    <title>L3: æ–‡ä»¶ç³»ç»Ÿå®ç° (vfs)</title>
  </Head>
  <body>
   
   
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-barnd" href="index.html">Yanyan's Wiki</a>
  <div class="collapse navbar-collapse">
    <div class="navbar-nav">
      <a class="nav-item nav-link active" href="OS2020.html">
        <img class="textimg" src="../static/wiki/logo-n.png"/>
        æ“ä½œç³»ç»Ÿ (2020)</a>
      <a class="nav-item nav-link active" href="SysLab2020.html">
        è®¡ç®—æœºç³»ç»Ÿç»¼åˆå®éªŒ (2020)</a>
      <a class="nav-item nav-link active" href="ICS_NJU.html"><img class="textimg" height="18px" src="../static/img/ics.png"/> åŠ å…¥æˆ‘ä»¬</a>
    </div>
    <form class="form-inline" autocomplete="off">
      <input id="token-input" type="text" oninput="login();" maxlength="16"
        data-toggle="tooltip" data-placement="bottom"
        title="ç”¨äºç¡®å®šèº«ä»½çš„ä½œä¸šæäº¤ SHA-1 hash digestã€‚æ›´æ”¹åå›è½¦æˆ–åˆ·æ–°ç½‘é¡µç”Ÿæ•ˆ"></input>
    </form>
  </div>
</nav>

<center>
  <div class="article-container">
    <div class="article">
      <h1 id="l3-vfs">L3: æ–‡ä»¶ç³»ç»Ÿå®ç° (vfs)</h1>
<div markdown="1"><div class="fenced fenced-red"><div>
<h4 id="_1">å¸¸è§é—®é¢˜</h4>
<p>(æ¡†æ¶ä»£ç å·²æ›´æ–°ï¼Œè®²ä¹‰/OJ æš‚æ—¶æ²¡æœ‰å®Œæˆ)</p>
<p>å¦‚æœä½ çš„å®éªŒæäº¤åˆ°äº† L2, è¯·ä¿®æ”¹ Makefile ä¸­çš„ <code>MODULE := L3</code>ã€‚</p>
</div></div></div>

<div markdown="1"><div class="fenced fenced-red"><div>
<h4 id="_1">æˆªæ­¢æ—¥æœŸ</h4>
<p>å…³äºå®éªŒç¯å¢ƒè®¾ç½®ã€æäº¤æ–¹æ³•ã€è¯„åˆ†è§„åˆ™ç­‰ï¼Œè¯·é˜…è¯»<a href="OS2020_Labs.html">å®éªŒé¡»çŸ¥</a>ã€‚è·å–ä»£ç ï¼Œåœ¨ <code>os-workbench</code> ä¸­æ‰§è¡Œï¼š</p>
<div class="codehilite"><pre><span></span><span class="err">git pull origin L3</span>
</pre></div>


<p>Soft Deadline: 2020 å¹´ 6 æœˆ 28 æ—¥ 23:59:59ã€‚</p>
<p>æœ¬å®éªŒåœ¨ L2 ä»£ç çš„åŸºç¡€ä¸Šå®Œæˆã€‚ä½†å¦‚æœä½ å®Œå…¨æ²¡æœ‰å®Œæˆ L2ï¼Œä¾ç„¶å¯ä»¥åˆå¹¶ä»£ç å¹¶å¼€å§‹ L3ã€‚åªè¦å®ç°æ­£ç¡®çš„ mkfsï¼Œå¹¶ä¸”èƒ½åœ¨ <code>vfs_init</code> ä¹‹åæ­£ç¡®è¯»å†™ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œå°±å¯ä»¥é€šè¿‡ä¸€å®šçš„æµ‹è¯•ç”¨ä¾‹ã€‚</p>
<p>éœ€è¦æäº¤ä»¥å­¦å·å‘½åçš„ .pdf æ ¼å¼å®éªŒæŠ¥å‘Š (ä¿å­˜åœ¨ <code>kernel/</code> ç›®å½•ä¸‹ï¼Œåœ¨ L2 çš„å®éªŒæŠ¥å‘Šä¹‹åæ·»åŠ )ã€‚é™¤éç‰¹æ®Šæƒ…å†µï¼Œæœ¬æ¬¡å®éªŒæŠ¥å‘Šæ–°å¢å†…å®¹<strong>ä¸å»ºè®®è¶…è¿‡ 2 é¡µ A4 çº¸</strong>ã€‚è¯·åœ¨å®éªŒæŠ¥å‘Šä¸­æè¿°ä½ åœ¨å®éªŒä¸­é‡åˆ°çš„ç‰¹åˆ«å€¼å¾—ä¸€æçš„äº‹ä»¶ï¼Œä¾‹å¦‚ä½ ä»£ç çš„æ¶æ„è®¾è®¡ã€ç‰¹åˆ«ç²¾å·§çš„å®ç°ã€é‡åˆ°å°è±¡æ·±åˆ»çš„ bug ç­‰ã€‚</p>
</div></div></div>

<div plugin="submission(course='OS2020', module='L3')"><div class="accordion submission" id="accordionExample">

  <div class="card">
    <div class="card-header submit-card">
      <form action="../upload.html" method="post" enctype="multipart/form-data">
        <div class="form-row align-items-center">
            <label class="col-form-label">OS2020-L3</label> æäº¤ç»“æœ
        </div>
      </form>
    </div>
  </div>



</div></div>

<h2 id="1">1. èƒŒæ™¯</h2>
<p>åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬åœ¨å¤šå¤„ç†å™¨åˆ†æ—¶å¤šçº¿ç¨‹çš„åŸºç¡€ä¸Šå®ç°<strong>çº¿ç¨‹å®‰å…¨</strong>çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (virtual file system, VFS) APIï¼Œå¹¶ä¸”åœ¨ VFS è¿™ä¸€æŠ½è±¡å±‚ä¸Šå®ç°è‹¥å¹²ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼š</p>
<ul>
<li>åœ¨å­˜å‚¨è®¾å¤‡ (<code>sda</code>) ä¸Šæ”¯æŒå®Œæ•´æ–‡ä»¶å’Œç›®å½•æ“ä½œçš„æ–‡ä»¶ç³»ç»Ÿ â€œultra-simple file systemâ€ (ufs);</li>
<li>è™šæ‹Ÿçš„ procfsï¼Œæä¾›ä¸€ç³»åˆ—åªè¯»çš„ã€åæ˜ æ“ä½œç³»ç»Ÿå†…éƒ¨çŠ¶æ€çš„æ–‡ä»¶ï¼›</li>
<li>è™šæ‹Ÿçš„ devfsï¼Œå°†æ“ä½œç³»ç»Ÿä¸­çš„è®¾å¤‡æŠ½è±¡ä¸ºå¯ä»¥è®¿é—®çš„æ–‡ä»¶ï¼Œå¹¶ä¸ºè¿™äº›æ–‡ä»¶æä¾›è¯»å†™æ“ä½œã€‚</li>
</ul>
<p>å®ç°å®Œæˆåï¼Œç³»ç»Ÿä¸­çš„å¤šä¸ªçº¿ç¨‹å°±èƒ½é€šè¿‡æ–‡ä»¶ç³»ç»Ÿ API è¯»å†™æ–‡ä»¶â€”â€”è‡³æ­¤æˆ‘ä»¬ç¦»ç°ä»£æ“ä½œç³»ç»Ÿå°±åªæœ‰ä¸€æ­¥ä¹‹é¥ (ä¸‹ä¸€ä¸ªå®éªŒ)ï¼šä¸ºæ¯ä¸ªçº¿ç¨‹é™„å±ä¸€ä¸ªç‹¬ç«‹çš„åœ°å€ç©ºé—´ (é€šè¿‡è™šæ‹Ÿå­˜å‚¨å®ç°)ï¼Œçº¿ç¨‹å°±å˜æˆäº†æˆ‘ä»¬ç†ŸçŸ¥çš„è¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå°±å®Œæ•´äº†ã€‚å¤§å®¶ä¸å¦¨å†æ¬¡å›é¡¾ä¸€ä¸‹ <a href="../static/wiki/os/2020/demos/trivial-os.c"><code>trival-os.c</code></a>ï¼Œä½ ä»¬ä¸€å®šæ„Ÿåˆ°è‡ªå·±å¯¹æ“ä½œç³»ç»Ÿçš„ç†è§£è¶Šæ¥è¶Šæ·±å…¥äº†ã€‚</p>
<h2 id="2">2. å®éªŒæè¿°</h2>
<h3 id="21">2.1 å®éªŒæ€»è§ˆ</h3>
<p>è¿™ä¸ªå®éªŒåœ¨ pmm å’Œ kmt çš„åŸºç¡€ä¸Šï¼Œåœ¨ç£ç›˜ä¸Šå®ç°æŒä¹…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹çº§åˆ«æ”¯æŒæ–‡ä»¶æè¿°ç¬¦å’Œæ–‡ä»¶/ç›®å½•æ“ä½œ APIâ€”â€”vfs çš„ API çœ‹èµ·æ¥å°±åƒæ˜¯å¤§å®¶åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ä½¿ç”¨çš„é‚£æ ·ï¼</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">ufs_stat</span><span class="p">;</span>
<span class="n">MODULE</span><span class="p">(</span><span class="n">vfs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)();</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">lseek</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oldpath</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newpath</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">unlink</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fstat</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ufs_stat</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">mkdir</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">chdir</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">dup</span><span class="p">)(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>


<p>æ³¨æ„åˆ°æˆ‘ä»¬çš„æ¡†æ¶ä¸­è¿˜æä¾›äº† <code>framework/user.h</code>, è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æˆ·è¿›ç¨‹ (å‡æƒ³æœ‰çš„è¯)/å†…æ ¸ä¹‹é—´å…±äº«çš„ï¼Œå®ƒå®šä¹‰äº†è¯¸å¦‚ <code>struct ufs_stat</code>, ä»¥åŠè‹¥å¹²å‡½æ•°å‚æ•°çš„å«ä¹‰ï¼Œå’Œç›®å½•æ–‡ä»¶çš„æ ¼å¼ã€‚ä¾‹å¦‚ <code>whence</code> ä¸­çš„ <code>SEEK_SET</code>, <code>SEEK_CUR</code> å’Œ <code>SEEK_END</code>ï¼š</p>
<div class="codehilite"><pre><span></span><span class="cp">#define T_DIR     1</span>
<span class="cp">#define T_FILE    2</span>

<span class="cp">#define SEEK_CUR  0</span>
<span class="cp">#define SEEK_SET  1</span>
<span class="cp">#define SEEK_END  2</span>

<span class="cp">#define O_RDONLY  00000000</span>
<span class="cp">#define O_WRONLY  00000001</span>
<span class="cp">#define O_RDWR    00000002</span>
<span class="cp">#define O_CREAT   00000100</span>

<span class="k">struct</span> <span class="n">ufs_stat</span> <span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ufs_dirent</span> <span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">inode</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
</pre></div>


<p>è¯·ä¸è¦ä¿®æ”¹ä¸Šè¿°æ¡†æ¶ä¸­çš„å®šä¹‰ï¼Œä½†æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„è®¾è®¡ã€çº¿ç¨‹åŒæ­¥ç­‰ä½ éƒ½å¯ä»¥è‡ªç”±å‘æŒ¥ï¼è™½ç„¶æ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ç®€å•ï¼Œä½†å®ç°æ–‡ä»¶ç³»ç»Ÿçš„å·¥ä½œé‡å¤Ÿå¤§ (è€Œä¸”è¦å°å¿ƒå¤„ç†å¾ˆå¤š error handling)ï¼Œè¯·ä½ åšå¥½è°ƒè¯•ä»£ç çš„å¿ƒç†å‡†å¤‡ ğŸ˜ã€‚</p>
    </div>
  </div>
</center>

<div class="footer-bottom">
  <center>
    <div class="copyright"> Â© 2020 Yanyan Jiang, All rights reserved </div>
  </center>
</div>


    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>