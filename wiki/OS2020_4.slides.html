<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>å¹¶å‘æ§åˆ¶ (1)ï¼šäº’æ–¥</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="1">å¹¶å‘æ§åˆ¶ (1)ï¼šäº’æ–¥</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>ä¸Šæ¬¡è¯¾ç»™å¤§å®¶ä»‹ç»äº†åŸºç¡€å·¥å…·ï¼šâ€œç¨‹åº = çŠ¶æ€æœº = æœ‰å‘å›¾â€</p>
<ul>
<li>è®²è§£äº† Peterson ç®—æ³•çš„ (ç®€åŒ–çš„) æ­£ç¡®æ€§è¯æ˜</li>
</ul>
<p>Peterson ç®—æ³•åªèƒ½å®ç°ä¸¤ä¸ªçº¿ç¨‹çš„äº’æ–¥</p>
<ul>
<li>å¦‚ä½•æ­£ç¡®å®ç°å¤šå¤„ç†å™¨ä¸Šçš„äº’æ–¥ï¼Ÿ</li>
</ul>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>äº’æ–¥é—®é¢˜</li>
<li>å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</li>
<li>åŸå­æŒ‡ä»¤ä¸äº’æ–¥</li>
<li>æ•°æ®ç«äº‰</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">äº’æ–¥é—®é¢˜</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">äº’æ–¥ï¼šç›´è§‚ç†è§£</h2>
<p>ç†è§£å¹¶å‘çš„å¦ä¸€ä¸ªå·¥å…·ï¼š<span class="red">æŠŠçº¿ç¨‹æƒ³è±¡æˆäººã€æŠŠå…±äº«å†…å­˜æƒ³è±¡æˆç‰©ç†ä¸–ç•Œ</span></p>
<ul>
<li>ç‰©ç†ä¸–ç•Œæ˜¯å¤©ç”Ÿå¹¶å‘çš„ï¼Œåœ¨å°èŒƒå›´å®è§‚æ„ä¹‰ä¸Šï¼Œæ‰€æœ‰éƒ¨åˆ†çš„ç©ºé—´ â€œåŒæ—¶â€ æ²¿ç€æ—¶é—´æ–¹å‘å‰è¿›)<ul>
<li>ç‰©ç†ä¸–ç•Œ = å…±äº«å†…å­˜</li>
<li>æˆ‘ä»¬ (æ ¹æ®æƒ³æ³•æ‰§è¡Œç‰©ç†ä¸–ç•ŒåŠ¨ä½œ) = çº¿ç¨‹ (æ ¹æ®ç¨‹åºå±€éƒ¨çŠ¶æ€è®¿é—®å…±äº«çŠ¶æ€)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">äº’æ–¥ï¼šç›´è§‚ç†è§£</h2>
<p>çº¿ç¨‹ (æˆ‘) æƒ³<span class="red">ä¸è¢«åˆ«äººæ‰“æ–­åœ°</span>åšä¸€ä»¶äº‹</p>
<ul>
<li>ä¸€æ—¦æŸä¸ªäººå·²ç»å¼€å§‹ï¼Œå…¶ä»–äººå°±å¿…é¡»ç­‰å¾…</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/wc.jpg" width="600px"></img></p>
<p><span class="center">â€œèº²è¿›å•æ‰€é”ä¸Šé—¨ï¼Œæˆ‘å°±æŠŠå…¨ä¸–ç•Œäººé”åœ¨äº†å•æ‰€å¤–é¢â€</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥ï¼šé—®é¢˜å®šä¹‰</h2>
<p>äº’æ–¥ (mutual exclusion)ï¼Œâ€œäº’ç›¸æ’æ–¥â€</p>
<ul>
<li>å®ç° <code>lock_t</code> æ•°æ®ç»“æ„å’Œ <code>lock/unlock</code> API:</li>
</ul>
<pre class="codehilite"><code class="language-c">typedef struct {
  ...
} spinlock_t;
void lock(spinlock_t *lk);   // è¯•å›¾è·å¾—é”çš„ç‹¬å è®¿é—®ï¼ŒæˆåŠŸè·å¾—åè¿”å›
void unlock(spinlock_t *lk); // é‡Šæ”¾é”çš„ç‹¬å è®¿é—®</code></pre>

<hr></hr>
<p>ä¸€æŠŠ â€œæ’ä»–æ€§â€ çš„é”â€”â€”å¯¹äºé”å¯¹è±¡ <code>lk</code></p>
<ul>
<li>åœ¨ä»»ä½•çº¿ç¨‹è°ƒåº¦ (çº¿ç¨‹æ‰§è¡Œçš„é¡ºåº) ä¸‹<ul>
<li>è‹¥æŸä¸ªçº¿ç¨‹æŒæœ‰é” (<code>lock(lk)</code> è¿”å›ä¸”æœªé‡Šæ”¾)</li>
<li>åˆ™ä»»ä½•å…¶ä»–çº¿ç¨‹çš„ <code>lock(lk)</code> éƒ½ä¸èƒ½è¿”å› </li>
</ul>
</li>
</ul>
<p>çŠ¶æ€æœºçš„è§†è§’</p>
<ul>
<li><code>lock</code> è¿”å›ä¼šè¿›å…¥ â€œlockedâ€ çŠ¶æ€; <code>unlock</code> ä¼šæ¸…é™¤è¯¥çŠ¶æ€</li>
<li>åˆå§‹çŠ¶æ€ <math class="inline-math">s_0</math> ä¸èƒ½åˆ°è¾¾ä¸¤ä¸ªçº¿ç¨‹éƒ½è¿›å…¥ locked çš„çŠ¶æ€ </li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">äº’æ–¥ï¼šé˜»æ­¢å¹¶å‘çš„å‘ç”Ÿ</h2>
<p>åœ¨å…±äº«å†…å­˜ä¸Šï¼Œå…±äº«èµ„æºçš„è®¿é—®å¤ªå±é™© (åŸå­æ€§ã€é¡ºåºã€å¯è§æ€§çš„ä¸§å¤±)ï¼Œäº’æ–¥ç”¨æ¥é˜»æ­¢ä»£ç å—ä¹‹é—´çš„å¹¶å‘ï¼Œå®ç° â€œ<span class="red">ä¸²è¡ŒåŒ–</span>â€</p>
<ul>
<li>lock/unlock ä¿æŠ¤çš„åŒºåŸŸæˆä¸ºä¸€ä¸ª<span class="red">åŸå­</span>çš„é»‘ç›’å­</li>
<li>é»‘ç›’å­çš„ä»£ç ä¸èƒ½éšæ„å¹¶å‘ï¼Œ<span class="red">é¡ºåº</span>æ»¡è¶³è¦ä¹ˆ <math class="inline-math">T_1 \to T_2</math>ï¼Œè¦ä¹ˆ <math class="inline-math">T_2 \to T_1</math></li>
<li>ä¸”å…ˆå®Œæˆçš„é»‘ç›’å­çš„å†…å­˜è®¿é—®åœ¨ä¹‹åçš„é»‘ç›’å­ä¸­<span class="red">å¯è§</span></li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/serialization.png" width="800px"></img></p></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å…±äº«å†…å­˜ä¸Šçš„äº’æ–¥</h2>
<p>å…±äº«å†…å­˜å¤šçº¿ç¨‹ï¼šç‹¬ç«‹çš„å¯„å­˜å™¨/å †æ ˆï¼›å…±äº«å†…å­˜</p>
<p>æ”¯æŒçš„åŸºæœ¬æ“ä½œ</p>
<ul>
<li>çº¿ç¨‹æœ¬åœ° (thread-local) è®¡ç®— (å¯„å­˜å™¨/å †æ ˆä¸Šæ•°å€¼çš„è¯»å†™/ä¿®æ”¹)</li>
<li>loadï¼Œè¯»å…±äº«å†…å­˜</li>
<li>storeï¼Œå†™å…±äº«å†…å­˜</li>
<li>å‡è®¾ load/store æ˜¯åŸå­çš„<ul>
<li>çŠ¶æ€æœºæ¯æ¬¡æ‰§è¡Œä¸€æ¡ load/store</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å›°éš¾ä¹‹å¤„åœ¨äºï¼š<span class="red">ä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜</span></p>
<ul>
<li>load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œå¹²çœ‹â€</li>
<li>store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€</li>
<li>æ‰€ä»¥æ‰æœ‰ Peterson ç­‰éå¸¸ â€œå·§å¦™â€ çš„ç®—æ³•<ul>
<li><del>ä¸€ç‚¹ä¹Ÿä¸åƒ system çš„è§£å†³æ–¹æ¡ˆï¼šç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆ</del></li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="peterson">Peterson ç®—æ³•çš„çœŸæ­£é—®é¢˜</h2>
<pre class="codehilite"><code class="language-c">int x = 0, y = 0;

void thread_1() {
  [1] store(x, 1); // å¤„ç†å™¨å…è®¸ 1-2 â€œäº¤æ¢â€
  [2] t = load(y);
  [3] printf("y = %d\n", t);
}

void thread_2() {
  [1] store(y, 1); // å¤„ç†å™¨å…è®¸ 1-2 â€œäº¤æ¢â€
  [2] t = load(x);
  [3] printf("x = %d\n", t);
}</code></pre>


<hr></hr>
<p>å®éªŒç»“æœ (4 x Xeon X7460, 24-cores)</p>
<p><span class="float-right"><img src="../static/wiki/os/2019/img/question.jpg" width="150px/"></img> </span>
<table>
<thead>
<tr>
<th>æ‰“å°çš„ x</th>
<th>æ‰“å°çš„ y</th>
<th>æ¦‚ç‡</th>
<th>å¯èƒ½çš„è°ƒåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td><font color="red">0.2%</font></td>
<td>å¼±å†…å­˜ä¸€è‡´æ€§</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>82.3%</td>
<td>3 â†’ 4 â†’ 1 â†’ 2</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>17.5%</td>
<td>1 â†’ 2 â†’ 3 â†’ 4</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td><font color="red">0.0%</font></td>
<td>1 â†’ 3 â†’ 2 â†’ 4</td>
</tr>
</tbody>
</table></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="peterson-contd">Peterson ç®—æ³•çš„çœŸæ­£é—®é¢˜ (cont'd)</h2>
<pre class="codehilite"><code class="language-c">int turn = T1, x = 0, y = 0;

void thread1() {
  [1] store(x,    1);  // ä¸¾èµ· T1 çš„æ——å­
  [2] store(turn, T2); // åœ¨ç‰Œå­ä¸Šç¤¼è²Œåœ°å†™ä¸Šå¯¹æ–¹çš„åå­— (T2)
spin:
  [3] t1 = load(y);    // !!! x, y, turn æ˜¯ä¸åŒçš„å˜é‡ !!!
  [4] if (!t1)      goto critical_section;  // å¦‚æœå¯¹æ–¹æ²¡æœ‰ä¸¾èµ·æ——å­
  [5] t2 = load(turn);
  [6] if (t2 != T2) goto critical_section;  // æˆ–è€…ç‰Œå­ä¸Šå†™ç€è‡ªå·± (T1)
  [7] goto spin;
critical_section:
  ...

void thread2() {
  [1] store(y,    1);  // ä¸¾èµ· T2 çš„æ——å­
  [2] store(turn, T1); // åœ¨ç‰Œå­ä¸Šå†™ä¸Š T1
spin:
  [3] t1 = load(x);
  [4] if (!t1)      goto critical_section;  // å¦‚æœå¯¹æ–¹æ²¡æœ‰ä¸¾èµ·æ——å­
  [5] t2 = load(turn);
  [6] if (t2 != T1) goto critical_section;  // æˆ–è€…ç‰Œå­ä¸Šå†™ç€è‡ªå·± (T2)
  [7] goto spin;
critical_section:
  ...</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å…±äº«å†…å­˜å¸¦æ¥çš„æ›´å¤šé—®é¢˜â€¦â€¦</h2>
<p><a href="../static/wiki/os/2020/demos/sum.c"><code>sum.c</code></a>ï¼Œå¤šçº¿ç¨‹æ±‚ <math>1+1+\ldots+1</math></p>
<ul>
<li>ä½¿ç”¨ä¸€æ¡æŒ‡ä»¤å®Œæˆ <code>sum++</code><ul>
<li><code>48 83 05 xx xx xx xx 01</code>: <code>addq $0x1,xxx(%rip)</code></li>
</ul>
</li>
</ul>
<div class="fragment">
<ul>
<li>è¿è¡Œç»“æœ<ul>
<li><code>sum = 12615418</code><ul>
<li>å‡è®¾æŒ‡ä»¤æ‰§è¡Œæ˜¯åŸå­ä¸å¯åˆ†å‰²çš„ï¼Œé‚£ä¹ˆ <code>sum</code> åº”è¯¥å®Œå…¨æ­£ç¡®æ‰å¯¹</li>
</ul>
</li>
<li><p><code>sum = 9894505</code></p>
<ul>
<li>åç›´è§‰ï¼Ÿä¸€æ¡ <code>add</code> å¯ä»¥çœ‹æˆ <code>t = load(x); t++; store(x, t)</code></li>
<li>(20 è¡Œ) <a href="../static/wiki/os/2020/demos/trivial-model-checker.py">trivial-model-checker.py</a></li>
</ul>
<p><img alt="" src="../static/wiki/os/2019/img/question.jpg" width="150px"></img></p>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="x86">x86 å¤„ç†å™¨çš„å…±äº«å†…å­˜æ¨¡å‹</h2>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/x86-tso.png" width="640px"></img></p>
<p>Further reading: <a href="https://cacm.acm.org/magazines/2010/7/95048-x86-tso-a-rigorous-and-usable-programmers-model-for-x86-multiprocessors/fulltext">x86-TSO: A rigorous and Â­usable programmer's model for x86 multiprocessors</a></p>
<ul>
<li>ä¹±åºæ‰§è¡Œä½¿å•çº¿ç¨‹ç¨‹åºæ‰§è¡Œå¾—æ›´å¿«ï¼›åŒæ—¶ä¹Ÿè®©å¹¶è¡Œç¨‹åºçš„è¡Œä¸ºæ›´éš¾ç†è§£</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å®ç°äº’æ–¥çš„çœŸæ­£å›°éš¾</h2>
<p>å…±äº«å†…å­˜çš„è¡Œä¸ºç»å¸¸å‡ºä¹æˆ‘ä»¬çš„æ„æ–™</p>
<ul>
<li><span class="red">â€œçŠ¶æ€æœºæ¯ä¸€æ­¥é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€æ¡æŒ‡ä»¤â€ æ˜¯é”™è¯¯çš„å‡è®¾</span></li>
<li>ä¸ç»æ„çš„ç¼–è¯‘å™¨/å¤„ç†å™¨ä¹±åº</li>
<li>çœ‹èµ·æ¥ â€œåŸå­â€ (ä¸å¯åˆ†å‰²) çš„ä¸€æ¡æŒ‡ä»¤å¹¶ä¸åŸå­</li>
</ul>
<blockquote>
<p>For some reason, developing locks that work without special hardware support became all the rage for a while, giving theory-types a lot of problems to work on. Of course, this line of work became quite useless when people realized it is much easier to assume a little hardware support (and indeed that support had been around from the earliest days of multiprocessing). Further, algorithms like the ones above donâ€™t work on modern hardware (due to relaxed memory consistency models), thus making them even less useful than they were before. Yet more research relegated to the dustbin of history...</p>
</blockquote></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å®ç°äº’æ–¥ï¼šè½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å›é¡¾ï¼šåœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥çš„æœ¬è´¨å›°éš¾</h2>
<ol>
<li>load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œå¹²çœ‹â€</li>
<li>store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€</li>
<li>(ç°ä»£å¤šå¤„ç†å™¨) load/store å¯èƒ½åœ¨æ‰§è¡Œæ—¶è¢«ä¹±åº</li>
</ol>
<p>ä¾‹å­ï¼šç”¨ä¸€ä¸ªå˜é‡ <code>locked</code> å®ç°äº’æ–¥</p>
<pre class="codehilite"><code class="language-c">void critical_section() {
     while (1)
[1]    if (!locked) {
[2]      locked = 1;
[3]      break;
       }
     // è¿›å…¥ä¸´ç•ŒåŒº
[4]    locked = 0;
}</code></pre>

<ul>
<li>ç”¨çŠ¶æ€æœºæ¨¡å‹åˆ†æï¼š<math class="inline-math">T_1 \to T_2</math> æˆ– <math class="inline-math">T_2 \to T_1</math> ä¼šåŒæ—¶è¿›å…¥ä¸´ç•ŒåŒº</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="load-store">å¦‚æœèƒ½ä¸è¢«æ‰“æ–­åœ°åŒæ—¶ load + storeâ€¦â€¦</h2>
<p>åœ¨åˆå§‹çŠ¶æ€ï¼Œå¦‚æœæ‰§è¡Œ <math class="inline-math">T_1 \to T_1</math> æˆ– <math class="inline-math">T_2 \to T_2</math>ï¼Œå°±å¯ä»¥æ­£ç¡®å®ç°äº’æ–¥</p>
<ul>
<li><p>å³å®ç°äº’æ–¥åªéœ€è¦èƒ½<span class="red">åŒæ—¶å®Œæˆ</span></p>
<ul>
<li><code>t = load(locked)</code></li>
<li><code>if (t == 0) store(locked, 1)</code></li>
</ul>
</li>
<li><p>é‚£å°±åœ¨ç¡¬ä»¶ä¸Šæ·»åŠ ä¸€æ¡æŒ‡ä»¤å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå°±å¥½äº†ï¼Ÿ</p>
<ul>
<li>ä¸Šé¢çš„æŒ‡ä»¤ç§°ä¸º â€œtest-and-setâ€</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">åŸå­æŒ‡ä»¤ (æ“ä½œ)</h2>
<p>ä¸€æ¡ä¸å¯åˆ†å‰²çš„æŒ‡ä»¤ï¼Œå®Œæˆï¼š</p>
<ul>
<li>ä¸€æ¬¡å…±äº«å†…å­˜çš„ load</li>
<li>å‘åŒä¸€ä¸ªå…±äº«å†…å­˜åœ°å€çš„ store</li>
<li>ä»¥åŠä¸€äº›çº¿ç¨‹ (å¤„ç†å™¨) æœ¬åœ°çš„è®¡ç®—</li>
</ul>
<hr></hr>
<p>åœ¨å¤šå¤„ç†å™¨ä¸Šï¼ŒåŸå­æ“ä½œä¿è¯ï¼š</p>
<ul>
<li><span class="red">åŸå­æ€§</span>: load/store ä¸ä¼šè¢«æ‰“æ–­</li>
<li><span class="red">é¡ºåº</span>ï¼šçº¿ç¨‹ (å¤„ç†å™¨) æ‰§è¡Œçš„ä¹±åºåªèƒ½ä¸èƒ½è¶Šè¿‡åŸå­æ“ä½œ</li>
<li><span class="red">å¤šå¤„ç†å™¨ä¹‹é—´çš„å¯è§æ€§</span>ï¼šè‹¥åŸå­æ“ä½œ <math class="inline-math">A</math> å‘ç”Ÿåœ¨ <math class="inline-math">B</math> ä¹‹å‰ï¼Œåˆ™ <math class="inline-math">A</math> ä¹‹å‰çš„ store å¯¹ <math class="inline-math">B</math> ä¹‹åçš„ load å¯è§</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="x86-lock">x86 åŸå­æ“ä½œï¼š<code>LOCK</code> æŒ‡ä»¤å‰ç¼€</h2>
<p>ä¾‹å­ï¼š<a href="../static/wiki/os/2020/demos/sum-atomic.c"><code>sum-atomic.c</code></a></p>
<ul>
<li><span class="red"><code>f0</code></span> <code>48 83 05 xx xx xx xx 01</code>: <code>lock addq $0x1,xxx(%rip)</code><ul>
<li><code>sum = 40000000</code></li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="x86-xchg">x86 åŸå­æ“ä½œï¼š<code>xchg</code></h2>
<pre class="codehilite"><code class="language-c">int xchg(volatile int *addr, int newval) {
  int result;
  asm volatile ("lock xchg %0, %1"
  : "+m"(*addr), // [%0] addr (å†…å­˜ï¼›è¯»å†™)
    "=a"(result) // [%1] result (%eax)
  : "1"(newval)  // [%1]
  : "cc");       // clobbers eflags
  return result;
}</code></pre>


<p>æ€è€ƒé¢˜ï¼šå¦‚ä½•ç”¨ <code>xchg</code> å®ç° <code>lock</code>/<code>unlock</code>ï¼Ÿ</p>
<ul>
<li>æŠŠçº¿ç¨‹æƒ³è±¡æˆäºº</li>
<li>æŠŠå…±äº«å†…å­˜æƒ³è±¡æˆç‰©ç†ç©ºé—´<ul>
<li><code>xchg</code>: ç¬é—´å®Œæˆã€ä¸è¢«æ‰“æ–­çš„é£é¾™æ¢äº‘æ‰‹ï¼Œå¹¶ä¸”èƒ½ç•™ä¸‹æ¢è¿‡çš„è¯æ®</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="xchg"><code>xchg</code> å®ç°äº’æ–¥</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2019/img/no-key.jpg" width="250px"></img></p>
<p>å¦‚ä½•åè°ƒå®¿èˆè‹¥å¹²ä½åŒå­¦ä¸Šå•æ‰€é—®é¢˜ï¼Ÿ</p>
<ul>
<li>åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡)<ul>
<li>åˆå§‹æ—¶ï¼Œæ¡Œä¸Šæ˜¯ ğŸ”‘</li>
</ul>
</li>
<li>æ¯ä¸ªåŒå­¦å¯ä»¥åšä¸€ç§æ“ä½œ<ul>
<li>æ‹¿å­—æ¡ ğŸ”–  å’Œæ¡Œä¸Šçš„ç‰©å“äº¤æ¢ï¼Œç«‹å³ç”Ÿæ•ˆä¸è¢«æ‰“æ–­ (atomic-xchg)</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å®ç°äº’æ–¥çš„åè®®</p>
<ul>
<li>æƒ³ä¸Šå•æ‰€çš„åŒå­¦ï¼Œæ‹¿ä¸€å¼  ğŸ”– å­—æ¡å’Œæ¡Œä¸Šçš„ä¸œè¥¿äº¤æ¢<ul>
<li>å¾—åˆ° ğŸ”‘: è¿›å…¥å•æ‰€</li>
<li>å¾—åˆ°å­—æ¡ ğŸ”–: ç­‰å¾…ä¸€ä¼šï¼Œç„¶åå†è¯•ï¼Œç›´åˆ°æ‹¿åˆ° ğŸ”‘ ä¸ºæ­¢</li>
</ul>
</li>
<li>å‡ºå•æ‰€çš„åŒå­¦<ul>
<li>å°†æ‰‹ä¸Šçš„ ğŸ”‘ å’Œæ¡Œä¸Šçš„ç‰©å“ (ğŸ”–) äº¤æ¢ (è¿˜é’¥åŒ™)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/spin.png" width="75px"></img></p>
<h2 id="_1">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h2>
<pre class="codehilite"><code class="language-c">int table = KEY;
void lock() {
  while (1) {
    int got = xchg(&table, NOTE);
    if (got == KEY) break;
  }
}
void unlock() {
  xchg(&table, KEY)
}</code></pre>
<div class="fragment">
<pre class="codehilite"><code class="language-c">int locked = 0;
void lock()   {
  while (xchg(&locked, 1)) ;
}

void unlock() {
  xchg(&locked, 0);
}</code></pre>


<ul>
<li>æ¼”ç¤ºï¼š<a href="../static/wiki/os/2020/demos/spinlock.c">spinlock.c</a></li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="risc-v">RISC-V: å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡</h2>
<p>è€ƒè™‘åŸå­æ“ä½œï¼š</p>
<ul>
<li>atomic test-and-set<ul>
<li><code>reg = load(x); if (reg == XX) { store(x, YY); }</code></li>
</ul>
</li>
<li>lock xchg<ul>
<li><code>reg = load(x); store(x, XX);</code></li>
</ul>
</li>
<li>lock add<ul>
<li><code>t = load(x); t++; store(x, t);</code></li>
</ul>
</li>
</ul>
<hr></hr>
<p>å®ƒä»¬çš„æœ¬è´¨éƒ½æ˜¯ï¼š</p>
<ol>
<li>load(x)</li>
<li>è®¾ç½®å¤„ç†å™¨å±€éƒ¨ (å¯„å­˜å™¨) çŠ¶æ€</li>
<li>store(x)</li>
</ol></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="load-reservedstore-conditional-lrsc">Load-Reserved/Store-Conditional (LR/SC)</h2>
<p>Load Reserved</p>
<ol>
<li>å®Œæˆ <code>load(x, v)</code></li>
<li>åœ¨å¤„ç†å™¨ä¸Šæ ‡è®°å†…å­˜ <code>x</code> è¢« â€œreservedâ€ (ç›¯ä¸Šä½ äº†)<ul>
<li>ä¹‹åå¯ä»¥è‡ªç”±æ‰§è¡Œå‡ ä¹ä»»ä½•çº¿ç¨‹æœ¬åœ°çš„è®¡ç®—</li>
<li>ä½†ä¸€æ—¦å…¶ä»–å¤„ç†å™¨å†™å…¥ <code>x</code>ï¼Œæˆ–å½“å‰å¤„ç†å™¨å‘ç”Ÿä¸­æ–­/å¼‚å¸¸ï¼Œreserved çš„çŠ¶æ€å°±å¤±æ•ˆ</li>
</ul>
</li>
</ol>
<p>Store Conditional</p>
<ol>
<li>å°è¯•å®Œæˆ <code>store(x, v)</code><ul>
<li>å¦‚æœ <code>x</code> ä¾ç„¶å¤„äº â€œreservedâ€ çŠ¶æ€<ul>
<li>store æˆåŠŸï¼Œè¿”å› 0</li>
</ul>
</li>
<li>å¦åˆ™ store å¤±è´¥ (åŒ…æ‹¬ store è¿‡ç¨‹ä¸­ reserved å¤±æ•ˆ)ï¼Œè¿”å› 1</li>
</ul>
</li>
</ol></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lrsc">LR/SC: çš„é“ç†</h2>
<p>åªè¦ lr/sc æ»¡è¶³é¡ºåº/å¯è§æ€§/åŸå­æ€§ï¼Œlr åˆ° sc ä¹‹é—´çš„åŒºåŸŸå°±æ˜¯åŸå­çš„ï¼</p>
<ul>
<li>ç”¨åŸå­çš„ load/store å®ç°äº†ä¸€æ®µä»£ç çš„åŸå­æ€§ (ç²¾å¦™)<ul>
<li>å¶å°”ä¼šå¤±è´¥ï¼Œæä¾› abort æœºåˆ¶</li>
</ul>
</li>
</ul>
<pre class="codehilite"><code class="language-c">void do_lrsc(){
     while (1) {
[1]    t = lr(x);
[2]    t = f1/f2(t); // ä¸åŒçº¿ç¨‹å¯ä»¥æ‰§è¡Œä¸åŒæ“ä½œ
[3]    if (sc(x, t) == SUCC) {
[4]      break;
       }
     }
}</code></pre>


<ul>
<li>çŠ¶æ€æœºå»ºæ¨¡</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="cas-lrsc">CAS çš„ LR/SC å®ç°</h2>
<pre class="codehilite"><code class="language-c">int cas(int *addr, int cmp_val, int new_val) {
  int old_val = *addr;
  if (old_val == cmp_val) {
    *addr = new_val;
    return 0;
  } else {
    return 1;
  }
}</code></pre>


<pre class="codehilite"><code class="language-text">cas:
  jlr.w t0, (a0)       # Load original value.
  bne   t0, a1, fail   # Doesnâ€™t match, so fail.
  sc.w  t0, a2, (a0)   # Try to update.
  bnez  t0, cas        # Retry if store-conditional failed.
  li a0, 0             # Set return to success.
  jr ra                # Return.
fail:
  li a0, 1             # Set return to failure.
  jr ra                # Return</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lrsc">LR/SC çš„ç¡¬ä»¶å®ç°</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/boom-pipeline-detailed.png" width="350px"></img></p>
<p>BOOM (Berkeley Out-of-Order Processor)</p>
<ul>
<li><a href="https://github.com/riscv-boom/riscv-boom">riscv-boom</a><ul>
<li><a href="https://github.com/riscv-boom/riscv-boom/blob/master/src/main/scala/lsu/dcache.scala#L651"><code>riscv-boom/**/lsu/dcache.scala</code></a></li>
<li>æ„Ÿè°¢ yzh æ‰’å‡ºäº†ä»£ç å’Œå¯¹ä»£ç çš„è§£é‡Š</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ä»€ä¹ˆæ˜¯ â€œCPU çš„å®ç°â€ï¼Ÿ</p>
<ul>
<li>CPU = æ•°å­—é€»è¾‘ç”µè·¯<ul>
<li>å¯„å­˜å™¨ + ç»„åˆé€»è¾‘</li>
</ul>
</li>
<li>ç¡¬ä»¶æè¿°è¯­è¨€ (HDL, Hardware Description Language)<ul>
<li>Verilog HDL, VHDL, ...</li>
<li><a href="https://www.chisel-lang.org/">Chisel</a> (on Scala)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lrsc-on-boom">LR/SC on BOOM</h2>
<pre class="codehilite"><code class="language-scala">// s2 == pipeline stage #2
val lrsc_count = RegInit(0.U(log2Ceil(lrscCycles).W))
val lrsc_valid = lrsc_count &gt; lrscBackoff.U
...
val s2_lrsc_addr_match = widthMap(
     w =&gt; lrsc_valid
  && lrsc_addr === (s2_req(w).addr &gt;&gt; blockOffBits) ) // req åœ°å€åŒ¹é…
...

// val memWidth = memIssueParam.issueWidth (parameters.scala)
for (w &lt;- 0 until memWidth) {
  when (s2_valid(w)                            &&
    s2_type === t_lsu                          &&
    !s2_hit(w)                                 && // not hit
    !(s2_has_permission(w) && s2_tag_match(w)) &&
    s2_lrsc_addr_match(w)                      && // åœ°å€åŒ¹é…
    !s2_nack(w)) {
    lrsc_count := 0.U
  }
}</code></pre></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="data-race">æ•°æ®ç«äº‰ (Data Race)</h1>
<p><img alt="" src="../static/wiki/os/2020/slides/img/race.jpg" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">é˜»æ­¢å¹¶å‘å‘ç”Ÿï¼šå¤±è´¥çš„ä¾‹å­</h2>
<p>å¹¶ä¸æ˜¯åœ¨ <code>sum++</code> å‰ååŠ ä¸ŠåŸå­æ“ä½œï¼Œå°±èƒ½å®ç°äº’æ–¥</p>
<pre class="codehilite"><code class="language-c">spinlock_t lk1, lk2;

void thread1() {
  spin_lock(&lk1);
  sum++;
  spin_unlock(&lk1);
}

void thread2() {
  spin_lock(&lk2);
  sum++;
  spin_unlock(&lk2);
}</code></pre>


<hr></hr>
<p>å¦‚ä½•è§£é‡Š â€œ<span class="red">ä»€ä¹ˆæ ·çš„ç¨‹åºæ˜¯æ­£ç¡®çš„ã€ä»€ä¹ˆæ ·çš„ç¨‹åºä¸æ­£ç¡®</span>ï¼Ÿâ€</p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ•°æ®ç«äº‰</h2>
<p>æ•°æ®ç«äº‰ï¼šä¸¤ä¸ª<span class="red">ä¸åŒçš„çº¿ç¨‹</span>çš„ä¸¤ä¸ªæ“ä½œè®¿é—®<span class="red">åŒä¸€æ®µå†…å­˜</span>ï¼Œä¸”<span class="red">è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ store</span>ï¼Œå…¶ä¸­æ²¡æœ‰åŸå­æ“ä½œé—´éš”</p>
<ul>
<li>ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ (<code>sum</code>)ï¼Œâ€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œ (å¯¼è‡´ä¸ç¡®å®šæ€§)</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/data-race.png" width="640px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="contd">æ•°æ®ç«äº‰ (cont'd)</h2>
<p>å¦‚æœç¨‹åºæ²¡æœ‰æ•°æ®ç«äº‰ (race-free)ï¼Œé‚£ä¹ˆï¼š </p>
<ul>
<li>ä¸¤ä¸ªæ¥è‡ªä¸åŒçº¿ç¨‹å¯¹åŒä¸€æ®µå†…å­˜çš„è®¿é—® (è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ store) ä¹‹é—´å¿…å®šæœ‰åŸå­æ“ä½œ<ul>
<li>load/store, store/load, store/store</li>
</ul>
</li>
<li>åŸå­æ“ä½œä¿è¯äº†<ul>
<li>é¡ºåº</li>
<li>å¯è§æ€§</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å¹¶å‘ç¼–ç¨‹çš„ç®€å•å‡†åˆ™</h2>
<p>å¦‚æœä½ æ˜¯è®¨åŒå¹¶å‘ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼Œæƒ³ç”¨æœ€å°‘çš„ä»£ä»·ä¿è¯å¹¶å‘ç¨‹åºçš„æ­£ç¡®æ€§</p>
<p><img alt="" class="float-right" src="../static/wiki/os/2019/img/question.jpg" width="175px"></img></p>
<ul>
<li><span class="red">æ•°æ®ç«äº‰ = undefined behavior</span><ul>
<li>ä¹‹å‰é»‘äººé—®å·çš„ä¾‹å­</li>
<li><code>sum++</code> çš„å¾ªç¯</li>
<li>Peterson ç®—æ³•</li>
<li>é”æ²¡æœ‰æ­£ç¡®ä¿æŠ¤çš„ <code>sum++</code><ul>
<li>ç»Ÿç»Ÿéƒ½æ˜¯ UB (ç®—å‡ºä»»ä½•ç»“æœéƒ½ä¸è¶³ä¸ºå¥‡)</li>
<li>æˆ‘ä»¬éƒ½è¦é¿å…</li>
</ul>
</li>
</ul>
</li>
<li><span class="red">ç¼–ç¨‹æ—¶åº”è¯¥å½»åº•é¿å…æ•°æ®ç«äº‰</span><ul>
<li>å……åˆ†æ¡ä»¶ï¼šä½¿æ‰€æœ‰çº¿ç¨‹é—´å…±äº«çš„å˜é‡éƒ½è¢«åŒä¸€æŠŠäº’æ–¥é”ä¿æŠ¤</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>äº’æ–¥ï¼šå®ç° <code>lock</code>/<code>unlock</code>ï¼Œé˜»æ­¢ä»£ç ç‰‡æ®µå¹¶å‘</p>
<ul>
<li>lock/unlock ä¹‹é—´çš„ â€œé»‘ç›’å­â€ åŸå­æ€§ã€é¡ºåºã€å¯è§æ€§å¾—åˆ°ä¿è¯</li>
<li>ä¾é ç¡¬ä»¶æŒ‡ä»¤å®ç°ï¼šxchg, lr/sc, ...<ul>
<li>ç”¨çŠ¶æ€æœºå¯ä»¥å¾ˆå®¹æ˜“åœ°ç†è§£å®ƒä»¬</li>
</ul>
</li>
<li>ä¸€ä¸ªå®ç”¨çš„å‡è®¾ï¼š<span class="red">æ•°æ®ç«äº‰ = undefined behavior</span></li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜</p>
<ul>
<li>åœ¨ <code>threads.h</code> é‡Œå®ç°äº’æ–¥å¹¶æµ‹è¯•</li>
<li>æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦å¤šå¤„ç†å™¨ï¼Ÿ<ul>
<li>æ•°æ®ç«äº‰è¦é¿å…</li>
<li>äº’æ–¥é”ä¼šä¸²è¡ŒåŒ–ä»£ç <ul>
<li>å¤šå¤„ç†å™¨å°±é€€åŒ–æˆå•å¤„ç†å™¨äº†ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>