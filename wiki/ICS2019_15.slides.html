<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/wiki.css"/>
<link rel="stylesheet" href="../static/css/slides.css"/>


    <title>è½®å­æ˜¯å¦‚ä½•åšæˆçš„ (2)</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: True
class: center, middle

# è½®å­æ˜¯å¦‚ä½•åšæˆçš„ (2)

è’‹ç‚å²© <jyy@nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# ptrace æœºåˆ¶

è¢«è¿½è¸ªè¿›ç¨‹ (tracee)

* ä½¿ç”¨ ptrace ç³»ç»Ÿè°ƒç”¨

    ```c
    long ptrace(enum __ptrace_request request, pid_t pid,
                void *addr, void *data);
    ```
    * `PTRACE_(TRACEME|ATTACH)` - è®¾ç½®è¿½è¸ª
    * `PTRACE_PEEK(USER|DATA)` - è¯»å–å¯„å­˜å™¨/æ•°æ®
    * `PTRACE_POKE(USER|DATA)` - æ”¹å†™å¯„å­˜å™¨/æ•°æ® (gdb å°±æ˜¯é è¿™ä¸ªåœ¨æ–­ç‚¹å¤„ patch `INT3`)

----

è¿½è¸ªè¿›ç¨‹ (tracer)

* ä½¿ç”¨ waitpid ç³»ç»Ÿè°ƒç”¨ç­‰å¾…äº‹ä»¶
    * gdb ä¼šæ•æ‰åˆ°è¢«è°ƒè¯•è¿›ç¨‹çš„ `INT3`

---

# Trace å·¥å…·

Trace (è½¨è¿¹ã€è¸ªè¿¹ã€è¿½è¸ª)

* ç›¸å½“äºè‡ªåŠ¨çš„ â€œprintfâ€ è°ƒè¯•å·¥å…·ï¼Œéå¸¸å¥½ç”¨
* Linux è‡ªå¸¦
    * strace (system call trace)
    * ltrace (library call trace)
    * perf (Kernel profiler/trace)

--
count: false
----

strace æ˜¯åŸºäº ptrace å®ç°çš„

* [strace.c](/static/wiki/ics/2019/files/strace.c) 

ltrace æ˜¯åŸºäºåŠ¨æ€é“¾æ¥å®ç°çš„

---

# é‡å¤é€ è½®å­çš„ä¹è¶£

â€œStop trying to reinvent the wheel!â€

* ä½ ç°åœ¨è´¹åŠ›å®ç°çš„æ¯ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯èƒ½å¼€æºç¤¾åŒºæ—©å·²ç»æœ‰æå¥½çš„è§£å†³æ–¹æ³•äº†
* è½¯ä»¶å·¥ç¨‹çš„é»„é‡‘å‡†åˆ™ä¹‹ä¸€

----

ç«™åœ¨åŒå­¦ä»¬çš„è§’åº¦

* .red[é€ è¿‡è½®å­æ‰çŸ¥é“å…¶ä¸­çš„å¥¥å¦™]
    * Project-N (å¤§è½®å­): å¤„ç†å™¨/SoCã€è™šæ‹Ÿæœºã€æ“ä½œç³»ç»Ÿã€ç¼–è¯‘å™¨
    * è¯¾ç¨‹å®éªŒ/ç¤ºä¾‹ä»£ç  (å°è½®å­): setjmp/longjmp, debugger, strace, coroutine, kalloc, ...

---
class: center, middle

# äºŒå‘¨ç›®æ€»ç»“

---

# å·²ç»è§£å†³çš„ä¸€å‘¨ç›®é—®é¢˜

é€»è¾‘è·³è·ƒ

* æ¯ä¸€æ¬¡è¯¾éƒ½æœ‰ä¸»çº¿å’Œæ ¹æ®ä¸»çº¿å±•å¼€çš„å†…å®¹
* ä¸‰å‘¨ç›®æ”¹è¿›
    * é¢„å…ˆè§„åˆ’å¥½æ¿ä¹¦ (éƒ¨åˆ† lectures å–å¾—äº†æˆåŠŸ)

----

ä»£ç è®²å¾—è¿˜ä¸å¤Ÿ

* åŠ å…¥äº†ä¸€äº›ç¤ºä¾‹ä»£ç 
* ä¸‰å‘¨ç›®æ”¹è¿› (ç›®å‰ä»£ç è¿˜ä¸å¤Ÿå¤š)
    * è®¡ç®—æœºç³»ç»Ÿä¸­çš„æŠ½è±¡
    * å­˜å‚¨å™¨ä½“ç³»ç»“æ„
    * GPGPU
    * è¡¨è¾¾å¼ç‰ˆ gcc (ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥)

---

# äºŒå‘¨ç›®é—®é¢˜

éƒ¨åˆ†è¯¾ç¨‹æ•ˆæœä¸å¥½

* æœ‰æ¬¡è®²ä»£ç è®²åˆ°æœ€åæ²¡äººçŸ¥é“æˆ‘åœ¨è®²ä»€ä¹ˆäº†â€¦â€¦

--
count: false
----

å¯¹å¤§å®¶å¼ºåˆ¶ä¸å¤Ÿ (åˆ†ç­ä¸Šè¯¾ï¼Œå¹³å‡è¿›åº¦å·®è· 1.5 ç« )

* ä¼°è®¡å¤§å®¶æœ€åä¸ºäº†èƒ½è¿‡ï¼Œå¤šå¤šå°‘å°‘åªèƒ½æŠ„äº†

--
count: false
----

ä»£ç å­¦ä¹ æ²¡æœ‰ç®¡æ§

* çš„ç¡®æœ‰å¾ˆå¤šä»£ç ä¾‹å­ (slides ä¸­çš„é“¾æ¥)ï¼Œæ¶ä¸ä½å¤§å®¶ä¸çœ‹å•Š ğŸ˜‚

--
count: false
----

å…¶ä»–

* æ¬¢è¿æå‡º
* æ¯”å¦‚æ˜¯ä¸æ˜¯æˆ‘è¿˜æ˜¯è®²å¤ªå¿«äº†â€¦â€¦

---
class: center, middle
exclude: true

# ç¦åˆ©ï¼šæœŸæœ«è¯•å·è®²è¯„

---
exclude: true

# ä»£ç  (main.c)

```c
typedef struct record {
  ......
} RECORD;
typedef struct index {
  unsigned char key;
  RECORD *pdata;
} INDEX;
extern void sort();
INDEX rec_idx[256];
const int rec_num = 256;
void main(int argc, char *argv[])
{ FILE *fp = fopen(argv[1], "rb");
  if (fp) {
    fread(rec_idx, sizeof(INDEX), rec_num, fp);
    fclose(fp);
  } else exit(1);
  sort();
}
```

---
exclude: true

# ä»£ç  (sort.c)

```c
extern INDEX rec_idx[];
extern const int rec_num;
void sort() {
  int i, swapped;
  INDEX temp;
  do { swapped = 0;
    for(i=0; i<rec_num-1; i++)
    if (rec_idx[i].key > rec_idx[i+1].key) {
      temp.key = rec_idx[i].key;
      temp.pdata = rec_idx[i].pdata;
      rec_idx[i].key = rec_idx[i+1].key;
      rec_idx[i].pdata = rec_idx[i+1].pdata;
      rec_idx[i+1].key = temp.key;
      rec_idx[i+1].pdata = temp.pdata;
      swapped = 1;
    }
  } while (swapped);
}
```

---
exclude: true

# é¢˜ç›®ä¸»å¹²

å‡è®¾åœ¨ IA-32/Linux å¹³å°ä¸Šç”¨ GCC ç¼–è¯‘é©±åŠ¨ç¨‹åºå¤„ç†ï¼Œ`main.c` å’Œ `sort.c` çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ååˆ†åˆ«æ˜¯
`main.o` å’Œ `sort.o`ï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åä¸º `bubsort`ã€‚ä½¿ç”¨ `objdump â€“d sort` å¾—åˆ°åæ±‡ç¼–éƒ¨åˆ†ç»“æœå¦‚ä¸‹ï¼š

```assembly
0 8048530 <sort>:
1 8048530: push %ebp
2 8048531: mov %esp, %ebp
3 8048533: sub $0x10,%esp
4 8048536: movl $0x0, -0x8(%ebp)
5 804853d: movl $0x0, -0x4(%ebp)
6 8048544: jmp 80485dc <sort+0xac>
...
```

å·²çŸ¥ IA-32 é¡µå¤§å°ä¸º 4KBï¼Œä¸»å­˜åœ°å€ä½æ•°ä¸º 32 ä½ã€‚ å‡è®¾ä»£ç  Cache å’Œæ•°æ® Cache çš„æ•°æ®åŒºå¤§å°çš†ä¸º 8KBï¼Œé‡‡ç”¨ 2 è·¯ç»„ç›¸è”æ˜ å°„ã€LRU æ›¿æ¢ç®—æ³•å’Œç›´å†™ (Write Through) ç­–ç•¥ï¼Œä¸»å­˜å—å¤§å°ä¸º 64Bï¼Œç³»ç»Ÿä¸­æ²¡æœ‰å…¶ä»–ç”¨æˆ·è¿›ç¨‹åœ¨æ‰§è¡Œï¼Œè¯·å›ç­”ä¸‹åˆ—é—®é¢˜æˆ–å®Œæˆä¸‹åˆ—ä»»åŠ¡â€¦â€¦

---
exclude: true

# è€ƒç‚¹è§£æ

1. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (.red[ç¨‹åº â†’ æœºå™¨ä»£ç ] â†’ æ‰§è¡Œ)
2. å­˜å‚¨å™¨ä½“ç³»ç»“æ„ (ç¨‹åº â†’ æœºå™¨ä»£ç  â†’ .red[æ‰§è¡Œ])
3. å­˜å‚¨å™¨ä½“ç³»ç»“æ„ (ç¨‹åº â†’ æœºå™¨ä»£ç  â†’ .red[æ‰§è¡Œ])
4. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (.red[ç¨‹åº â†’ æœºå™¨ä»£ç ] â†’ æ‰§è¡Œ)
5. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (.red[ç¨‹åº â†’ æœºå™¨ä»£ç ] â†’ æ‰§è¡Œ)
6. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (ç¨‹åº â†’ .red[æœºå™¨ä»£ç  â†’ æ‰§è¡Œ])
7. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (.red[ç¨‹åº â†’ æœºå™¨ä»£ç ] â†’ æ‰§è¡Œ)
8. ç¨‹åºçš„æœºå™¨è¡¨ç¤º (ç¨‹åº â†’ .red[æœºå™¨ä»£ç  â†’ æ‰§è¡Œ])
9. å­˜å‚¨å™¨ä½“ç³»ç»“æ„ (ç¨‹åº â†’ æœºå™¨ä»£ç  â†’ .red[æ‰§è¡Œ])
10. PA-3 ç³»ç»Ÿè°ƒç”¨å®ç° (.red[ç¨‹åº â†’ æœºå™¨ä»£ç  â†’ æ‰§è¡Œ])

---
exclude: true

# ç†è§£äº†å—ï¼Ÿ

.red[å°±è€ƒä¸€ä¸ªçŸ¥è¯†ç‚¹]ï¼š
* ç¨‹åº â†’ æœºå™¨ä»£ç  â†’ æ‰§è¡Œ

----

.red[å°±è€ƒä½ æœ‰æ²¡æœ‰åš PA/Labs]

* (ç‹¬ç«‹) åšäº† PA/Labs â†’ è°ƒè¯•è¿‡ n å¤š C/æ±‡ç¼–ä»£ç 
    * ç†Ÿæ‚‰æŒ‡ä»¤å’Œä»£ç çš„å¯¹åº” (p1, p4, p7, p8)
    * ç†Ÿæ‚‰æŒ‡ä»¤çš„è¯­ä¹‰ (p5, p6)
    * åœ¨æŒ‡ä»¤çº§ç†Ÿæ‚‰ cache çš„è¡Œä¸º (p2, p3, p9)
    * æ“ä½œç³»ç»Ÿçš„åˆæ­¥ç†è§£ (p10)

----

åšè¿‡çš„åŒå­¦ï¼šso easyï¼Œé‡åˆ°ä¸è®°å¾—çš„æŒ‡ä»¤æŸ¥ä¸‹æ‰‹å†Œå°±è¡Œ

æ²¡åšè¿‡çš„åŒå­¦ï¼šï¼Ÿï¼Ÿï¼Ÿ

---
class: center, middle

# è®¡ç®—æœºç³»ç»ŸåŸºç¡€ï¼šå¤ä¹ 

---

# è¯¾ç¨‹ Take Away Messages

ç¨‹åºç»è¿‡ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥ï¼Œæœ€ç»ˆè¢«ç¿»è¯‘æˆæœºå™¨.red[æŒ‡ä»¤åºåˆ—]

* ç¼–è¯‘å™¨ = è¡¨è¾¾å¼æ±‚å€¼ (æ–‡æœ¬åˆ°æ–‡æœ¬)
* æ±‡ç¼–å™¨ = æŒ‰ç…§ ELF æ ¼å¼å¡«å…¥æ±‡ç¼–å¯¹åº”çš„æœºå™¨æŒ‡ä»¤
* é“¾æ¥ = é‡å®šä½ + æŒ‰ç…§ ldscript ç²˜è´´

----

è®¡ç®—æœºç³»ç»Ÿçš„åŠŸèƒ½å°±æ˜¯.red[æ‰§è¡ŒæŒ‡ä»¤]

* (è¯¦è§ä¸‹ä¸€é¡µ slide)

---

# è¯¾ç¨‹ Take Away Messages (cont'd)

è®¡ç®—æœºç³»ç»Ÿä¸­çš„æœºåˆ¶æ˜¯.red[ä»ç®€å•åˆ°å¤æ‚æ¼”åŒ–è€Œæ¥]çš„

* åº”å½“é¡ºç€è¿™ä¸ªæ€è·¯å»ç†è§£
* AbstractMachine
    * TRM (æœ€å°çš„ program runtime)
    * IOE (I/O è®¾å¤‡å¯„å­˜å™¨è®¿é—®) â†’ æ‰¹å¤„ç†ç³»ç»Ÿ
    * CTE (ä¸­æ–­ä¸Šä¸‹æ–‡ç®¡ç†) â†’ åˆ†æ—¶å¤šçº¿ç¨‹
    * VME (è™šæ‹Ÿå­˜å‚¨) â†’ åˆ†æ—¶å¤šè¿›ç¨‹
    * MPE (å¤šå¤„ç†å™¨) â†’ ç°ä»£è®¡ç®—æœºç³»ç»Ÿ

---

# è¯¾ç¨‹ Take Away Messages (cont'd)

æ‰§è¡ŒæŒ‡ä»¤å¯ä»¥ç†è§£ä¸º.red[çŠ¶æ€æœº] <math>(M_0,R_0) \to (M_1,R_1) \to \ldots </math>

* æ•°å­—ç”µè·¯æ¨¡æ‹Ÿå™¨ â†’ ç®€å•æŒ‡ä»¤è®¡ç®—æœºæ¨¡æ‹Ÿå™¨ â†’ NEMU

----

è¿™ä¸ªè§†è§’å¸®åŠ©æˆ‘ä»¬æƒ³æ¸…æ¥šå¾ˆå¤šä¹‹å‰æ¯”è¾ƒéš¾ç†è§£çš„å†…å®¹

* C çš„æŒ‡é’ˆ/ç±»å‹ç³»ç»Ÿ
* `fork` çš„è¡Œä¸º
* ä¸­æ–­æœºåˆ¶
* åˆ†æ—¶å¤šçº¿ç¨‹
* debugger/tracer/...
* â€¦â€¦

---

# è¯¾ç¨‹ Take Away Messages: æ¨è®º

.red[æ€è€ƒé—®é¢˜çš„æ–¹å¼]ï¼š

* There's no magic: ä½ çœ‹åˆ°çš„ä¸€åˆ‡éƒ½æ˜¯ä»£ç æ‰§è¡Œçš„ç»“æœ
    * ä¸è®ºæ˜¯æ™®é€šç¨‹åºè¿˜æ˜¯ç³»ç»Ÿå·¥å…· (gcc, gdb, ltrace, ...)

----

.red[ç¼–ç¨‹] (CS äººçš„å®¿å‘½)ï¼š

* æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„ï¼Œæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„
* å½“ä½ åšä¸€ä»¶äº‹æ„Ÿåˆ°å›°éš¾æ—¶ï¼Œä¸€å®šæœ‰å·¥å…·èƒ½å¸®åˆ°ä½ 
    * *The system will give you an explanation!*

---

# æ˜å¹´å†è§ï¼

.center[![](/static/wiki/os/2019/img/ostep-fun.jpg)]
</textarea>

<script src="../static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
</script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>