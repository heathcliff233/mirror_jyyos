<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
<link rel="stylesheet" href="../static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="../static/css/bootstrap-theme.min.css"/>


    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/wiki.css"/>
<link rel="stylesheet" href="../static/css/slides.css"/>


    <title>äº’æ–¥</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: True
class: center, middle

# äº’æ–¥

è’‹ç‚å²© <jyy@nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# æœ¬è®²æ¦‚è¿°

> å¼•å­ï¼šæ²¡æƒ³åˆ°ä¸€ä¸ªå…±äº«å†…å­˜å°±èƒ½æŠŠäº‹æƒ…æç ¸ï¼Œè¿™ä¹ˆè¯´æ¥ï¼Œäººç±»å°±æ ¹æœ¬æ²¡æ³•å†™å¹¶å‘ç¨‹åºäº†å•Šï¼è¿™ä¸ªæ—¶å€™.red[æŠ½è±¡]çš„ç”¨å¤„å°±æ¥äº†ï¼š
>
> * è®¡ç®—æœºç¡¬ä»¶åº”å½“ä¸ºæˆ‘ä»¬æä¾›é€‚å½“çš„.red[æœºåˆ¶]ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°.red[äººç±»å®¹æ˜“ç†è§£çš„å¹¶å‘ç¼–ç¨‹æ–¹å¼]
> * å¦‚æœæŠŠç‰©ç†ä¸–ç•Œé‡Œçš„æ¯ä¸ªäººæƒ³è±¡æˆæ˜¯çº¿ç¨‹ï¼Œç‰©ç†ä¸–ç•Œæ˜¯å…±äº«å†…å­˜ï¼Œæˆ‘ä»¬æ€ä¹ˆè§£å†³å„ç§é—®é¢˜å‘¢ï¼Ÿ

----

* äº’æ–¥ï¼šæ‰©å±•çš„é¡ºåºã€åŸå­æ€§ã€å¯è§æ€§
* å®ç°äº’æ–¥

---

class: center, middle

# äº’æ–¥ (Mutual Exclusion)

---

# ä¸ºä»€ä¹ˆéœ€è¦äº’æ–¥ï¼Ÿ

.float-right[<img src="../static/wiki/os/2019/img/giveup.jpg" width=400px/>]

æˆ‘ä»¬å¸Œæœ›ä¸ºå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼Œä½†å…è®¸ç¨‹åºåŒæ—¶è®¿é—®å…±äº«å†…å­˜æ˜¯éå¸¸éº»çƒ¦çš„

* ç¼–è¯‘å™¨ç ´åäº†.red[é¡ºåº]
* æ“ä½œç³»ç»Ÿ/ä¸­æ–­ç ´åäº†.red[åŸå­æ€§]
* å¤šå¤„ç†å™¨ç ´åäº†.red[å¯è§æ€§]

----

ä½†è¿™ä¸‰ç‚¹éƒ½æ˜¯æˆ‘ä»¬.blue[ç¼–ç¨‹æ—¶èµ–ä»¥ç”Ÿå­˜çš„åŸºæœ¬å‡è®¾]

---

# äº’æ–¥ (Mutual Exclusion)

â€œäº’ç›¸æ’æ–¥â€â€”â€”.red[é¡ºåº]ã€.red[åŸå­æ€§]ã€.red[å¯è§æ€§]çš„å›å½’

* æ‰€æœ‰`do_sth()`éƒ½è¢«æ’åºï¼Œä¸”æ‰§è¡Œä¸è¢«æ‰“æ‰°
* æ‰€æœ‰`do_sth()`ä¸­æ‰§è¡Œçš„å†…å­˜å†™ï¼Œéƒ½èƒ½è¢«åç»­`do_sth()`è¯»åˆ°

----

```c
void atomic_do_sth() {
  stop_the_world();
  do_sth();
  resume_the_world();
}
```

---

# äº’æ–¥é” (Mutex Lock)

â€œStop the worldâ€å¤ªç¬¨é‡äº†ï¼Œåªéœ€ç”¨â€œé”â€ä¿æŠ¤ä¸€æ®µä»£ç åŒºåŸŸï¼›

```c
void mutex_lock(lock_t *lk);
void mutex_unlock(lock_t *lk);
```

åŒä¸€æŠŠé”çš„lock/unlockæ»¡è¶³.red[é¡ºåº]ã€.red[åŸå­æ€§]ã€.red[å¯è§æ€§]

.center[<img src="../static/wiki/os/2019/img/mutex-lock.png" width=600px/>]

---

# äº’æ–¥é” (cont'd)

ç³»ç»Ÿä¸­å¯ä»¥æœ‰å¤šæŠŠé”ï¼Œåˆ†åˆ«ä¿æŠ¤ä¸åŒçš„å…±äº«èµ„æº

* ä¸åŒç±»å‹çš„workloadså¯ä»¥å¹¶è¡Œæ‰§è¡Œ (æ¯”å¦‚ä¸åŒäººçš„è´­ç‰©è½¦)

----

```c
void do_sum() {
  for (int i = 0; i < n; i++) {
    lock(&sum_lock);
    sum++;
    unlock(&sum_lock);
  }
}
void *malloc(size_t size) {
  void *ret;
  lock(&malloc_lock);
  ret = my_alloc(size);
  unlock(&malloc_lock);
  return ret;
}
```

---

class: center, middle

# å®ç°äº’æ–¥

---

# å¤ä¹ ï¼šxchg & è‡ªæ—‹

ç¡¬ä»¶ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå¤šå¤„ç†å™¨ï¼Œx86æä¾›äº†LOCKæŒ‡ä»¤å‰ç¼€

* ä¿è¯é¡ºåºã€åŸå­æ€§ã€å¯è§æ€§

```c
int atomic_xchg(volatile int *addr, int newval) {
  STOP_THE_WORLD(); // ç¡¬ä»¶ä¿è¯
  int tmp = *addr;
  *addr = newval;
  RESUME_THE_WORLD();
  return tmp;
}

int locked = 0;
void lock()   { while (atomic_xchg(&locked, 1)) ; }
void unlock() { atomic_xchg(&locked, 0); }

```



---

# LL & SC

å¦ä¸€ç§æœºåˆ¶ï¼šLoad Link / Store Condition (RISC-V, ARM, MIPS, Alpha, PowerPC)

* LL & SCä¹‹é—´åªèƒ½æœ‰å¯„å­˜å™¨æ“ä½œ

----

```c
int LL(int *ptr) {
  åœ¨ç¡¬ä»¶ä¸Šåšä¸€äº›æ ‡è®°;  // link
  return *ptr;      // load
}
int SC(int *ptr, int value) {
  int ret = FAIL;
  STOP_THE_WORLD();
  if (æ ‡è®°ä¹‹åæ²¡æœ‰å¤„ç†å™¨å†™è¿‡ptr) { // condition
    *ptr = value;              // store
    ret = SUCC;
  }
  RESUME_THE_WORLD();
  return ret;
}
```

---

# LL & SC (cont'd)

LL-SCï¼šâ€œè¯•è¯•çœ‹ï¼ŒæˆåŠŸæœ€å¥½ï¼Œä¸æˆåŠŸå°±é‡è¯•å§â€

.center[<img src="/static/wiki/os/2019/img/ll-sc.png" width=700px/>]

---

# æ€è€ƒé¢˜

æ€è€ƒé¢˜ï¼š.green[æ€æ ·ç”¨LL/SCå®ç°atomic xchg?]

--

count: false

----

```c
int atomic_xchg(int *ptr, int new_value) {
  int old_value;
  while (1) {
    old_value = LL(ptr);
    if (SC(ptr, new_value) == SUCC) {
      break;
    }
  }
  return old_value;
}
```

---

# ä½¿ç”¨LL & SCå®ç°è‡ªæ—‹

```c
int volatile locked = 0;

void lock() {
  while (1) {
    int value = LL(&locked);
    if (value == 0 &&             // é”æ­¤æ—¶æ²¡æœ‰å ç”¨
        SC(&locked, 1) == SUCC) { // ä¸”æ²¡æœ‰å…¶ä»–äººå¾—åˆ°é”
      break;
    }
  }
}

void unlock() {
  locked = 0;
  __sync_synchronize(); // full memory barrier
}
```



---

# ç†è§£å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œ

.float-right[<img src="../static/wiki/os/2019/img/no-key.jpg" width=200px/>] å¯¹åº”åˆ°ç‰©ç†ä¸–ç•Œâ€”â€”ä¸‹è¯¾äº‰æŠ¢å•æ‰€åŒ…é—´çš„ä¾‹å­

* æˆ‘ä»¬ = çº¿ç¨‹ (ç‰©ç†ä¸–ç•Œæ˜¯å¤©ç”Ÿå¹¶å‘çš„)
* ç‰©ç†ä¸–ç•Œ = å…±äº«å†…å­˜

----

 åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­(`locked`å˜é‡)

* æ¡Œä¸Šå®¹çº³ä¸€ä¸ªä¸œè¥¿ï¼Œåˆå§‹æ—¶æ˜¯.red[é’¥åŒ™]ğŸ”‘ (0)
* æˆ‘ä»¬æ¯æ¬¡éƒ½æ‹¿ä¸€ä¸ª.red[å­—æ¡] (1) å’Œæ¡Œä¸Šçš„ä¸œè¥¿.red[äº¤æ¢] (atomic-xchg)
* å¾—åˆ°.green[é’¥åŒ™] (0) â†’ ä½¿ç”¨åŒ…é—´ï¼›å¾—åˆ°.blue[å­—æ¡] (1) â†’ å†è¯•
* å‡ºåŒ…å¢æ—¶ï¼ŒæŠŠ.red[é’¥åŒ™] (0)å’Œæ¡Œä¸Šçš„ä¸œè¥¿.red[äº¤æ¢] (atomic-xchg)
* (æ€è€ƒé¢˜ï¼š.green[å¦‚ä½•ç†è§£LL/SCç‰ˆæœ¬çš„è‡ªæ—‹é”ï¼Ÿ])

---

# äº’æ–¥é”ï¼šå¹¶å‘æ§åˆ¶çš„æŠ½è±¡

æœ‰äº†lock/unlockï¼Œæˆ‘ä»¬å°±ä¸å¿…è€ƒè™‘ğŸ”‘äº†

* åŒä¸€æŠŠé”ä¿æŠ¤çš„ä»£ç è‡ªç„¶å…·æœ‰â€œçº¿ç¨‹å®‰å…¨â€ç‰¹æ€§

----

æ€è€ƒé¢˜ï¼š.green[å¦‚ä½•å®ç°å¹¶å‘çš„`unordered_map<int,int>`]ï¼Ÿ

```c
linked_list<pair<int,int>> hash[MOD];
spinlock_t lock;
void put(unsigned int key, int value) {
  spin_lock(&lock);
  // å¯ä»¥å®‰å…¨åœ°put
  spin_unlock(&lock);
}
void get(unsigned int key) {
  spin_lock(&lock);
  // å¯ä»¥å®‰å…¨åœ°get
  spin_unlock(&lock);
}
```



---

class: center, middle

# çœŸå®ä¸–ç•Œä¸­çš„äº’æ–¥

(è¿™å°±æå®šäº†ï¼Ÿä½ ä»¬å•Šï¼Œnaiveï¼ŒæŠŠé—®é¢˜æƒ³å¤ªç®€å•äº†)

---

# äº’æ–¥ï¼šéœ€æ±‚åˆ†æ (cont'd)

* (ç”¨æˆ·) æ“ä½œç³»ç»Ÿä¸Šçš„çº¿ç¨‹
  * `threads.h`ï¼Œçº¿ç¨‹å¥½åƒâ€œç‹¬å â€å¤„ç†å™¨è¿è¡Œ
  * åˆšæ‰çš„ä»£ç å°±èƒ½è§£å†³é—®é¢˜

------

* (å†…æ ¸) ç›´æ¥è¿è¡Œåœ¨å¤„ç†å™¨ä¸Šçš„ä»£ç   â† .red[æˆ‘ä»¬çš„å…³æ³¨ç‚¹]
  * æ“ä½œç³»ç»Ÿå†…æ ¸çš„ä»£ç ï¼Œâ€œå†…æ ¸çº¿ç¨‹â€
  * æ²¡æœ‰æ“ä½œç³»ç»ŸAPIï¼Œä½†å¯ä»¥ç®¡ç†ç¡¬ä»¶
  * éœ€è¦å“åº”ç¡¬ä»¶ä¸­æ–­ï¼Œçº¿ç¨‹åˆ†æ—¶å…±äº«å¤„ç†å™¨

---

# Case 0: é‡å…¥ (Reentrance)

ä»¥ä¸‹ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```c
void f() {         // ä¸Šé”æ¬¡æ•°
                   // 0
  lock(&lk);       // 1
  lock(&lk);       // 2
  do_something();
  unlock(&lk);     // 1
  unlock(&lk);     // 0
  unlock(&lk);     // -1 (bug)
}
```

------

å®ç°é‡å…¥ï¼š

* å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å¾—é”ï¼Œå†æ¬¡`lock()`ç›´æ¥æˆåŠŸ
* å½“`unlock`ä¸`lock`æ¬¡æ•°åŒ¹é…æ—¶é‡Šæ”¾
* æ€è€ƒé¢˜ï¼š.green[è®¡æ•°å™¨å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ]

---

# å®ç°äº’æ–¥ï¼šé—®é¢˜æ¥äº†

ç³»ç»Ÿä¸­åªæœ‰å°‘é‡çš„å¤„ç†å™¨ï¼Œä½†æœ‰å¤§é‡çš„çº¿ç¨‹ï¼Œå› æ­¤çº¿ç¨‹.red[åˆ†æ—¶å…±äº«]å¤„ç†å™¨(ä¸­æ–­é©±åŠ¨)

.center[<img src="../static/wiki/os/2019/img/spinning.png" width=700px/>]

* è‡ªæ—‹å¯¼è‡´çš„CPUæµªè´¹ï¼Œæœ‰åŠæ³•è§£å†³å—ï¼Ÿ

---

# Case 1: å•å¤„ç†å™¨

(ä¹‹åæš‚æ—¶ä¸è€ƒè™‘é‡å…¥çš„æƒ…å†µ)

åœ¨å•å¤„ç†å™¨ç³»ç»Ÿé‡Œï¼Œæ‰€æœ‰çš„è‡ªæ—‹éƒ½æ˜¯.red[æµªè´¹]çš„

* `atomic_xchg`è¿”å›1ä»£è¡¨æŸä¸ª(å…¶ä»–)çº¿ç¨‹å·²ç»æŒæœ‰é”ï¼Œä½†é‚£ä¸ªçº¿ç¨‹åœ¨`unlock`ä¹‹å‰å°±è¢«å¤„ç†å™¨æ¢å‡ºäº†

----

å…³ä¸­æ–­ = é¡ºåº + åŸå­æ€§ + å¯è§æ€§

* .red[å•å¤„ç†å™¨ã€çŸ­ä¸´ç•ŒåŒºéå¸¸å¥½ç”¨]

```c
void lock() {
  cli(); // cli()æ‰§è¡Œä¹‹åè‡ªåŠ¨è¿›å…¥ä¸´ç•ŒåŒº
}

void unlock() {
  sti();
}
```

---

# Case 2: å¤šå¤„ç†å™¨

å¤šå¤„ç†å™¨äº’æ–¥ = å•å¤„ç†å™¨äº’æ–¥(.red[å…³ä¸­æ–­]) + .red[è‡ªæ—‹]

```c
void spin_lock(spinlock_t &lk) {
  cli();
  while (atomic_xchg(&lk->locked, 1)) ;
}

void spin_unlock(spinlock_t &lk) {
  atomic_xchg(&lk->locked, 0);
  sti();
}
```

----

.red[æœ‰æ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜]ï¼Ÿ

---

# Case 2: å¤šå¤„ç†å™¨ (cont'd)

é—®é¢˜1ï¼š

.float-right[<img src="../static/wiki/os/2019/img/question.jpg" width=100px/>]

```c
cli();  // ä¾‹å¦‚ä¸­æ–­å¤„ç†ç¨‹åº
spin_lock(&lk);
spin_unlock(&lk);  // --> sti()
// æ­¤å¤„æœ‰é»‘äººé—®å·ï¼šæ€ä¹ˆä¸­æ–­å°±æ¥äº†ï¼Ÿ
```

----

é—®é¢˜2ï¼š

.float-right[<img src="../static/wiki/os/2019/img/question.jpg" width=100px/>]

```c
spin_lock(&lk1);
  spin_lock(&lk2);
  spin_unlock(&lk2);  // --> sti()
// æ­¤å¤„æœ‰é»‘äººé—®å·ï¼šæˆ‘çš„åŸå­æ€§å‘¢ï¼Ÿ
spin_unlock(&lk1);
```

---

# Case 2: å¤šå¤„ç†å™¨ (cont'd)

è‡ªæ—‹é”ï¼š

* åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œç­‰å¾…è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹.red[å¿™ç­‰å¾…]
* ç”¨äºä¿æŠ¤ä¸€æ®µ.red[å¾ˆçŸ­]çš„ä¸´ç•ŒåŒº(é€šå¸¸æ˜¯æ•°æ®ç»“æ„çš„æ›´æ–°)

----

xv6 [spinlock.c](/static/wiki/os/2019/demos/spinlock.c)é€‰è®²

* pushcli/popcliè§£å†³é—®é¢˜1
* per-CPUè®¡æ•°å™¨è§£å†³é—®é¢˜2
* è®°å½•è°ƒç”¨æ ˆã€å„ç§assertionsï¼Œå¸®åŠ©è°ƒè¯•

---



# Case 3: é•¿ä¸´ç•ŒåŒº

é•¿æ—¶é—´å…³é—­ä¸­æ–­æ˜¯éå¸¸å±é™©çš„

* å†™1GBçš„æ–‡ä»¶ï¼›å¤åˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼›â€¦â€¦

```c
void disk_read(int fd, char *buf, size_t size) {
  spin_lock(&disk_lock);
  for (size_t i = 0; i < size; i++) {
    read_from_disk(&buf[i], offset(fd) + i); // éå¸¸è€—æ—¶çš„æ“ä½œ
                                             // ç”šè‡³ç­‰å¾…I/Oä¸­æ–­
  }
  spin_unlock(&disk_lock);
}
```

----

å…³ä¸­æ–­ + è‡ªæ—‹ä¸é€‚åˆé•¿ä¸´ç•ŒåŒº

---

# Case 3: é•¿ä¸´ç•ŒåŒº (cont'd)

æˆ‘ä»¬å¸Œæœ›åœ¨lockedæƒ…å†µä¸‹ï¼š

* å…è®¸å¤„ç†å™¨å“åº”ä¸­æ–­
* å…è®¸åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œ
* å…è®¸å½“å‰çº¿ç¨‹ç¡çœ ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œ

----

å›åˆ°ä¹‹å‰çš„æ–¹æ¡ˆ(èƒ½å®ç°äº’æ–¥ï¼Œä½†æœ‰å¤§é‡ç©ºè½¬)ï¼š

```c
void do_sum() {
  while (atomic_xchg(&lk->locked, 1)) ;
  sum++;
  // æ­¤æ—¶å¯èƒ½åˆ°æ¥ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œ
  //          è°ƒç”¨mutex_lock(&lk)çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…
  sum++;
  atomic_xchg(&lk->locked, 0);
}
```

---

# Case 3: å‡å°‘ç©ºè½¬

æ¯æ¬¡å‘ç°ç©ºè½¬ï¼Œç«‹å³åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼š

```c
void mutex_lock(spinlock_t *lk) {
  while (atomic_xchg(&lk->locked, 1)) {
    // åœ¨atomic_xchgæ‰§è¡Œçš„æ—¶å€™ï¼Œå·²ç»æœ‰äººå¾—åˆ°äº†é”
    // å› ä¸ºæ˜¯é•¿ä¸´ç•ŒåŒºï¼Œæ‰€ä»¥é¢„æœŸè¦ç­‰å¾ˆä¹…
    let_other_thread_to_execute(); // ä¸å¦‚è®©å…¶ä»–çº¿ç¨‹æ‰§è¡Œ
  }
}
```

----

ä¾ç„¶æœ‰ç¼ºé™·ï¼š

* å¦‚æœçº¿ç¨‹éå¸¸éå¸¸å¤šï¼Œæˆ‘ä»¬éœ€è¦â€œç©ºè½¬ä¸€è½®â€æ‰èƒ½è®©çœŸæ­£éœ€è¦è¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œ
* èƒ½å¦å¹²è„†æš‚åœè¿™ä¸ªçº¿ç¨‹ï¼Œç­‰é’¥åŒ™å½’è¿˜ä»¥åå†å”¤é†’ï¼Ÿ

---

# Case 3: å‡å°‘ç©ºè½¬ (cont'd)

å¢åŠ ä¸€ä¸ªâ€œç®¡ç†å‘˜â€ï¼Œç®¡ç†ç­‰å¾…è¿›å…¥æ¸¸æ³³æ± çš„é˜Ÿåˆ—

* â€œæ’é˜Ÿâ€çš„çº¿ç¨‹ä¸å†è¢«è°ƒåº¦æ‰§è¡Œ

.center[<img src="../static/wiki/os/2019/img/swim-pool.png" width=700px/>]

---

# Case 3: å‡å°‘ç©ºè½¬ (cont'd)

```c
void mutex_lock(spinlock_t *lk) {
  if (lk->locked != 0) {
    enqueue(lk->wait_list);
    set_sleep_flag(); // ä½¿æ“ä½œç³»ç»Ÿä¹‹åä¸å†è°ƒåº¦å½“å‰çº¿ç¨‹
    spin_unlock(&lk->spinlock);
    yield(); // ä¸»åŠ¨åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œ
  } else {
    lk->locked = 1;
  }
}

void mutex_unlock() {
  if (!empty(lk->wait_list)) {
    resume(dequeue(lk->wait_list)); // å”¤é†’ä¹‹å‰ç¡çœ çš„çº¿ç¨‹
  } else {
    lk->locked = 0;
  }
}
```

</textarea>

<script src="../static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
</script>

    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>