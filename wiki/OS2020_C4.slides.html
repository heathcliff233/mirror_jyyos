<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>[C4] æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="c4">[C4] æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>æˆ‘ä»¬å·²ç»ä»æ¦‚å¿µä¸Šè®²è§£äº† â€œè™šæ‹ŸåŒ–â€</p>
<ul>
<li>ç¨‹åº = çŠ¶æ€æœº (çš„æè¿°)</li>
<li>è¿›ç¨‹ = çŠ¶æ€æœºçš„æ‰§è¡Œ</li>
<li>æ“ä½œç³»ç»Ÿ = çŠ¶æ€æœºçš„æ¨¡æ‹Ÿå™¨</li>
</ul>
<p>åˆ°åº•ä»€ä¹ˆæ˜¯è¿›ç¨‹ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯ â€œæ‘¸ä¸åˆ°â€ å®ƒä»¬</p>
</blockquote>
<p>æœ¬è®²å†…å®¹</p>
<ul>
<li>è¿›ç¨‹çš„è¿‘è·ç¦»æ¥è§¦<ul>
<li>trivial-os ä¸­çš„è¿›ç¨‹</li>
<li>xv6 ä¸­çš„è¿›ç¨‹</li>
<li>Linux ä¸­çš„è¿›ç¨‹</li>
</ul>
</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="trivial-os-100-oslabs">Trivial-OS: 100 è¡Œç‰ˆæœ¬çš„ OSLabs</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="trival-os">Trival OS</h2>
<blockquote>
<p>ç†è®ºå½’ç†è®ºï¼Œå®è·µå½’å®è·µã€‚</p>
<p>è®²å¤šå°‘ç†è®ºå¯¹çœŸæ­£ç†è§£æ“ä½œç³»ç»Ÿéƒ½æ˜¯æ²¡ç”¨çš„ã€‚</p>
</blockquote>
<p>å¦‚ä½•å®ç°ä¸€ä¸ªæœ€å°çš„å¤šè¿›ç¨‹ã€å¤šå¤„ç†å™¨æ“ä½œç³»ç»Ÿï¼Ÿ</p>
<ul>
<li>æ”¯æŒ â€œæœ€å°â€ çš„äºŒè¿›åˆ¶ â€œæ–‡ä»¶â€<ul>
<li>é™æ€é“¾æ¥</li>
<li>4 KiB å¤§å°</li>
<li>æ— æ ¼å¼ (ä»£ç /æ•°æ®æ··åœ¨ä¸€èµ·ï¼Œå †æ ˆåœ¨ 4 KiB è¾¹ç•Œ)</li>
</ul>
</li>
<li>ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨: <code>puts(ptr)</code><ul>
<li>å°†è¿›ç¨‹ <code>ptr</code> æŒ‡é’ˆå¤„çš„å­—ç¬¦ä¸²æ‰“å°å‡ºæ¥</li>
<li>å¤šå¤„ç†å™¨å®‰å…¨ (åŸå­)</li>
<li>ä¸æ”¯æŒè¿›ç¨‹çš„åˆ›å»º/æ›¿æ¢/é”€æ¯ç­‰ (è¿›ç¨‹å¯åŠ¨æ—¶ç¡®å®š)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lab1">Lab1: ç‰©ç†å†…å­˜ç®¡ç†</h2>
<pre class="codehilite"><code class="language-c">void *kalloc(size_t size) {
  static uintptr_t brk = 0;
  brk = brk ?
    ROUNDUP(brk, size) + size :
    (uintptr_t)_heap.start + size;
  return (void *)(brk - size);
}
void kfree(void *ptr) { }</code></pre>

<ul>
<li>(è¿™æ ·å¥½åƒè¿‡ä¸äº† easy tests...)<ul>
<li>ä½†ä½ ç”šè‡³å¯ä»¥ç”¨è¿™ä¸ªå®ç°æ“ä½œç³»ç»Ÿ</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lab2">Lab2: å†…æ ¸å¤šçº¿ç¨‹</h2>
<pre class="codehilite"><code class="language-c">typedef union task {
  struct {
    _Context *context;
    _AddressSpace vm;
    char *page, *cmd;
  };
  uint8_t stack[8192];
} Task;
Task tasks[] = { ... }, **currents;
#define current currents[_cpu()]

typedef intptr_t lock_t;
void spin_lock(lock_t *lk) { _intr_write(0); while (_atomic_xchg(lk, 1)); }
void spin_unlock(lock_t *lk) { _atomic_xchg(lk, 0); _intr_write(1); }

_Context *schedule(_Context *ctx) {
  if (!current) current = &tasks[0];
  else current-&gt;context = ctx;
  do {
    if (++current == tasks + LENGTH(tasks))
      current = &tasks[0];
  } while ((current - tasks) % _ncpu() != _cpu());
  return current-&gt;context;
}</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lab3">Lab3: æ–‡ä»¶ç³»ç»Ÿ</h2>
<pre class="codehilite"><code class="language-c">void vfs_read(const char *fname, char *buf) {
  static char bin_hello[] = {
#include "apps/hello.inc"
  };
  static char bin_counter[] = {
#include "apps/counter.inc"
  };
  if (strcmp(fname, "/bin/hello") == 0)
    memcpy(buf, bin_hello, sizeof(bin_hello));
  if (strcmp(fname, "/bin/counter") == 0)
    memcpy(buf, bin_counter, sizeof(bin_counter));
}</code></pre>


<ul>
<li>åœ¨ä»£ç ä¸­åµŒå…¥ä¸€äº› â€œæ–‡ä»¶â€<ul>
<li>å°±å’Œåˆšæ‰æˆ‘ä»¬çœ‹åˆ°çš„ Linux ç³»ç»Ÿçš„ â€œinitrdâ€ ä¸€æ ·</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="lab4">Lab4: è¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨</h2>
<pre class="codehilite"><code class="language-c">void proc_create(Task *task) {
  _Area stack = (_Area) { &task-&gt;context + 1, task + 1 };
  _AddressSpace *as = &task-&gt;vm;
  _protect(as);
  task-&gt;context = _ucontext(as, stack, as-&gt;area.start);
}

void proc_pagefault(void *ptr) {
  _AddressSpace *as = Â¤t-&gt;vm;
  void *va = (void *)ROUNDDOWN(ptr, as-&gt;pgsize);
  void *pa = kalloc(as-&gt;pgsize);
  current-&gt;page = pa;
  vfs_read(current-&gt;cmd, pa);
  _map(as, va, pa, _PROT_READ | _PROT_WRITE | _PROT_EXEC);
}

void proc_syscall(_Context *ctx) {
  static lock_t lock = 0;
  void *pa = current-&gt;page + (ctx-&gt;GPR1 & (current-&gt;vm.pgsize - 1));
  spin_lock(&lock);
  printf("[syscall@P%d on cpu-%d] puts '%s'\n", current - tasks + 1, _cpu(), pa);
  spin_unlock(&lock);
}</code></pre>


<ul>
<li>æ¯ä¸ªåº”ç”¨ç¨‹åºæ°å¥½æ˜¯ â€œä¸€ä¸ªé¡µé¢â€</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç†è®ºä¸å®è·µ</h2>
<blockquote>
<p>å®ç°æ“ä½œç³»ç»Ÿæ²¡ä»€ä¹ˆéš¾çš„ã€‚æˆ‘ä»¬ä¸è¿‡æ˜¯åœ¨ bare-metal ä¸Šç¼–ç¨‹ï¼Œä½¿ç”¨ç¡¬ä»¶æä¾›çš„æœºåˆ¶</p>
</blockquote>
<p>ä½¿ç”¨çš„ç¡¬ä»¶æœºåˆ¶</p>
<ul>
<li><del>éƒ½æ˜¯ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹å­¦è¿‡çš„ï¼Œå°±æ˜¯æ²¡å­¦æ‡‚</del></li>
<li>I/O (çœ‹èµ·æ¥å°±åƒæ˜¯æ™®é€šçš„ API è°ƒç”¨)</li>
<li>è™šæ‹Ÿå­˜å‚¨ (è¿›ç¨‹å†…å­˜çš„æ˜ å°„)</li>
<li>ä¸­æ–­ (æ‰“æ–­å½“å‰æ‰§è¡Œçš„è¿›ç¨‹)</li>
<li>ç³»ç»Ÿè°ƒç”¨/å¼‚å¸¸ (è¿›ç¨‹ä¸»åŠ¨å°†æ§åˆ¶æµäº¤ç»™æ“ä½œç³»ç»Ÿ)</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œå°±æ˜¯æ™®é€šçš„ C ç¨‹åº</p>
<ul>
<li>æ‰€ä»¥ç”¨ C++/Go/Rust å†™æ“ä½œç³»ç»Ÿéƒ½æ˜¯åˆç†çš„<ul>
<li>â†’ æˆ‘ä»¬åœ¨è€ƒè™‘ AbstractMachine çš„æ¥å£</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">é‚£ä¸ºä»€ä¹ˆå¤§å®¶æ„Ÿåˆ°è¿™é—¨è¯¾å›°éš¾ï¼Ÿ</h2>
<blockquote>
<p><img alt="" class="float-right" src="../static/wiki/os/2019/img/question.jpg" width="120px"></img>
åˆšæ‰çš„ <code>trivial-os.c</code> æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ bug</p>
<ul>
<li>è¿™ä¸ªç¨‹åºè¿è¡Œä¸€ä¸‡æ¬¡å¯èƒ½éƒ½æ˜¯å¥½çš„</li>
<li>äº¤ Online Judge å°±æŒ‚äº†</li>
</ul>
</blockquote>
<p>ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ (ä½ çœ‹ xv6 å†™å¾—æŒºå¥½ï¼Œä½ è‡ªå·±ä¸€å†™å°±æŠ“ç)</p>
<ul>
<li>å¯¹ specification ç†è§£ç‰‡é¢<ul>
<li>AbstractMachine</li>
<li>ç¡¬ä»¶æŒ‡ä»¤</li>
<li>å¤šå¤„ç†å™¨</li>
<li>ç¼–è¯‘å™¨/ç¼–è¯‘ä¼˜åŒ–</li>
<li>â€¦â€¦</li>
</ul>
</li>
<li>ç³»ç»Ÿè½¯ä»¶å„ä¸ªéƒ¨åˆ†å¤æ‚çš„äº¤äº’<ul>
<li><span class="red">â€œåƒè‹¦â€ æ˜¯è¿™é—¨è¯¾é‡è¦çš„ä½“éªŒ</span><ul>
<li>è™½ç„¶æˆ‘ä»¬ä¸€ç›´åœ¨æ•™æ€ä¹ˆç”¨å·¥å…·ï¼Œä½†ä½ ä»¬ä¸ç”¨å•Š</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="xv6">xv6: ä¸€ä¸ª (å®Œæ•´çš„) æ•™å­¦æ“ä½œç³»ç»Ÿ</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="xv6">xv6 å‡†å¤‡</h2>
<blockquote>
<p>ä¸Šé¢çš„ä¾‹å­å¤ª trivial äº†ï¼Œè™½ç„¶å¥½ç†è§£ï¼Œä½†è¿™å°±æ˜¯æ“ä½œç³»ç»Ÿï¼Ÿ</p>
<ul>
<li>ä¸å¦‚è¯•è¯• xv6 (æ›´å®Œæ•´ï¼Œè‡³å°‘æœ‰ä¸ª shell)</li>
<li>å¦‚æœæˆ‘ä»¬è¦è°ƒè¯• xv6ï¼Œå­¦ä¹ è¿›ç¨‹çš„å®ç°ï¼Œåº”è¯¥åšä»€ä¹ˆå‡†å¤‡ï¼Ÿ</li>
</ul>
</blockquote>
<div class="fragment">
<ul>
<li>ä¸è¦å¯åŠ¨å¤šä¸ªå¤„ç†å™¨ (æ’é™¤å¹²æ‰°)</li>
<li>æ‰¾åˆ°è°ƒè¯•çš„åˆ‡å…¥ç‚¹<ul>
<li>ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ï¼Ÿ</li>
<li>ä»ç³»ç»Ÿè°ƒç”¨å¼€å§‹ï¼Ÿ â† å¥½åƒä¸é”™ï¼Œå› ä¸ºè¿›ç¨‹å¤„äº â€œå·²çŸ¥â€ çš„çŠ¶æ€<ul>
<li>ç³»ç»Ÿè°ƒç”¨ä¼šåˆ‡æ¢åˆ°æ“ä½œç³»ç»Ÿä»£ç æ‰§è¡Œ</li>
<li>æ˜¯ç†è§£è¿›ç¨‹çš„å…³é”®</li>
</ul>
</li>
<li>ä»ä¸­æ–­å¼€å§‹ï¼Ÿ</li>
</ul>
</li>
<li>RTFM/RTFSC<ul>
<li>ç†è§£å¿…è¦çš„ä¸œè¥¿</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ç†è®ºå¤ä¹ ï¼šä»€ä¹ˆæ˜¯è¿›ç¨‹</h2>
<p>æ“ä½œç³»ç»Ÿæ¨¡æ‹Ÿçš„çŠ¶æ€æœº (ç¨‹åº)</p>
<p>â€œæ¨¡æ‹Ÿâ€ çŠ¶æ€æœºçš„ä¸»è¦éš¾ç‚¹</p>
<ul>
<li>æ¨¡æ‹Ÿå†…å­˜ â† è¿›ç¨‹å†…å­˜åº”è¯¥å°±åœ¨ç‰©ç†å†…å­˜é‡Œï¼Œæš‚æ—¶å¿½ç•¥</li>
<li>å¯„å­˜å™¨ç°åœº<ul>
<li>è¿›ç¨‹çš„å¯„å­˜å™¨æ€ä¹ˆå®ç°å¾ˆæœ‰å¿…è¦çŸ¥é“</li>
</ul>
</li>
<li>ç®¡ç†æ“ä½œç³»ç»Ÿèµ„æº (ä¾‹å¦‚æ‰“å¼€çš„æ–‡ä»¶) â† æˆ‘ä»¬æš‚æ—¶ä¸ç®¡</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="xv6">xv6 ä¸­è¿›ç¨‹çš„è¡¨ç¤º</h2>
<pre class="codehilite"><code class="language-c">enum procstate { UNUSED, EMBRYO, SLEEPING, RUNNABLE, RUNNING, ZOMBIE };

// Per-process state
struct proc {
  uint sz;                     // Size of process memory (bytes)
  pde_t* pgdir;                // Page table
  char *kstack;                // Bottom of kernel stack for this process
  enum procstate state;        // Process state
  int pid;                     // Process ID
  struct proc *parent;         // Parent process
  struct trapframe *tf;        // Trap frame for current syscall
  struct context *context;     // swtch() here to run process
  void *chan;                  // If non-zero, sleeping on chan
  int killed;                  // If non-zero, have been killed
  struct file *ofile[NOFILE];  // Open files
  struct inode *cwd;           // Current directory
  char name[16];               // Process name (debugging)
};</code></pre></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å…¶ä»–éœ€è¦çš„å‡†å¤‡</h2>
<blockquote>
<p>æˆ‘ä»¬éœ€è¦çŸ¥é“ç³»ç»Ÿè°ƒç”¨çš„å…¥å£</p>
</blockquote>
<ul>
<li>RTFM/RTFSC</li>
<li>xv6 ç”¨ä¸­æ–­å®ç°ç³»ç»Ÿè°ƒç”¨</li>
<li><code>int $0x40</code><ul>
<li>å…¥å£æ˜¯ <code>vector64</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>æˆ‘ä»¬éœ€è¦è§¦å‘ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</p>
</blockquote>
<ul>
<li>ä¸å¦¨è§‚å¯Ÿä¸€ä¸‹ <code>ls</code> æ˜¯æ€ä¹ˆæ‰“å°å­—ç¬¦çš„å§ ğŸ˜ƒ </li>
</ul>
<blockquote>
<p>æˆ‘ä»¬è¿˜éœ€è¦è§‚å¯Ÿè™šæ‹Ÿæœºæ‰§è¡Œçš„å·¥å…·</p>
</blockquote>
<ul>
<li>gdb (ä¹‹å‰è°ƒè¯• spinlock çš„æ—¶å€™æ¼”ç¤ºè¿‡äº†)<ul>
<li>æŸ¥çœ‹ä¿å­˜çš„å¯„å­˜å™¨ç°åœº: <code>p/x *tf</code>, <code>p *curproc</code></li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">è°ƒè¯•â€¦â€¦</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="iret">ç¦åˆ©: iret å›åˆ°ç”¨æˆ·è¿›ç¨‹</h2>
<p>å°±çœ‹ä¸åˆ°ä»£ç äº†å•Š</p>
<ul>
<li>ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹é‡Œè°ƒè¯•ç”¨æˆ·è¿›ç¨‹æ—¶é‡åˆ°çš„é—®é¢˜</li>
<li><code>file _ls</code> å¯ä»¥æ¢ä¸€ä¸ªæ–‡ä»¶/ç¬¦å·è¡¨è°ƒè¯•<ul>
<li>æˆ‘ä»¬å°±ä¸èƒ½è°ƒè¯•å¤šä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å—ï¼Ÿ<ul>
<li>å‡†åˆ™ï¼š<span class="red">å¦‚æœä½ è®¤ä¸ºè¿™ä»¶äº‹åº”è¯¥åŠåˆ°ï¼Œå°±èƒ½åŠåˆ°</span></li>
<li>so simple: <code>add-symbol-file _ls 0</code></li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="linux">æœ€å, Linux</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux">ä½ ä»¬çœ¼é‡Œçš„ Linux æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2>
<blockquote>
<p>å…¨åŠŸèƒ½ï¼Œå°±åƒæ˜¯ Windows ä¸€æ ·çš„å®Œæ•´æ“ä½œç³»ç»Ÿ</p>
</blockquote>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/deepin.jpg" width="640px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="linux">Linux å¯ä»¥æœ‰å¤šå°ï¼Ÿ</h2>
<p>â€œæ–‡ä»¶ç³»ç»Ÿâ€ é‡Œåªæœ‰ä¸¤ä¸ªæ–‡ä»¶ (<a href="../static/wiki/os/2020/demos/linux-minimal.zip">æˆ³æˆ‘ä¸‹è½½</a>)ï¼š</p>
<pre class="codehilite"><code class="language-text">initramfs
â”œâ”€â”€ busybox
â””â”€â”€ init</code></pre>

<ul>
<li><code>/busybox</code> æ˜¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶<ul>
<li>ELF 64-bit LSB executable, statically linked</li>
</ul>
</li>
<li><code>/init</code> åªæœ‰ 3 è¡Œ<ul>
<li>å®é™…åªåšä¸€ä»¶äº‹: æ‰§è¡Œ busybox<ul>
<li><code>exec /busybox sh</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr></hr>
<p>ä½ å¦‚æœå¥½å¥½å­¦è¿‡è®¡ç®—æœºç³»ç»Ÿç³»åˆ—çš„è¯¾ç¨‹</p>
<ul>
<li>(æ‡‚å¾—å¦‚ä½• RTFM/STFW)</li>
<li>Linux Kernel å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆéš¾çš„<ul>
<li>åªè¦ææ¸…æ¥šä¸€äº›åŸºæœ¬æ¦‚å¿µå’Œå·¥å…·å°±è¡Œäº†</li>
<li>ä¸ä¼šä¸‹ä¸äº†æ‰‹ (ä¸‹ä¸äº†æ‰‹æ˜¯å› ä¸ºæ²¡æœ‰å—åˆ°è¶³å¤Ÿçš„è®­ç»ƒ)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">è®©æˆ‘ä»¬è¿è¡Œä¸€ä¸‹å§ï¼</h2>
<blockquote>
<p>ç³»ç»Ÿé‡ŒçœŸçš„ â€œå‡ ä¹ä»€ä¹ˆä¹Ÿæ²¡æœ‰â€</p>
<ul>
<li>çœ‹èµ·æ¥å®Œæˆåº¦å ªæ¯”æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿå®éªŒ (è¯¯)</li>
</ul>
</blockquote>
<p>å…¨é ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ <code>/busybox</code> (ä½œä¸º <code>sh</code> åœ¨æ‰§è¡Œ)</p>
<ul>
<li>ä¹Ÿå¯ä»¥ <code>/busybox ls</code>; æˆ–è€… <code>echo $PATH</code></li>
</ul>
<p>å’Œä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ <code>/dev/console</code> (æ²¡æœ‰è¿™ä¸ªå°±æ²¡æœ‰ç»ˆç«¯äº†)</p>
<div class="fragment">
<hr></hr>
<p>è®©æˆ‘ä»¬ç»™ç³»ç»Ÿä¸°å¯Œä¸°å¯Œ</p>
<pre class="codehilite"><code class="language-bash">/busybox mkdir -p /bin && /busybox mv /busybox /bin/
c1="arch ash base64 cat chattr chgrp chmod chown conspy cp cpio cttyhack date dd df dmesg dnsdomainname dumpkmap echo ed egrep false fatattr fdflush fgrep fsync getopt grep gunzip gzip hostname hush ionice iostat ipcalc kbd_mode kill link linux32 linux64 ln login ls lsattr lzop makemime mkdir mknod mktemp more mount mountpoint mpstat mt mv netstat nice nuke pidof ping ping6 pipe_progress printenv ps pwd reformime resume rev rm rmdir rpm run-parts scriptreplay sed setarch setpriv setserial sh sleep stat stty su sync tar touch true umount uname usleep vi watch zcat"
c2="[ [[ awk basename bc beep blkdiscard bunzip2 bzcat bzip2 cal chpst chrt chvt cksum clear cmp comm crontab cryptpw cut dc deallocvt diff dirname dos2unix dpkg dpkg-deb du dumpleases eject env envdir envuidgid expand expr factor fallocate fgconsole find flock fold free ftpget ftpput fuser groups hd head hexdump hexedit hostid id install ipcrm ipcs killall last less logger logname lpq lpr lsof lspci lsscsi lsusb lzcat lzma man md5sum mesg microcom mkfifo mkpasswd nc nl nmeter nohup nproc nsenter nslookup od openvt passwd paste patch pgrep pkill pmap printf pscan"
c3="pstree pwdx readlink realpath renice reset resize rpm2cpio runsv runsvdir rx script seq setfattr setkeycodes setsid setuidgid sha1sum sha256sum sha3sum sha512sum showkey shred shuf smemcap softlimit sort split ssl_client strings sum sv svc svok tac tail taskset tcpsvd tee telnet test tftp time timeout top tr traceroute traceroute6 truncate ts tty ttysize udhcpc6 udpsvd unexpand uniq unix2dos unlink unlzma unshare unxz unzip uptime users uudecode uuencode vlock volname w wall wc wget which who whoami whois xargs xxd xz xzcat yes"
for cmd in $c1 $c2 $c3; do
  /bin/busybox ln -s /bin/busybox /bin/$cmd
done
mkdir -p /proc && mount -t proc  none /proc
mkdir -p /sys  && mount -t sysfs none /sys</code></pre>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å§æ§½è¿™ä¹Ÿå¤ªä¸°å¯Œäº†å§ï¼</h2>
<p>ç®€ç›´å°±æ˜¯ä¸ª â€œæ ‡é…â€ ç‰ˆçš„ Linux</p>
<ul>
<li>try everything: <code>ps</code>, <code>pstree</code>, <code>vi</code>, ...<ul>
<li>ä»¥åŠæˆ‘ä»¬å¯ä»¥ unmount procfs/sysfs...</li>
</ul>
</li>
<li>ä¸ï¼Œå…¶å®æ˜¯è¶…çº§ä½é…ç‰ˆçš„</li>
</ul>
<blockquote>
<p>Clarifications:</p>
<ul>
<li>Linux Kernel æ˜¯ â€œæ“ä½œç³»ç»Ÿâ€<ul>
<li>ä¸­æ–­å¤„ç†ã€ç³»ç»Ÿè°ƒç”¨å®ç°ã€ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„åŠ è½½</li>
</ul>
</li>
<li>å…¶ä»–éƒ½æ˜¯æ˜¯åº”ç”¨ç¨‹åºå’Œæ•°æ®<ul>
<li><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/busybox1.png" width="100px"></img> <a href="https://www.busybox.net/">BusyBox</a>: the Swiss Army Knife of embedded Linux</li>
<li><code>init</code>: æ–‡æœ¬æ–‡ä»¶ï¼Œä»…æ­¤è€Œå·² (Sha-Bang, <code>#!</code>)<ul>
<li>â€œä¸°å¯Œä¸€ä¸‹â€ éƒ½æ˜¯åº”ç”¨ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„</li>
<li>(å…¶å®ä¸€åˆ‡éƒ½æ˜¯åº”ç”¨ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„)</li>
<li>æ„Ÿå—åˆ°äº† â€œæ“ä½œç³»ç»Ÿæ˜¯ API (C ç¨‹åº)â€ è¿™å¥è¯çš„åˆ†é‡</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="busybox">BusyBox</h2>
<p>ä½ å¯ä»¥è¿™ä¹ˆç†è§£:</p>
<pre class="codehilite"><code class="language-c">int main(int argc, char *argv[]) {
  if (cmd_check(argv[0], "ls"    )) return ls_main    (argc, argv);
  if (cmd_check(argv[0], "find"  )) return find_main  (argc, argv);
  if (cmd_check(argv[0], "pstree")) return pstree_main(argc, argv);
  ...
  if (cmd_check(argv[0], "busybox")) {
    return main(argc - 1, argv + 1);
  }
  return EXIT_FAILURE;
}</code></pre>


<p>ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œé›†æˆäº†å¸¸ç”¨çš„å‘½ä»¤è¡Œå·¥å…·</p>
<ul>
<li>æ¯” coreutils å°å·§å¾—å¤š<ul>
<li>ä¾‹å­: Android ç³»ç»Ÿã€ä¸“ä¸ºè°ƒè¯•æ„å»ºçš„ç³»ç»Ÿã€â€¦â€¦</li>
</ul>
</li>
</ul>
<blockquote>
<p>å¦‚æœä½ å¯¹ç³»ç»Ÿä¸­ä»»ä½•ä¸€ä¸ªå·¥å…·çš„åŸç†æ„Ÿåˆ°å›°æƒ‘ï¼ŒRTFSC!</p>
<ul>
<li>ä¾‹å­ï¼šæƒ³å­¦ä¹ å¦‚ä½•å®ç° vi-clone? vim å¤ªå¤§; busybox æ­£å¥½</li>
</ul>
</blockquote></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="busybox-linux">BusyBox æ˜¯ Linux ä¸Šçš„ä¸€ä¸ªè¿›ç¨‹</h2>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ä¹‹å‰ä¸€åˆ‡ç†è§£è¿›ç¨‹çš„å·¥å…·ç†è§£å®ƒ</p>
<pre class="codehilite"><code class="language-text">$ pmap 1
1: /busybox sh
0000000000400000    2888K r-xp  /bin/busybox
00000000008d1000      40K rw-p  /bin/busybox
00000000008db000     156K rw-p  [heap]
00007fffc4b91000     132K rw-p  [stack]
00007fffc4bf2000      12K r--p  [vvar]
00007fffc4bf5000       4K r-xp  [vdso]
ffffffffff600000       4K --xp  [vsyscall]
mapped: 3236K</code></pre>


<blockquote>
<p>è¿™ä¸‹ä½ ç›¸ä¿¡äº†ï¼šLinux åŸç†ä¸ŠçœŸçš„å°±æ˜¯è¿™ä¹ˆ â€œç®€å•â€</p>
<ul>
<li>ç³»ç»Ÿé‡Œçš„ä¸€åˆ‡<ul>
<li>è¦ä¹ˆæ˜¯æ•°æ® (åŒ…æ‹¬å¯æ‰§è¡Œæ–‡ä»¶)</li>
<li>è¦ä¹ˆæ˜¯ç”±ç³»ç»Ÿè°ƒç”¨åˆ›å»ºçš„</li>
</ul>
</li>
<li>è®¡ç®—æœºç³»ç»Ÿé‡Œæ²¡æœ‰é­”æ³•<ul>
<li>ä½ è°ƒè¯• oslab/xv6 çš„æ–¹æ³•ï¼Œå°±æ˜¯å¼€å‘è€…è°ƒè¯• Linux Kernel çš„æ–¹æ³•</li>
</ul>
</li>
</ul>
</blockquote></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>ä¸‰ä¸ªæ“ä½œç³»ç»Ÿä¸Šçš„è¿›ç¨‹è®²è§£ï¼Œå¤æ‚åº¦ä¾æ¬¡é™ä½</p>
<ul>
<li>æˆ‘ä»¬é€šè¿‡ç†è§£æ›´ç®€å•çš„ç³»ç»Ÿï¼Œå»çœ‹æ›´å¤æ‚çš„ç³»ç»Ÿ<ul>
<li>trivial-os (hello-world)</li>
<li>xv6 (sh, ls)</li>
<li>Linux (busybox)</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜ï¼š</p>
<ul>
<li>å›çœ‹è§†é¢‘ï¼Œè°ƒè¯• xv6 ä»£ç </li>
<li>å¼€å§‹åš oslab å§ï¼</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>