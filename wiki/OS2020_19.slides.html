<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>å´©æºƒä¸€è‡´æ€§</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="_1">å´©æºƒä¸€è‡´æ€§</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">å®éªŒé¢„å‘Š</h2>
<blockquote>
<p>ä»Šå¤©æ˜¯ â€œthree easy piecesâ€ éƒ¨åˆ†çš„æœ€åä¸€æ¬¡è¯¾å•¦ï¼</p>
<ul>
<li>æ˜¯æ—¶å€™å¼€å§‹è¡¥ä¸Šä½ ä»¬æ¬ çš„å®éªŒäº† âš ï¸ </li>
</ul>
</blockquote>
<p>æŒä¹…åŒ–éƒ¨åˆ†çš„ labs</p>
<ul>
<li>M5 - frecov<ul>
<li>FAT æ–‡ä»¶ç³»ç»Ÿæ¢å¤</li>
</ul>
</li>
<li>M6 - kvdb<ul>
<li>crash-safe çš„æ•°æ®åº“</li>
</ul>
</li>
<li>L3 - vfs<ul>
<li>å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿå®ç°</li>
</ul>
</li>
</ul></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>RAID å¯ä»¥å®¹å¿ç£ç›˜çš„ fail-stop</p>
<ul>
<li>ä½†è¿™å¹¶ä¸æ„å‘³ç€æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿå°±å¯é äº†ï¼</li>
</ul>
</blockquote>
<p>æœ¬è®²æ¦‚è¿°</p>
<ul>
<li>å´©æºƒä¸€è‡´æ€§ï¼šæŒä¹…æ•°æ®å¯é æ€§çš„å¦ä¸€ä¸ªç»´åº¦</li>
<li>å´©æºƒæ¢å¤<ul>
<li>fsck</li>
<li>journaling</li>
</ul>
</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="_1">æŒä¹…æ•°æ®çš„å¯é æ€§ï¼šå¦ä¸€ä¸ªç»´åº¦</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="crash-consistency">å´©æºƒä¸€è‡´æ€§ (Crash Consistency)</h2>
<p>æ–­ç”µã€ç³»ç»Ÿè½¯ä»¶/ç¡¬ä»¶ bug, ...</p>
<p><img alt="" class="center" src="../static/wiki/os/2019/img/cat-crash-consistency.jpg"></img></p>
<blockquote>
<p><strong>Crash Consistency</strong>: Move the file system from one consistent state (e.g., before the file got appended to) to another atomically (e.g., after the inode, bitmap, and new data block have been written to disk).</p>
</blockquote>
<p><span class="center">(ä½ ä»¬å¹³æ—¶ç¼–ç¨‹æ—¶å‡è®¾ä¸ä¼šå‘ç”Ÿçš„äº‹ï¼Œæ“ä½œç³»ç»Ÿéƒ½è¦ç»™ä½ å…œåº•)</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å¯¼è‡´å´©æºƒä¸€è‡´æ€§é—®é¢˜çš„åŸå› </h2>
<blockquote>
<p>æ•°æ®ç»“æ„çš„ç»´æŠ¤éœ€è¦å¤šä¸ªæ•°æ®å—çš„å†™å…¥ã€‚</p>
</blockquote>
<p>å¦‚æœç³»ç»Ÿä¸å‘ç”Ÿ crash, ç£ç›˜ eventually ä¼šå¸®æˆ‘ä»¬é¡ºåºå†™å…¥</p>
<ul>
<li>RAID: write(<math class="inline-math">V_0</math>) <math class="inline-math">\to</math> write(<math class="inline-math">A_0</math>) write(<math class="inline-math">B_0</math>)</li>
<li>ext2 (æ–‡ä»¶è¿½åŠ å†™å…¥ä¸€å—): write(inode); write(bitmap); write(data);</li>
</ul>
<div class="fragment">
<blockquote>
<p>å¤šæ¬¡å†™å…¥æ²¡æœ‰åŸå­æ€§ä¿è¯ ğŸ˜‚</p>
</blockquote>
<p>ç£ç›˜ firmware: ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘æ‹¼äº†ï¼</p>
<ul>
<li>é™¤éç‰¹åˆ«è¦æ±‚ (å‘é€ flush æŒ‡ä»¤)ï¼Œå¦åˆ™é»˜è®¤ä¹±åºæ‰§è¡Œè¯·æ±‚</li>
<li>ç”šè‡³å¯èƒ½å‘ç° block data corruption<ul>
<li>å‡è®¾ checksum å¯ä»¥å‘ç°</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">åŸå­æ€§çš„ä¸§å¤±ï¼šåæœ</h2>
<p>è€ƒè™‘æ–‡ä»¶è¿½åŠ å†™çš„ä¸‰ä¸ª writes</p>
<ul>
<li>[1] æ–‡ä»¶çš„ inode (sizeã€ç´¢å¼•) [2] data bitmap [3] data block<ul>
<li><math>\{1\}</math> - corrupted filesystem</li>
<li><math>\{2\}</math> - dead block</li>
<li><math>\{3\}</math> - random writes</li>
<li><math>\{1,2\}</math> - incorrect data</li>
<li><math>\{1,3\}</math> - corrupted filesystem</li>
<li><math>\{2,3\}</math> - dead block</li>
</ul>
</li>
</ul>
<p>æ›´å¤æ‚çš„æƒ…å†µä½ è¿˜æ•¢æƒ³å—ï¼Ÿ</p>
<ul>
<li>å¤§æ–‡ä»¶å¤šçº§ç´¢å¼•çš„æ›´æ–°</li>
<li>link/unlink</li>
<li>è·¨æ•°æ®å—çš„ç›®å½•æ–‡ä»¶æ›´æ–° (rename)</li>
<li>â€¦â€¦</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="fsck">å´©æºƒæ¢å¤: FSCK</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="file-system-checking-fsck">File System Checking (FSCK)</h2>
<blockquote>
<p>FSCK: æ ¹æ®ç£ç›˜ä¸Šå·²æœ‰çš„ä¿¡æ¯ï¼Œæ¢å¤å‡º â€œæœ€å¯èƒ½â€ çš„æ•°æ®ç»“æ„</p>
</blockquote>
<p>æ¢å¤è§„åˆ™ï¼šä¾‹å­</p>
<ul>
<li>æ£€æŸ¥ inode æ ‡è®°çš„æ•°æ®å—æ˜¯å¦ bitmap éƒ½æ ‡è®°ä¸º â€œ1â€</li>
<li>æ£€æŸ¥ inode æ•°æ®æ˜¯å¦ â€œçœ‹èµ·æ¥åˆæ³•â€ï¼Œå¦åˆ™åˆ é™¤</li>
<li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨ dangling link<ul>
<li>æ²¡æœ‰é“¾æ¥çš„ inode è¢«ç§»åˆ° lost+found ç›®å½•ä¸­)</li>
</ul>
</li>
<li>â€¦â€¦</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="file-system-checking-fsck">File System Checking (FSCK)</h2>
<p>FSCK çš„æŒ‘æˆ˜</p>
<ul>
<li>åœ¨å‘ç”Ÿä¸ä¸€è‡´çš„æ—¶å€™å¾ˆéš¾å†³å®š â€œåˆ°åº•ä»€ä¹ˆæ˜¯å¯¹çš„â€</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/fsck-recovery.png" width="700px"></img></p>
<ul>
<li>H. S. Gunawi, et al. SQCK: A declarative file system checker. In <em>Proc. of OSDI</em>, 2008.</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="fsck">å¦‚æœ fsck çš„æ—¶å€™å‘ç”Ÿå´©æºƒ ğŸ˜‚</h2>
<p>fsck ä¹Ÿæ˜¯ç¨‹åºï¼Œfsck ä¹Ÿè¦è®¿é—®æ–‡ä»¶ç³»ç»Ÿ</p>
<ul>
<li>å¦‚æœ fsck æ—¶å‘ç”Ÿå´©æºƒï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<ul>
<li>O. R. Gatla, et al. Towards robust file system checkers. In <em>Proc. of FAST</em>, 2018.</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ–‡ä»¶ç³»ç»Ÿå¯èƒ½è¿›å…¥å½»åº•æ— æ³•æ¢å¤çš„çŠ¶æ€ï¼</p>
</blockquote>
<p>æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ›´ â€œconstructiveâ€ çš„åŠæ³•å®ç°å´©æºƒä¸€è‡´æ€§</p>
<ul>
<li>å‡è®¾æ•°æ®æ²¡æœ‰å‘ç”ŸæŸåï¼Œåªæ˜¯ multi-write åŸå­æ€§è¢«ç ´å</li>
<li>(æ•°æ®æŸåæ—¶ä¾ç„¶éœ€è¦ FSCK)</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="journaling">å´©æºƒæ¢å¤: Journaling</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="journaling">æ—¥å¿— (Journaling)</h2>
<blockquote>
<p>å‡è®¾ç£ç›˜æä¾› write (å†™å…¥æ•°æ®å—) å’Œ sync (ç­‰å¾…æ•°æ®è½ç›˜)</p>
<ul>
<li>æˆ‘ä»¬èƒ½å¦å®ç°ä¸€ç§ crash-safe çš„æ•°æ®ç»“æ„ï¼Ÿ</li>
</ul>
</blockquote>
<div class="fragment">
<p>ç®€åŒ–çš„é—®é¢˜: append-only çš„ block vector</p>
<ul>
<li>atomic-append(blocks); éšæœºè¯»å– read(blk)</li>
</ul>
<p>å®ç°æ–¹æ³•</p>
<ul>
<li>ä¿è¯ä¹‹å‰çš„æ•°æ®è½ç›˜åæ‰å†™ä¸‹ä¸€ä»½æ•°æ®</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/journaling.png" width="800px"></img></p>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="copy-on-write">æ’æ›²: å®ç° Copy-on-Write çš„æ•°æ®ç»“æ„</h2>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ block vector å®ç°æ ‘ç»“æ„ï¼</p>
<ul>
<li>ä¿®æ”¹ä¸€ä¸ªèŠ‚ç‚¹ï¼šæŠŠæ ‘ä»æ ¹åˆ°æ”¹èŠ‚ç‚¹çš„è·¯å¾„å¤åˆ¶ä¸€ä»½ <math class="inline-math">O(\log n)</math></li>
</ul>
<p>BTRFS: everything is a B-tree</p>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/btrfs-cow.png" width="700px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="multi-write">å®ç° Multi-Write çš„åŸå­æ€§</h2>
<p>æ•°æ®ç»“æ„æœ‰ä¸¤ç§å®ç°æ–¹æ³•</p>
<ol>
<li>å­˜å‚¨å®é™…<span class="red">æ•°æ®ç»“æ„</span><ul>
<li>æ–‡ä»¶ç³»ç»Ÿçš„ â€œç›´è§‚â€ è¡¨ç¤º</li>
<li>crash unsafe</li>
</ul>
</li>
<li>append-only è®°å½•æ‰€æœ‰<span class="red">å†å²æ“ä½œ</span><ul>
<li>éœ€è¦ replay æ‰€æœ‰æ“ä½œæ‰èƒ½å¾—åˆ°æ•°æ®ç»“æ„çš„å½“å‰çŠ¶æ€</li>
<li>crash safe (ç”¨ journal å®ç°)</li>
</ul>
</li>
</ol>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥åŒæ—¶ç»´æŠ¤è¿™ä¸¤ç§æ•°æ®ç»“æ„ï¼ŒåŒæ—¶å¾—åˆ°å®ƒä»¬çš„å¥½å¤„ï¼</p>
</blockquote>
<div class="fragment">
<p>Journaled file system</p>
<ol>
<li>ç”¨ atomic-append å°†æ“ä½œå†™å…¥ journalï¼Œå¹¶ç­‰å¾…è½ç›˜</li>
<li>æ›´æ–°ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„<ul>
<li>å¦‚æœä¸å´©æºƒï¼Œå§‹ç»ˆé€šè¿‡ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„è®¿é—®</li>
</ul>
</li>
<li>crash ä»¥åæ ¹æ® journal é‡æ„æ•°æ®ç»“æ„</li>
</ol>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="multi-write-contd">å®ç° Multi-Write çš„åŸå­æ€§ (cont'd)</h2>
<p>æ•°æ®ç»“æ„ v.s. å†å²æ“ä½œ</p>
<ul>
<li>ä¹Ÿç§°ä¸º â€œredo loggingâ€, â€œwrite-ahead loggingâ€</li>
<li>å¦ä¸€ç§ undo logging: è®°å½•å¦‚ä½• â€œæŠµæ¶ˆâ€ æ“ä½œ (å³å—ä¸­çš„æ•°å€¼)</li>
</ul>
<hr></hr>
<p>åœ¨ç£ç›˜ä¸Šå­˜å‚¨æ•°æ®ç»“æ„</p>
<ul>
<li>ä¸€æ—¦ä¸€æ®µå†å²å·²ç»ä½“ç°åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œè¿™æ®µå†å²å°±ä¸å†éœ€è¦äº†<ul>
<li>å› æ­¤ä¸€èˆ¬åªéœ€è¦å¼€è¾Ÿè¾ƒå°çš„åŒºåŸŸç”¨äº journaling </li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="xv6-journaling">xv6 Journaling</h2>
<p>buffer cache (bio.c)</p>
<ul>
<li><code>bget</code>, <code>brelease</code>, <code>bread</code>, <code>bwrite</code></li>
</ul>
<p>journaling (log.c)</p>
<ul>
<li><code>begin_op</code>, <code>end_op</code> (ä¸»è¦çš„è°ƒç”¨åœ¨ sysfile.c)<ul>
<li>è¿™ä¸¤ä¸ª API ä½¿ç¼–ç¨‹å˜å¾—å®¹æ˜“å¾—å¤šäº† (ä¾‹å¦‚ <code>sys_link</code>)</li>
</ul>
</li>
<li><code>commit</code><ul>
<li><code>write_log</code></li>
<li><code>write_head</code></li>
<li>å°† head çš„ <code>log.lh.n</code> æ¸…é›¶ï¼Œå†å†™å…¥ (TxEnd)</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="journaling">Journaling: ä¼˜åŒ–</h2>
<p>æ‰¹å¤„ç† (xv6; jbd)</p>
<ul>
<li>å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨çš„ Tx åˆå¹¶æˆä¸€ä¸ªï¼Œå‡å°‘ log çš„å¤§å°</li>
<li>jbd: å®šæœŸ write back</li>
</ul>
<div class="fragment">
<hr></hr>
<p>Checksum (ext4)</p>
<ul>
<li>ä¸å†æ ‡è®° TxBegin/TxEnd</li>
<li>ç›´æ¥æ ‡è®° Tx çš„é•¿åº¦å’Œ checksum</li>
</ul>
</div>
<div class="fragment">
<hr></hr>
<p>Metadata journaling (ext4 default)</p>
<ul>
<li>æ•°æ®å ç£ç›˜å†™å…¥çš„ç»å¤§éƒ¨åˆ†<ul>
<li>åªå¯¹ inode å’Œ bitmap åš journaling å¯ä»¥æé«˜æ€§èƒ½</li>
</ul>
</li>
<li>ä¿è¯æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„æ˜¯ä¸€è‡´çš„ï¼›ä½†æ•°æ®å¯èƒ½ä¸¢å¤±</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="metadata-journaling">Metadata Journaling</h2>
<blockquote>
<p>è¿™æ˜¯ä¸€ä¸ª trade-offã€‚</p>
<ul>
<li>æå‡äº†æ€§èƒ½</li>
<li>ç‰ºç‰²äº†æ–‡ä»¶ç³»ç»Ÿçš„ä¸€è‡´æ€§</li>
</ul>
</blockquote>
<p>ä»åº”ç”¨è§†è§’æ¥çœ‹ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è¡Œä¸ºå¯èƒ½å¾ˆæ€ªå¼‚</p>
<ul>
<li>å„ç±»ç³»ç»Ÿè½¯ä»¶ (git, sqlite, gdbm, ...) ä¸å¹¸ä¸­æ‹›<ul>
<li>T. S. Pillai. All file systems are not created equal: On the complexity of crafting crash-consistent applications. In <em>Proc. of OSDI</em>, 2014.</li>
<li>(os-workbench é‡Œçš„å°ç§˜å¯†)</li>
</ul>
</li>
</ul>
<hr></hr>
<p><a href="https://zhuanlan.zhihu.com/p/25188921">æ›´å¤šçš„åº”ç”¨ç¨‹åºå¯èƒ½å‘ç”Ÿ data loss</a></p>
<ul>
<li>æˆ‘ä»¬çš„å·¥ä½œ: GNU coreutils, gmake, gzip, ... ä¹Ÿæœ‰é—®é¢˜<ul>
<li>Y. Jiang, et al. Crash consistency validation made easy. In <em>Proc. of FSE</em>, 2016.</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="multi-write">ä¸ºåº”ç”¨ç¨‹åºæä¾› Multi-Write çš„ä¸€è‡´æ€§ï¼Ÿ</h2>
<p>TxOS: æä¾›ä¸‰ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨</p>
<ul>
<li>xbegin, xend, xabort</li>
<li>å®ç°å¤šä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸå­æ€§<ul>
<li>åº”ç”¨åœºæ™¯ï¼šæ•°æ®æ›´æ–°ã€è½¯ä»¶æ›´æ–°ã€check-useâ€¦â€¦</li>
</ul>
</li>
</ul>
<hr></hr>
<p>é˜…è¯»ææ–™</p>
<ul>
<li>D. E. Porter, et al. Operating system transactions. In <em>Proc. of SOSP</em>, 2009. </li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>å´©æºƒä¸€è‡´æ€§ï¼šä¿æŒæ•°æ®åœ¨æŒä¹…å­˜å‚¨ä¸Šçš„åŸå­æ€§</p>
<ul>
<li>fsck: æ‰«æç£ç›˜ã€é‡å»ºæ•°æ®ç»“æ„</li>
<li>journaling: ä½¿ç”¨ write-ahead logging</li>
<li>æ“ä½œç³»ç»Ÿä¸­éå¸¸å…·æœ‰æŒ‘æˆ˜æ€§çš„éš¾é¢˜<ul>
<li>FSCQ (OSDI'2016): æˆ‘è¯æ˜äº†æ–‡ä»¶ç³»ç»Ÿçš„ crash consistencyï¼</li>
<li>Hydra (SOSP'2019): æˆ‘æŠŠä½ è¯æ˜è¿‡çš„ç³»ç»Ÿæµ‹å‡º bug äº† ğŸ˜‚</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¤ä¹ é¢˜</p>
<ul>
<li>é˜…è¯» xv6 æ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†çš„ä»£ç </li>
<li>é˜…è¯»æ•™ç§‘ä¹¦å’Œè®²ä¹‰ä¸­çš„é˜…è¯»ææ–™</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>