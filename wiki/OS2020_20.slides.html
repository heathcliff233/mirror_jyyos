<html>
  <Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    
    

    <link rel="stylesheet" href="../static/css/fonts/crmison.css"/>
    <link rel="stylesheet" href="../static/css/fonts/fira_code.css"/>
    <link rel="stylesheet" href="../static/css/fonts/ptsans.css"/>
    <link rel="stylesheet" href="../static/css/katex.min.css"/>
    <link rel="stylesheet" href="../static/css/wiki.css"/>
    <link rel="stylesheet" href="../static/css/codehilite.css"/>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/katex.min.js"></script>
    
<link rel="stylesheet" href="../static/css/reveal.css"/>
<link rel="stylesheet" href="../static/css/reveal-slides.css"/>


    <title>Operating Systems: Three Easy Pieces</title>
  </Head>
  <body>
   
   

<div class="reveal">
  <div class="slides">
    <section>
<div class="slide-container"><div class="center middle"><h1 id="operating-systems-three-easy-pieces">Operating Systems: Three Easy Pieces</h1>
<div plugin="include(page='Slides_Author')"><div class="hidden-in-outline author-block author-affiliation">
<p><a href="http://ics.nju.edu.cn/~jyy">è’‹ç‚å²©</a></p>
</div>
<div class="row hidden-in-outline author-block justify-content-md-center">
<p><div class="author-affiliation">    <a href="http://www.nju.edu.cn/"><p>å—äº¬å¤§å­¦</p>    <img alt="" class="inline-img" height="64px" src="../static/wiki/common/slides-author/nju-logo.png"></img></a>
  </div>
  <div class="author-affiliation">
   <a href="http://cs.nju.edu.cn/"><p>è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/njucs.jpg"></img></a>
  </div>
  <div class="author-affiliation">
    <a href="http://moon.nju.edu.cn/"><p>è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</p>
    <img alt="" class="inline-img" height="64px" src="../static/img/ics-nju.png"></img></a>
  </div></p>
</div></div></div></div>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="_1">æœ¬è®²æ¦‚è¿°</h2>
<blockquote>
<p>è€ƒè¯•æ¶‰åŠçš„å†…å®¹åˆ°ä¸Šæ¬¡è¯¾ä¸ºæ­¢ç»“æŸ</p>
<ul>
<li>æˆ‘ä»¬åˆ°åº•å­¦äº†ä»€ä¹ˆï¼Ÿ</li>
</ul>
</blockquote>
<p>æœ¬è®²æ¦‚è¿°</p>
<ul>
<li>Operating systems: three easy pieces</li>
<li>ç†è§£ Android ç³»ç»Ÿ</li>
</ul></div></div>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="virtualization">Virtualization</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ“ä½œç³»ç»Ÿï¼šè®¾è®¡</h2>
<blockquote>
<p>(åº”ç”¨è§†è§’) æ“ä½œç³»ç»Ÿï¼šä¸ºåº”ç”¨ç¨‹åºæä¾›æ‰§è¡Œç¯å¢ƒçš„ç³»ç»Ÿè½¯ä»¶ã€‚</p>
<ul>
<li>å…³äº â€œç¨‹åºâ€ï¼Œä½ ä»¬æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿ</li>
</ul>
</blockquote>
<div class="fragment">
<p>ä¸€äº›è”æƒ³</p>
<ul>
<li>ç¨‹åºæ˜¯ç”±æœºå™¨æŒ‡ä»¤æè¿°çš„çŠ¶æ€æœº<ul>
<li>ç»å¤§éƒ¨åˆ†æŒ‡ä»¤è¡Œä¸ºæ˜¯ç¡®å®š (deterministic) çš„ (call, push, ...)</li>
<li>rdrand, syscall <span class="green">[minilabs]</span></li>
</ul>
</li>
<li>ç¨‹åºæ˜¯ ELF Binary<ul>
<li>æè¿°äº†ä»£ç ã€æ•°æ®ã€ç¬¦å·â€¦â€¦</li>
<li>ç”±æ“ä½œç³»ç»ŸåŠ è½½ (execve <span class="green">[M3 - sperf]</span>, dlopen <span class="green">[M4 - crepl]</span>) æ‰§è¡Œ<ul>
<li>é™æ€é“¾æ¥ï¼šç›´æ¥ä» entry å¼€å§‹æ‰§è¡Œ</li>
<li>åŠ¨æ€é“¾æ¥è°ƒç”¨ interpreter</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ“ä½œç³»ç»Ÿï¼šå®ç°</h2>
<blockquote>
<p>(ç¡¬ä»¶è§†è§’) æ“ä½œç³»ç»Ÿï¼šä¸€ä¸ªç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ (bare-metal) ä¸Šçš„ç¨‹åºã€‚</p>
<ul>
<li>å…³äº â€œbare-metal ä¸Šçš„ç¨‹åºâ€ ä½ ä»¬æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿ</li>
</ul>
</blockquote>
<div class="fragment">
<p>ä¸€äº›è”æƒ³</p>
<ul>
<li>NEMU å®éªŒ<ul>
<li>fetch-decode-execute çš„å¾ªç¯</li>
</ul>
</li>
<li>Boot sequence <span class="green">[L0 - amgame]</span><ul>
<li>Firmware â†’ bootloader â†’ ...</li>
</ul>
</li>
<li>AbstractMachine åšå‡ºçš„æŠ½è±¡<ul>
<li>I/O (é€šè¿‡æŒ‡ä»¤è®¿é—®è®¾å¤‡å¯„å­˜å™¨)</li>
<li>ä¸­æ–­ (å¼‚æ­¥æ‰§è¡Œæµ)</li>
<li>è™šæ‹Ÿå­˜å‚¨ (åœ°å€ç¿»è¯‘å‡½æ•° <math class="inline-math">f</math>)</li>
</ul>
</li>
<li><span class="red">è™šæ‹ŸåŒ–</span>: Bridging the gap (<a href="../static/wiki/os/2020/demos/trivial-os.c">trivial-os.c</a>)</li>
</ul>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="concurrency">Concurrency</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">â€œå¤šçº¿ç¨‹â€ çŠ¶æ€æœº</h2>
<p>å‡è®¾åº“å‡½æ•°/æ“ä½œç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº† create/join (<a href="../static/wiki/os/2020/demos/threads.h">threads.h</a>)</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">create</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fn</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">join</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)());</span>
</pre></div>

<p>çŠ¶æ€æœºæ¨¡å‹ (åº”ç”¨/ç¡¬ä»¶) ä¹Ÿç›¸åº”æ”¹å˜</p>
<ul>
<li>åœ¨ <span class="green">[M2 - libco]</span> ä¸­ä½¿ç”¨ setjmp/longjmp å®ç°äº† â€œä¸»åŠ¨åˆ‡æ¢â€ çš„çº¿ç¨‹</li>
<li>åœ¨ <span class="green">[L2 - kmt]</span> ä¸­å®ç°äº†ä¸­æ–­é©±åŠ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„çº¿ç¨‹</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/concurrent-state.png" width="900px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">å¹¶å‘å¸¦æ¥çš„æŒ‘æˆ˜</h2>
<blockquote>
<p>åŸå­æ€§ã€é¡ºåºã€å¯è§æ€§çš„ä¸§å¤±ã€‚</p>
</blockquote>
<p>å¹¶å‘çš„æ¥æº</p>
<ul>
<li>ä¸­æ–­é©±åŠ¨çš„å¼‚æ­¥æ‰§è¡Œ/ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>å¤šå¤„ç†å™¨ç¡¬ä»¶ (å¹¶è¡Œ)</li>
</ul>
<hr></hr>
<p><span class="red">æŒæ§å¹¶å‘</span></p>
<ul>
<li>äº’æ–¥ (è‡ªæ—‹é”ã€äº’æ–¥é”) <span class="green">[L1 - pmm; M6 - libkvdb]</span></li>
<li>åŒæ­¥ (æ¡ä»¶å˜é‡ã€ä¿¡å·é‡) <span class="green">[L2 - kmt; midterm]</span></li>
<li>å¹¶å‘ bugs (ä½ ä»¬ä¸€ç›´åœ¨å’Œå®ƒä»¬æˆ˜æ–—)<ul>
<li>å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ <span class="green">[L3 - vfs]</span></li>
<li>sanitizers/canaries; trace/log <span class="green">[all labs]</span></li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="persistence">Persistence</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">æ–‡ä»¶ç³»ç»Ÿï¼šè®¾è®¡</h2>
<p><span class="red">æŒä¹…åŒ–</span>ï¼šå­˜å‚¨è®¾å¤‡çš„è™šæ‹ŸåŒ–</p>
<ul>
<li>everything is a file <span class="green">[minilabs; L3 - vfs]</span><ul>
<li>æ–‡ä»¶ç³»ç»Ÿ â€œé¡ºä¾¿â€ æä¾›äº†è®¿é—®æ“ä½œç³»ç»Ÿå¯¹è±¡çš„ API</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/dir-tree.png" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="1-bit">æ–‡ä»¶ç³»ç»Ÿï¼šå®ç° (ä» 1-Bit åˆ°å´©æºƒä¸€è‡´æ€§)</h2>
<p><img alt="" class="center" src="img/linux-storage-4.10.png.html" width="510px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸¤é—¨ç³»ç»Ÿæ–¹å‘è¯¾ç¨‹çš„å°ç»“</h2>
<p>èŠ±äº†æ•´æ•´ä¸¤ä¸ªå­¦æœŸï¼Œæˆ‘ä»¬åˆ°åº•å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç¨‹åº (çŠ¶æ€æœº) çš„ç²¾ç¡®è¡Œä¸º<ul>
<li>åœ¨ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹ä¸­ï¼Œç†è§£äº† â€œæŒ‡ä»¤æ‰§è¡Œâ€ <span class="green">[NEMU PAs]</span></li>
<li>åœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹ä¸­ï¼Œç†è§£äº† â€œç³»ç»Ÿè°ƒç”¨â€ <span class="green">[minilabs]</span></li>
</ul>
</li>
<li>ä¹ŸçŸ¥é“äº†å¦‚ä½•ç”¨ç¡¬ä»¶ (æŒ‡ä»¤) å®ç°æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨<ul>
<li>ä»£ç è¯¾ (xv6) å’Œè®©ä½ ä»¬ç—›ä¸æ¬²ç”Ÿçš„å®éªŒ <span class="green">[oslabs]</span></li>
</ul>
</li>
</ul>
<div class="fragment">
<blockquote>
<p>ä½ ç†è§£äº†å¦‚ä½•åœ¨ â€œä¸Šå¸è§†è§’â€ è§‚å¯Ÿ â€œç”¨æˆ·â€ å’Œ â€œç¡¬ä»¶â€ çœ¼ä¸­çš„åº”ç”¨ç¨‹åº</p>
<ul>
<li>è§£é‡Š â€œHello Worldâ€ ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹</li>
<li>ç†è§£ä»»ä½•ä¸€ä¸ªæœªçŸ¥ç³»ç»Ÿè°ƒç”¨çš„åŠ¨æœºå’Œå®ç°æ–¹æ³•</li>
<li>ç”¨ç³»ç»ŸåŒ–çš„æ–¹æ³•å»è§£é‡Šç¨‹åºçš„ â€œè¯¡å¼‚â€ è¡Œä¸º</li>
<li>â€¦â€¦</li>
</ul>
</blockquote>
</div></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="android">ä¸€ä¸ªçœŸå®çš„ä¾‹å­: <a href="https://developer.android.google.cn/">Android</a></h1>
<p><br></br>
<p>(çœ‹çœ‹æˆ‘ä»¬å­¦å®Œè¿™é—¨è¯¾ï¼Œå¯¹ â€œæ“ä½œç³»ç»Ÿâ€ çš„ç†è§£ä¼šæœ‰ä»€ä¹ˆå˜åŒ–)</p></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android">Android ç³»ç»Ÿï¼šè¯ç”Ÿ</h2>
<p>2008: æ»¡è¡—éƒ½è¿˜æ˜¯ Nokiaï¼Œæˆ‘ä»¬åˆšåˆšå‘Šåˆ«çŸ­ä¿¡ï¼Œå¼€å§‹ç”¨ 2G ç½‘ç»œä¸Šæ‰‹æœº QQ</p>
<ul>
<li>HTC Dream (G1)<ul>
<li>3.17" 480 x 320; 528 MHz single-core CPU (MSM7201A, ARM11)</li>
<li>Google é¢„è§äº†ä½åŠŸè€—å¤„ç†å™¨çš„æ€§èƒ½è¦æš´æ¶¨ (Moore å®šå¾‹)</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/Google-G1.jpg" width="400px"></img></p>
<p><span class="center">(å’ŒåŒæ—¶ä»£çš„ iPhone 3G å¼€å¯äº†ç§»åŠ¨äº’è”ç½‘çš„æ—¶ä»£)</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android">ä» â€œæ“ä½œç³»ç»Ÿâ€ çš„è§’åº¦ç†è§£ Android</h2>
<blockquote>
<p>æ“ä½œç³»ç»Ÿ (Android) çš„åŠŸèƒ½æ˜¯ç®¡ç†ç¡¬ä»¶ (æ‰‹æœº/å¹³æ¿/...)ï¼Œä¸ºåº”ç”¨ç¨‹åº (Android App) æä¾›æœåŠ¡ã€‚</p>
</blockquote>
<p>ç§»åŠ¨äº’è”ç½‘æ—¶ä»£çš„ä¸»è§’ï¼šâ€œAppsâ€</p>
<ul>
<li><p>Android ç³»ç»Ÿä¸Šçš„åº”ç”¨ç¨‹åº</p>
<ul>
<li>å¼€å‘é—¨æ§›ä½ (Java/Kotlin)<ul>
<li>å¯¹æ¯”æ­»æ‰çš„ Symbian: è¦ä¹ˆæ˜¯ C++ è¦ä¹ˆæ˜¯é˜‰å‰²çš„ Java</li>
</ul>
</li>
<li>ä»£ç ç¼–è¯‘æˆ Dalvik bytecodeã€app æ‰“åŒ…æˆ â€œapkâ€ (zip archive)<ul>
<li><a href="https://ibotpeaches.github.io/Apktool/">apktool</a> å¯ä»¥å®ç° â€œè§£åŒ…â€</li>
</ul>
</li>
</ul>
</li>
<li><p>è¿è¡Œåœ¨ â€œAndroid Runtimeâ€ (ART)</p>
<ul>
<li>managed runtime</li>
<li>ä¸°å¯Œçš„ç³»ç»ŸæœåŠ¡ã€è¿è¡Œåº“ (æ¡†æ¶ã€æ¸¸æˆå¼•æ“â€¦â€¦)</li>
</ul>
</li>
</ul>
<hr></hr>
<p>App å³æµé‡ï¼Œæµé‡å³é‡‘é’±</p>
<ul>
<li><del>è¿™æ‰æ˜¯æœ€é‡è¦çš„</del></li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android-apps">Android Apps</h2>
<p>æ¯ä¸ª App éƒ½æ˜¯ä¸€ä¸ª Linux è¿›ç¨‹</p>
<ul>
<li>ä½ å¯ä»¥æƒ³è±¡æˆæ˜¯æ¯ä¸ª App éƒ½æ˜¯ä¸€ä¸ª NEMU<ul>
<li>æ‰§è¡Œ <a href="https://source.android.google.cn/devices/tech/dalvik/dalvik-bytecode">Dalvik bytecode</a> (ç±»ä¼¼ JVM)</li>
</ul>
</li>
</ul>
<div class="fragment">
<hr></hr>
<p>App å¯åŠ¨ï¼šâ€œZygote processâ€</p>
<ul>
<li>å¹¶ä¸æ˜¯åœ¨ shell ä¸­ fork-execve</li>
<li>è€Œæ˜¯é¢„å…ˆå‡†å¤‡å¥½çŠ¶æ€çš„ â€œå¿«ç…§â€<ul>
<li>çŠ¶æ€åˆå§‹åŒ–å¥½çš„è™šæ‹Ÿæœº<ul>
<li>å¥½åƒæ˜¯åœ¨ NEMU ä¸­å…ˆå®Œæˆä»™å‰‘å¥‡ä¾ ä¼ çš„è½½å…¥</li>
</ul>
</li>
<li>a <code>fork()</code> in the road! (<code>forkAndSpecializeCommon</code> in <code>Zygote.cpp</code>)<ul>
<li><code>DetachDescriptors(env, fdsToClose)</code></li>
<li><code>gOpenFdTable-&gt;ReopenOrDetach()</code></li>
<li>(æŒ‚è½½è™šæ‹Ÿå­˜å‚¨ã€æ³¨é”€ä¿¡å·ã€â€¦â€¦)</li>
<li><code>env-&gt;CallStaticVoidMethod(.., gCallPostForkChildHooks, ..);</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android-apps-api">Android Apps ä½¿ç”¨çš„ API</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/android-arch.png" width="400px"></img></p>
<p>Linux ç³»ç»Ÿè°ƒç”¨</p>
<ul>
<li>åº“å‡½æ•°åŒ…è£¹äº†ç³»ç»Ÿè°ƒç”¨</li>
<li>App ä¸­çš„æœ¬åœ° (native) ä»£ç <ul>
<li>Android NDK; JNI</li>
</ul>
</li>
</ul>
<hr></hr>
<p>Android Framework APIs</p>
<ul>
<li>â€œhigh-levelâ€ ç³»ç»Ÿè°ƒç”¨<ul>
<li>åŸºäº Binder IPC å®ç°<ul>
<li>é€šè¯/çŸ­ä¿¡/è”ç³»äºº</li>
<li>è®¾å¤‡ç®¡ç†</li>
<li>ç•Œé¢ (Activity) ç®¡ç†</li>
</ul>
</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="binder">Binder: å®ç°</h2>
<p>Binder è®¾å¤‡ (<code>/dev/binder</code>)</p>
<ul>
<li><p>æ”¯æŒä¸€ä¸ªæ“ä½œ: <code>ioctl(fd, BINDER_WRITE_READ, buf);</code> </p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">binder_write_read</span> <span class="p">{</span>
  <span class="kt">ssize_t</span>      <span class="n">write_size</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">write_buffer</span><span class="p">;</span>
  <span class="kt">ssize_t</span>      <span class="n">read_size</span><span class="p">;</span>
  <span class="kt">void</span>       <span class="o">*</span> <span class="n">read_buffer</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

</li>
<li><p>ç±»ä¼¼å¯¹å¦ä¸€ä¸ªè¿›ç¨‹çš„ function call (remote procedure call, RPC)</p>
<ul>
<li>copy-once (é€šè¿‡æµªè´¹ä¸€äº›å†…å­˜å¯ä»¥åšåˆ° zero-copy; ä½†é£é™©å¤§äºæ”¶ç›Š)</li>
<li>Linux Kernel: <a href="https://www.kernel.org/doc/html/v5.5-rc2/admin-guide/binderfs.html">binderfs</a></li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="hal">ç³»ç»ŸæœåŠ¡å’Œ HAL: æµ·é‡çš„ä»£ç </h2>
<p>æ­¤å¤„çœç•¥åƒä¸‡è¡Œçº§çš„ä»£ç </p>
<ul>
<li>graphics, camera, ... ç­‰éƒ½æ˜¯éå¸¸ heavy çš„ subsystem</li>
<li>å…¼é¡¾ API çš„æ˜“ç”¨ã€æ€§èƒ½ã€å®‰å…¨æ€§â€¦â€¦</li>
</ul>
<hr></hr>
<p>åœ¨ç³»ç»ŸæœåŠ¡ä¹‹ä¸‹å°±æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„ Linux ç³»ç»Ÿè°ƒç”¨äº†</p>
<ul>
<li>å›åˆ°å¤§å®¶ç†Ÿæ‚‰çš„é¢†åŸŸäº†</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="1-widget">ä¾‹å­ (1)ï¼šæ§ä»¶ (Widget) ç»˜åˆ¶</h2>
<blockquote>
<p>å›é¡¾: GPU æ˜¯ä¸€ç§æ¥å—æ•°æ®/ä»£ç ï¼Œå¯ä»¥æ‰§è¡Œ â€œè®¡ç®—â€ å‘½ä»¤çš„ I/O è®¾å¤‡ã€‚</p>
</blockquote>
<p>App éœ€è¦å‡†å¤‡çš„æ˜¯å„ç§ â€œç»˜åˆ¶å‘½ä»¤â€ <span class="green">[L0 - amgame]</span></p>
<ul>
<li>éå¸¸å¤æ‚ï¼šå›¾å½¢ã€Unicode å­—ç¬¦ã€OpenGL å‘½ä»¤â€¦â€¦<ul>
<li>ä¾‹å­ï¼šç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰å­—ä½“</li>
</ul>
</li>
</ul>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/android-draw.png" width="450px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="2">ä¾‹å­ (2): æŒä¹…æ•°æ®ç®¡ç†</h2>
<p>ä½¿ç”¨é«˜çº§è¯­è¨€ (Kotlin) ç¼–å†™</p>
<ul>
<li>(è¿˜è®°å¾— Symbian æ˜¯æ€ä¹ˆæ­»çš„å—ï¼Ÿ)</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">@Entity</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span>
  <span class="n">@PrimaryKey</span> <span class="k">val</span> <span class="py">uid</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
  <span class="n">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"first_name"</span><span class="p">)</span> <span class="k">val</span> <span class="py">firstName</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
  <span class="n">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"last_name"</span><span class="p">)</span> <span class="k">val</span> <span class="py">lastName</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
<span class="p">)</span>

<span class="n">@Dao</span>
<span class="k">interface</span> <span class="nc">UserDao</span> <span class="p">{</span>
  <span class="n">@Query</span><span class="p">(</span><span class="s">"SELECT * FROM user"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">getAll</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>

  <span class="n">@Query</span><span class="p">(</span><span class="s">"SELECT * FROM user WHERE first_name LIKE :first AND "</span> <span class="p">+</span>
         <span class="s">"last_name LIKE :last LIMIT 1"</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">findByName</span><span class="p">(</span><span class="n">first</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">last</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span>

  <span class="p">...</span>
</pre></div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android-room-apis">Android Room APIs: å®ç°</h2>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/android-room.png" width="800px"></img></p>
<p><span class="center">(éƒ½åœ¨è¿›ç¨‹çš„åœ°å€ç©ºé—´é‡Œ)</span></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="sqlite"><a href="https://sqlite.org/"><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/sqlite.gif"></img></a> SQLite</h2>
<p>SQLite: A small, fast, self-contained, high-reliability, full-featured, SQL database engine</p>
<ul>
<li>â€œmost widely deployed and used database engineâ€ (Android, iOS, macOS, Windows 10, Chrome, Firefox, Safari, ...)</li>
<li>1 trillion (<math class="inline-math">10^{12}</math>) SQLite databases in active use<ul>
<li>â€œåµŒå…¥å¼â€ æ•°æ®åº“ <span class="green">[M6 - libkvdb]</span></li>
<li>(å¯ä»¥ä»¥ä¸€ä¸ª <code>.c</code> æ–‡ä»¶çš„å½¢å¼åµŒå…¥ä½ çš„ä»£ç )</li>
</ul>
</li>
</ul>
<div class="fragment">
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'a.db'</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'CREATE TABLE kvdb (key TEXT PRIMARY KEY, value CLOB)'</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'INSERT INTO kvdb VALUES ("hello", "world")'</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="android-apps">å°ç»“: Android å’Œ Apps</h2>
<p>ä½ çœ‹åˆ°çš„ App ä¸è¿‡æ˜¯ Linux ä¸Šçš„ä¸€ä¸ªè¿›ç¨‹</p>
<ul>
<li>å¤§éƒ¨åˆ†æ—¶å€™åœ¨æ‰§è¡Œ Dalvik bytecode (æ¥è‡ª Java/Kotlin)<ul>
<li>ahead-of-time ç¼–è¯‘æˆ ARM (AArch64) æŒ‡ä»¤åºåˆ—</li>
</ul>
</li>
<li>å¯ä»¥æ‰§è¡Œåº“å‡½æ•°/ç³»ç»Ÿè°ƒç”¨<ul>
<li>binder (<code>ioctl</code>)</li>
<li>sqlite (<code>pread</code>, <code>pwrite</code>, <code>fdatasync</code>, ...)</li>
</ul>
</li>
</ul>
<blockquote>
<p>å­¦å®Œæ“ä½œç³»ç»Ÿä¹‹åï¼Œä½ å¯¹ â€œç¨‹åºâ€ çš„è§†è§’å’Œç†è§£æ›´æœ¬è´¨äº†ã€‚</p>
</blockquote></div></div>
</section>
</section>

<section>
<section>
<div class="slide-container"><div class="center middle"><h1 id="app">â€œApp å¯åŠ¨â€ çš„ä¸€äº›è¶£äº‹</h1></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä½ ä»¬æ‰‹æœºçš„èƒŒåâ€¦â€¦</h2>
<blockquote>
<p>æå½¦å®ï¼šâ€œä¸­å›½äººå¯¹éšç§é—®é¢˜çš„æ€åº¦æ›´å¼€æ”¾ï¼Œä¹Ÿç›¸å¯¹æ¥è¯´æ²¡é‚£ä¹ˆæ•æ„Ÿã€‚å¦‚æœä»–ä»¬å¯ä»¥ç”¨éšç§æ¢å–ä¾¿åˆ©ã€å®‰å…¨æˆ–è€…æ•ˆç‡ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä»–ä»¬å°±æ„¿æ„è¿™ä¹ˆåšã€‚â€<span class="float-right">(<del>æˆ‘ä¸æ„¿æ„ï¼Œæˆ‘æ˜¯è¢«è¿«çš„</del>)</span></p>
</blockquote>
<p><img alt="" class="center" src="../static/wiki/os/2020/slides/img/android-wakeups.png" width="500px"></img></p></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="diehard-apps">ä¸ºä»€ä¹ˆä¼šæœ‰è¿™äº› â€œDiehard Appsâ€?</h2>
<p>åº”ç”¨</p>
<ul>
<li>ä¸ºäº†æˆ‘çš„ ï¿¥ï¿¥ï¿¥ï¼Œæˆ‘å¸Œæœ›æ´»ç€<ul>
<li>æ¨é€å¹¿å‘Šã€é‡‡é›†éšç§ã€â€¦â€¦</li>
<li>è®©å…¨å®¶æ¡¶/å‹å•†äº’ç›¸å”¤é†’ï¼šåªè¦æœ‰ä¸€ä¸ªæ´»ç€ï¼Œå…¨å®¶éƒ½æ´»ç€ï¼</li>
</ul>
</li>
</ul>
<p>ç³»ç»Ÿ</p>
<ul>
<li>ä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œä½ ä»¬ä¸èƒ½å¤ªè¿‡åˆ†<ul>
<li>< 5.0: native ä»£ç  fork å‡ºçš„è¿›ç¨‹æ— æ³•æ€æ­» ğŸ˜‚</li>
<li>5.0: ç³»ç»Ÿæ€è¿›ç¨‹ä»¥ uid ä¸ºæ ‡è¯†ï¼Œä¸€ä¸ª App ä¸€ä¸ª uidï¼Œä¸€èµ·å…¨æ€æ­»</li>
<li>8.0: per-app åå°æ‰§è¡Œé™åˆ¶</li>
</ul>
</li>
</ul>
<blockquote>
<p>åšå¼ˆçš„ç»“æœï¼šApp å‚å•†å’Œ ROM å‚å•†ä¹‹é—´çš„å¤§æˆ˜ (<del>ï£¿ ä¿å¹³å®‰</del>)</p>
</blockquote>
<ul>
<li>Y. Shao, et al. A lightweight framework for fine-grained lifecycle control of Android applications. In <em>Proc. of EuroSys</em>, 2019.</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="app">ä¹Ÿæœ‰æ€ä¸æ‰çš„ App</h2>
<p><img alt="" class="float-right" src="../static/wiki/os/2020/slides/img/qq-force-stop.jpeg" width="300px"></img>
åœ¨ Linux é‡Œï¼Œå¤§ä¸äº† <code>kill -9</code>, è¿›ç¨‹ä¹Ÿæ­»äº†</p>
<ul>
<li>ä¸€é”®æ¸…ç†ã€å¼ºåŠ›æ¸…ç†ç­‰å„å¤§æ‹›éƒ½æ— æ³•å½»åº•æ€æ‰ TIMï¼Œç³»ç»Ÿçš„è‡ªå¯åŠ¨æ‹¦æˆªéƒ½æ²¡èƒ½é˜»æ­¢ TIM çš„æ°¸ç”Ÿ (<a href="http://gityuan.com/2018/02/24/process-keep-forever/">â€”â€”gityuan's blog</a>)</li>
<li>ä¸€èˆ¬ â€œå¼ºè¡Œåœæ­¢â€ ä»¥åæŒ‰é’®å°±ç°äº†<ul>
<li>å¾—é å…¨å®¶æ¡¶ (æˆ–è€…å‹å•†) å”¤é†’</li>
<li>ä½† TIM æ ¹æœ¬æ— æ³•å¼ºè¡Œåœæ­¢ ğŸ˜‚</li>
</ul>
</li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="app">App å¼ºè¡Œä¿æ´»ï¼šåŸç†</h2>
<blockquote>
<p>Android App å¯ä»¥æœ‰ä¸æ­¢ä¸€ä¸ªè¿›ç¨‹ (ç”šè‡³æœ‰ detach çš„å­¤å„¿è¿›ç¨‹)</p>
</blockquote>
<p>ActivityManagerService â€œå¼ºè¡Œç»ˆæ­¢â€ åº”ç”¨</p>
<ul>
<li>éå†è¿›ç¨‹åˆ—è¡¨ï¼Œæ‰¾åˆ° App uid åŒ¹é…çš„è¿›ç¨‹ <span class="green">[M1 - pstree]</span></li>
<li>ä½¿ç”¨ SIGKILL å¼ºè¡Œæ€æ­» (<code>Process.killProcessQuiet</code>)<ul>
<li>æ­¤æ—¶æœ‰å¯èƒ½æœ‰æ–°åˆ›å»ºçš„è¿›ç¨‹</li>
<li>ç­‰ 5msï¼Œé‡å¤æ­¤è¿‡ç¨‹ 40 æ¬¡</li>
</ul>
</li>
</ul>
<hr></hr>
<p>å¦‚æœåœ¨è¿™ 40 x 5ms é‡Œæ¯æ¬¡éƒ½èƒ½å†æ¬¡æ‹‰èµ·è¿›ç¨‹å°±èƒ½å…æ­» ğŸ˜‚ğŸ˜‚ğŸ˜‚</p>
<ul>
<li>â€œTOCTTOUâ€ <span class="green">[C3 - â€œå¹¶å‘ bugsâ€]</span></li>
</ul></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="app">App å¼ºè¡Œä¿æ´»ï¼šå®ç°</h2>
<p>App æ­£å¸¸è¿è¡Œçš„æ—¶å€™ï¼Œåˆ†é…å‡ ä¸ªå¼Ÿå…„ (è¿›ç¨‹)</p>
<ul>
<li>äº’ç›¸æ£€æµ‹å¯¹æ–¹è¢«æ€æ­»</li>
<li>å¦‚æœæ€æ­»ï¼Œç¬¬ä¸€æ—¶é—´å‘ç³»ç»Ÿæ‹‰èµ·ä¸€ä¸ªæ–°çš„ Service<ul>
<li>ç”Ÿæ­»æ—¶é€Ÿï¼šå› ä¸ºå®ƒé©¬ä¸Šä¹Ÿè¦è¢«æ€æ‰äº† ğŸ˜‚</li>
</ul>
</li>
</ul>
<div class="fragment">
<hr></hr>
<p>æ€æ ·é«˜æ•ˆåœ°æ£€æµ‹åˆ°å…„å¼Ÿè¢«æ€æ‰äº†ï¼Ÿ</p>
<ul>
<li>ä¸¤ä¸ªè¿›ç¨‹<ul>
<li>A - æŒæœ‰é” (flock) ä¸é‡Šæ”¾ <span class="green">[M6 - libkvdb]</span></li>
<li>B - acquire (flock) é˜»å¡<ul>
<li>A è¢« kill â†’ é”é‡Šæ”¾ â†’ B å”¤é†’ (æ˜¯æ—¶å€™å¤§å¹²ä¸€åœºäº†)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ€æ ·æ‹‰èµ·ä¸€ä¸ª Service/Activity?</p>
<ul>
<li>å‘ ActivityManagerService å‘é€æ¶ˆæ¯ (IPC)<ul>
<li>é€šè¿‡ binder (å¯¹ <code>/dev/binder</code> çš„ ioctl)</li>
</ul>
</li>
</ul>
</div></div></div>
</section>
<section>
<div class="slide-container"><div class=""><h2 id="_1">ä¸ºä»€ä¹ˆè®²è¿™ä¸ªä¾‹å­ï¼Ÿ</h2>
<blockquote>
<p>ä½ åœ¨ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ç¨‹é‡Œå­¦ä¹ äº†è¶³å¤Ÿçš„çŸ¥è¯†åˆ†æè¿™ä¸ªæ¡ˆä¾‹ï¼</p>
</blockquote>
<p><a href="http://gityuan.com/2018/02/24/process-keep-forever/">gityuan's blog</a> ä¸­çš„åˆ†æ</p>
<ul>
<li>ä½¿ç”¨äº†å„ç§ log/trace åˆ†æ </li>
<li>Android æä¾› traceview, systrace<ul>
<li>æœ‰æ—¶ strace å¯èƒ½æ›´æœ‰æ•ˆ</li>
</ul>
</li>
</ul></div></div>
</section>
</section>

<section>
<div class="slide-container"><div class=""><h2 id="takeaways-and-wrap-up">Takeaways and Wrap-up</h2>
<p>æˆ‘ä»¬åˆ°åº•å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>æ“ä½œç³»ç»Ÿçš„ä¸‰ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†<ul>
<li>virtualization, concurrency å’Œ persistence</li>
</ul>
</li>
<li>å¯¹æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿ (è½¯ä»¶/ç¡¬ä»¶) è¿è¡Œé€šé€çš„ç†è§£<ul>
<li>ä»Šå¤©çš„ä¾‹å­: Android<ul>
<li>éšå¤„å¯è§ labs çš„å½±å­ <span class="green">[oslabs; minilabs]</span></li>
<li>ä½ ä»¬å†™è¿‡çš„ä»£ç è®©ä½ ä»¬çœŸæ­£ç†è§£äº† â€œä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿâ€</li>
</ul>
</li>
<li>ä½ ä»¬å·²ç» (å‡ ä¹) æœ‰äº†è¶³å¤Ÿçš„çŸ¥è¯†å‚¨å¤‡ï¼Œè¿›å…¥ä¸¥è‚ƒçš„ research work äº†</li>
</ul>
</li>
</ul>
<hr></hr>
<ul>
<li><del>åæ‚”æ²¡æœ‰å¥½å¥½å¬è¯¾/åšå®éªŒäº†å§</del><ul>
<li><del>è¿˜æ¥å¾—åŠ</del></li>
</ul>
</li>
</ul></div></div>
</section>
  </div>
</div>

<script src="../static/js/reveal.js"></script>
<script>
  slide_num = -1;
  function update_slide_num(n) {
    if (slide_num == -1) {
      setTimeout(function() {
        if (slide_num != -1) {
          while (!Reveal.isFirstSlide()) {
            Reveal.prev();
          }
          while (Reveal.getSlidePastCount() + 1 < slide_num && !Reveal.isLastSlide()) {
            Reveal.next();
          }
          slide_num = -1;
        }
      }, 500);
      slide_num = 0;
    }
    slide_num = slide_num * 10 + n;
  }

  Reveal.initialize({
    width: 1024,
    height: 768,
    margin: 0,
    slideNumber: 'c/t',
    controls: true,
    progress: false,
    maxScale: 10,
    fragments: true,
    hash: true,
    transition: 'slide',
    transitionSpeed: 'fast',
    backgroundTransition: 'slide',
    hideCursorTime: 1000,
    navigationMode: 'default',
    keyboard: {
      13: 'next',
      48: function() { update_slide_num(0) },
      49: function() { update_slide_num(1) },
      50: function() { update_slide_num(2) },
      51: function() { update_slide_num(3) },
      52: function() { update_slide_num(4) },
      53: function() { update_slide_num(5) },
      54: function() { update_slide_num(6) },
      55: function() { update_slide_num(7) },
      56: function() { update_slide_num(8) },
      57: function() { update_slide_num(9) },
    }
  });
</script>



    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          displayMode: $(this).attr('class') == 'block-math',
          throwOnError: false
        });
        $(this).replaceWith(html);
      });

      function get_token() {
        var match = document.cookie.match(new RegExp('(^| )token=([^;]+)'));
        if (match) return match[2];
        else return "";
      }

      var token = get_token();
      var hint = "token", box = $("#token-input");

      if (token == "") { box.val(hint); }
      else { box.val(token); }

      function login() {
        var token = box.val()
        document.cookie = 'token=' + token + '; expires=Fri, 31 Dec 9999 23:59:59 GMT;';
        if (token == '') {
          box.val(hint);
        }
      }
    </script>
  </body>
</html>